---
title: Functions
slug: Mozilla/Projects/SpiderMonkey/Internals/Functions
translation_of: Mozilla/Projects/SpiderMonkey/Internals/Functions
---
<div><section class="Quick_links" id="Quick_Links">
 <ol>
  <li><a href="/zh-CN/docs/Mozilla/Projects/SpiderMonkey"><strong><em>SpiderMonkey</em></strong></a></li>

  <li><strong>References:</strong></li>
  <li class="toggle">
    <details>
        <summary>JSAPI reference</summary>
        <ol><li><a href="/zh-CN/docs/Mozilla/Projects/SpiderMonkey/JSAPI_reference/BOOLEAN_TO_JSVAL"><code>BOOLEAN_TO_JSVAL</code></a> <a style="opacity: 0.5;" href="/zh-CN/docs/Mozilla/Projects/SpiderMonkey/JSAPI_reference/BOOLEAN_TO_JSVAL$translate">[我来译!]</a></li><li><a href="/zh-CN/docs/Mozilla/Projects/SpiderMonkey/JSAPI_reference/JS_DefineConstDoubles"><code>JS DefineConstDoubles</code></a> <a style="opacity: 0.5;" href="/zh-CN/docs/Mozilla/Projects/SpiderMonkey/JSAPI_reference/JS_DefineConstDoubles$translate">[我来译!]</a></li><li><a href="/zh-CN/docs/Mozilla/Projects/SpiderMonkey/JSAPI_reference/JS::OrdinaryToPrimitive"><code>JS::OrdinaryToPrimitive</code></a> <a style="opacity: 0.5;" href="/zh-CN/docs/Mozilla/Projects/SpiderMonkey/JSAPI_reference/JS::OrdinaryToPrimitive$translate">[我来译!]</a></li><li><a href="/zh-CN/docs/Mozilla/Projects/SpiderMonkey/JSAPI_reference/JSClass"><code>JSClass</code></a> <a style="opacity: 0.5;" href="/zh-CN/docs/Mozilla/Projects/SpiderMonkey/JSAPI_reference/JSClass$translate">[我来译!]</a></li><li><a href="/zh-CN/docs/Mozilla/Projects/SpiderMonkey/JSAPI_reference/JSConstDoubleSpec"><code>JSConstDoubleSpec</code></a> <a style="opacity: 0.5;" href="/zh-CN/docs/Mozilla/Projects/SpiderMonkey/JSAPI_reference/JSConstDoubleSpec$translate">[我来译!]</a></li><li><a href="/zh-CN/docs/Mozilla/Projects/SpiderMonkey/JSAPI_reference/JSErrorReport"><code>JSErrorReport</code></a> <a style="opacity: 0.5;" href="/zh-CN/docs/Mozilla/Projects/SpiderMonkey/JSAPI_reference/JSErrorReport$translate">[我来译!]</a></li><li><a href="/zh-CN/docs/Mozilla/Projects/SpiderMonkey/JSAPI_reference/JSPropertyDescriptor"><code>JSPropertyDescriptor</code></a> <a style="opacity: 0.5;" href="/zh-CN/docs/Mozilla/Projects/SpiderMonkey/JSAPI_reference/JSPropertyDescriptor$translate">[我来译!]</a></li><li><a href="/zh-CN/docs/Mozilla/Projects/SpiderMonkey/JSAPI_reference/JS_NewRuntime"><code>JS_NewRuntime</code></a> <a style="opacity: 0.5;" href="/zh-CN/docs/Mozilla/Projects/SpiderMonkey/JSAPI_reference/JS_NewRuntime$translate">[我来译!]</a></li><li><a href="/zh-CN/docs/Mozilla/Projects/SpiderMonkey/JSAPI_reference/JS_EvaluateScript"><code>SpiderMonkey/JSAPI_参考/JS_EvaluateScript</code></a> <a style="opacity: 0.5;" href="/zh-CN/docs/Mozilla/Projects/SpiderMonkey/JSAPI_reference/JS_EvaluateScript$translate">[我来译!]</a></li><li><a href="/zh-CN/docs/Mozilla/Projects/SpiderMonkey/JSAPI_reference/JS_GetVersion"><code>SpiderMonkey/JSAPI_参考/JS_GetVersion</code></a> <a style="opacity: 0.5;" href="/zh-CN/docs/Mozilla/Projects/SpiderMonkey/JSAPI_reference/JS_GetVersion$translate">[我来译!]</a></li><li><a href="/zh-CN/docs/Mozilla/Projects/SpiderMonkey/JSAPI_reference/JS_SetErrorReporter"><code>SpiderMonkey/JSAPI_参考/JS_SetErrorReporter</code></a> <a style="opacity: 0.5;" href="/zh-CN/docs/Mozilla/Projects/SpiderMonkey/JSAPI_reference/JS_SetErrorReporter$translate">[我来译!]</a></li><li><a href="/zh-CN/docs/Mozilla/Projects/SpiderMonkey/JSAPI_reference/JS_ValueToString"><code>SpiderMonkey/JSAPI_参考/JS_ValueToString</code></a> <a style="opacity: 0.5;" href="/zh-CN/docs/Mozilla/Projects/SpiderMonkey/JSAPI_reference/JS_ValueToString$translate">[我来译!]</a></li></ol>
    </details>
  </li>
  <li class="toggle">
    <details>
      <summary>Debugger-API</summary>

    </details>
  </li>
  <li><strong>Guides:</strong></li>
  <li class="toggle">
    <details>
      <summary>General</summary>
      <ol>
        <li><a href="/zh-CN/docs/Mozilla/Projects/SpiderMonkey/Build_Documentation">Build documentation</a></li>
        <li><a href="/zh-CN/docs/Mozilla/Projects/SpiderMonkey/Introduction_to_the_JavaScript_shell">Introduction to the JavaScript shell</a></li>
        <li><a href="/zh-CN/docs/Mozilla/Projects/SpiderMonkey/JSAPI_User_Guide">JSAPI user guide</a></li>
        <li><a href="/zh-CN/docs/Mozilla/Projects/SpiderMonkey/JSAPI_Cookbook">JSAPI cookbook</a></li>
        <li><a href="/zh-CN/docs/Mozilla/Projects/SpiderMonkey/How_to_embed_the_JavaScript_engine">How to embed the JavaScript engine</a></li>
        <li><a href="/zh-CN/docs/Mozilla/Projects/SpiderMonkey/GC_Rooting_Guide">GC Rooting Guide</a></li>
      </ol>
    </details>
  </li>
  <li class="toggle">
    <details open>
      <summary>SpiderMonkey internals</summary>
      <ol><li><a href="/zh-CN/docs/Mozilla/Projects/SpiderMonkey/Internals/Functions">Functions</a></li><li><a href="/zh-CN/docs/SpiderMonkey_Garbage_Collection_Tips">SpiderMonkey Garbage Collection Tips</a></li></ol>
    </details>
  </li>

  <li><strong>Contributing to SpiderMonkey:</strong></li>
  <li class="toggle">
    <details>
      <summary>Getting started</summary>
      <ol>
        <li><a href="https://wiki.mozilla.org/JavaScript:New_to_SpiderMonkey">New to SpiderMonkey</a></li>
        <li><a href="/zh-CN/docs/Mozilla/Projects/SpiderMonkey/Setting_up_CDT_to_work_on_SpiderMonkey">Setting up CDT to work on SpiderMonkey</a></li>
        <li><a href="/zh-CN/docs/Mozilla/Projects/SpiderMonkey/Hacking_Tips">Hacking tips</a></li>
      </ol>
    </details>
  </li>
  <li class="toggle">
    <details>
      <summary>Tests</summary>
      <ol>
        <li><a href="/zh-CN/docs/Mozilla/Projects/SpiderMonkey/Running_Automated_JavaScript_Tests">Running Automated JavaScript Tests</a></li>
        <li><a href="/zh-CN/docs/Mozilla/Projects/SpiderMonkey/Creating_JavaScript_tests">Creating JavaScript tests</a></li>
        <li><a href="/zh-CN/docs/Mozilla/Projects/SpiderMonkey/Running_Parsemark">Running Parsemark</a></li>
       </ol>
    </details>
  </li>

  <li><strong>Releases:</strong></li>
  <li class="toggle">
    <details>
      <summary>Release notes</summary>

    </details>
  </li>
  <li><strong><a href="/zh-CN/docs/MDN">Documentation:</a></strong></li>
  <li class="toggle">
    <details>
      <summary>Useful lists</summary>
      <ol>
        <li><a href="/zh-CN/docs/Mozilla/Projects/SpiderMonkey/Index">All pages index</a></li>
        <li><a href="/zh-CN/docs/tag/SpiderMonkey">Pages tagged &quot;SpiderMonkey&quot;</a></li>
      </ol>
    </details>
  </li>
  <li class="toggle">
    <details>
      <summary>Contribute</summary>
      <ol>
        <li><a href="/zh-CN/docs/MDN/Doc_status/SpiderMonkey">SpiderMonkey doc status</a></li>
        <li><a href="/zh-CN/docs/MDN">The MDN project</a></li>
      </ol>
    </details>
  </li>
 </ol>
</section></div>

<p>There are several flavors of JavaScript function. All are <code>JSObject</code>s of the same class, <code>js_FunctionClass</code>.</p>

<p>这里有些Javscript函数，它们属于JSObjects</p>

<p>(But note that objects of other classes can be callable and can even have <code>typeof obj == &quot;function&quot;</code>.)</p>

<p>（也存在其他可被Call的对象）</p>

<h2 id="Script_functions">Script functions</h2>

<p>Functions written in JavaScript and compiled to bytecode. There are four variations that affect how NameExpressions are evaluated. (NameExpressions are basic expressions like <code>String</code> and <code>x</code> that would eat up a huge amount of run time if the engine weren&apos;t smart enough to avoid symbol table lookups.)</p>

<p><strong>General closures</strong> are the base case. When the function object is created, its parent is set to the first object on the scope chain. When a name is evaluated that doesn&apos;t refer to a local variable, the interpreter consults the scope chain to find the variable. When <code>with</code> or <code>eval</code> are used, we have to do this for correctness.</p>

<p>This is slow, not only because walking the scope chain is a drag, but also because we&apos;d rather avoid actually creating the scope chain at all, if possible. General closures force the interpreter to verify the whole scope chain. So we optimize this when we can.</p>

<p>These optimizations depend on being <em>sure</em> that we will never have to walk the scope chain, so <code>with</code> and <code>eval</code> inhibit them all.</p>

<p><strong>Null closures.</strong> If we can prove at compile time that a function does not refer to any locals or arguments of enclosing functions, it is a null closure. Since it will never need to walk the scope chain, its parent is the global object. This is the best case. Barring <code>with</code> and <code>eval</code>, all outermost functions are null closures.</p>

<p><strong>Null closures with upvars.</strong> A nested function is <em>algol-like</em> if it is only ever defined and called, and it isn&apos;t accessed in any other way (and it is not a generator-function). Such a function is guaranteed never to be called again after the enclosing function exits. An algol-like function may read the local variables and arguments of its immediate enclosing function from the stack, as if by magic. (<code>JSContext::display</code> caches the enclosing function&apos;s stack frame.) If that function is also algol-like, its child can read locals and variables from the next enclosing function, and so on. The compiler detects these cases and makes such functions null closures too.</p>

<p><strong>Flat closures.</strong> Suppose a function reads some variables from enclosing functions but is not algol-like. If the function does not assign to any closed-on vars/args, and it only reads closed-on local variables and arguments that never change value after the function is created, then the function can be implemented as a flat closure. When a flat closure is created, all the closed-on values are copied from the stack into reserved slots of the function object. To evaluate a name, instead of walking the scope chain, we just take the value from the reserved slot. The function object&apos;s parent is the global object.</p>

<p><strong>Flat closures </strong><strong>and Null closures have been <span id="summary_alias_container"><span id="short_desc_nonedit_display">removed</span></span></strong>:</p>

<p><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=730497">https://bugzilla.mozilla.org/show_bug.cgi?id=730497</a></p>

<p><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=739808">https://bugzilla.mozilla.org/show_bug.cgi?id=739808</a></p>

<h2 id="Name_lookups">Name lookups</h2>

<p>In order of speed, fastest to slowest.</p>

<ol>
 <li>
  <p><code><strong>ARG</strong></code><strong> and <code>LOCAL</code> instructions.</strong> If a name definitely refers to an argument or local variable of the immediately enclosing function, it can be accessed using <code>JSOP_{GET,SET,CALL}</code><code>{ARG,LOCAL}</code> instructions. Some of these can even be fused with other operations into combo instructions like <code>JSOP_GETARGPROP</code>, <code>JSOP_FORLOCAL</code>, and <code>JSOP_INCLOCAL</code>. Because arguments and locals can&apos;t be deleted, this optimization is available to all functions, and <code>eval</code> does not interfere with it. But a <code>with</code> block can:</p>

  <pre>function f(s) {
    eval(s);
    print(s);  // s can be loaded with GETARG
    with (obj) {
        print(s);  // no GETARG here; s might refer to obj.s
    }
}
</pre>
 </li>
 <li>
  <p><code><strong>UPVAR</strong></code><strong> instructions.</strong> JSOP_{GET,CALL}UPVAR (in algol-like functions only, I think?) TODO</p>
 </li>
 <li>
  <p><code><strong>DSLOT</strong></code><strong> instructions.</strong> JSOP_{GET,CALL}DSLOT (in flat closures only) TODO</p>
 </li>
 <li>
  <p><code><strong>GVAR</strong></code><strong> instructions.</strong> Outside all functions, if a name definitely refers to a global for which we have seen a var, <code>const</code>, or <code>function</code> declaration, then we emit a JS_DEFVAR instruction in the script prelude and access the global using <code>JSOP_{GET,SET,CALL}GVAR</code>. This is fast if the global either doesn&apos;t exist before the script runs (the script creates it) or it&apos;s a non-configurable data property (which amounts to the same thing). Otherwise the <code>GVAR</code> instructions are as slow as <code>NAME</code> instructions.</p>

  <p>There are also combo instructions <code>JSOP_{INC,DEC}GVAR</code> and <code>JSOP_GVAR{INC,DEC}</code>.</p>
 </li>
 <li>
  <p><code><strong>NAME</strong></code><strong> instructions.</strong> In the worst case we emit <code>JSOP_{,SET,CALL}NAME</code>. These are totally general. They can still be optimized via the property cache; in the worst case we walk the scope chain.</p>

  <p>In some cases, the JIT can optimize a <code>JSOP_NAME</code> instruction that refers to a variable in an enclosing scope to pull the value directly out of the <code>Call</code> object&apos;s <code>dslots</code>.</p>

  <p>For the expression <code>delete name</code> we always emit <code>JSOP_DELNAME</code>. It&apos;s not worth optimizing.</p>
 </li>
</ol>
