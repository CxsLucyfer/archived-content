---
title: Embedded WebExtensions
slug: Mozilla/Add-ons/WebExtensions/Embedded_WebExtensions
translation_of: Archive/Add-ons/Embedded_WebExtensions
---
<div><section class="Quick_links" id="Quick_Links">
  <ol>
    <li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions"><strong>Browser extensions</strong></a></li>
    <li class="toggle">
      <details>
        <summary>Getting started</summary>
        <ol>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/What_are_WebExtensions">What are extensions?</a></li>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/Your_first_WebExtension">Your first extension</a></li>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/Your_second_WebExtension">Your second extension</a></li>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/Anatomy_of_a_WebExtension">Anatomy of an extension</a></li>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/Examples">Example extensions</a></li>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/What_next_">What next?</a></li>
        </ol>
      </details>
    </li>
    <li class="toggle">
      <details>
        <summary>Concepts</summary>
        <ol>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/Using_the_JavaScript_APIs">Using the JavaScript APIs</a></li>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/Content_scripts">Content scripts</a></li>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/Match_patterns">Match patterns</a></li>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/Working_with_files">Working with files</a></li>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/Internationalization">Internationalization</a></li>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/Security_best_practices">Security best practices</a></li>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/Content_Security_Policy">Content Security Policy</a></li>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/Native_messaging">Native messaging</a></li>
        </ol>
      </details>
    </li>
    <li class="toggle">
      <details>
        <summary>User interface</summary>
        <ol>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/user_interface">User Interface</a></li>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/user_interface/Browser_action">Toolbar button</a></li>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/user_interface/Page_actions">Address bar button</a></li>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/user_interface/Sidebars">Sidebars</a></li>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/user_interface/Context_menu_items">Context menu items</a></li>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/user_interface/Options_pages">Options page</a></li>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/user_interface/Extension_pages">Extension pages</a></li>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/user_interface/Notifications">Notifications</a></li>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/user_interface/Omnibox">Address bar suggestions</a></li>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/user_interface/devtools_panels">Developer tools panels</a></li>
        </ol>
      </details>
    </li>
    <li class="toggle">
      <details>
        <summary>How to</summary>
        <ol>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/Intercept_HTTP_requests">Intercept HTTP requests</a></li>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/Modify_a_web_page">Modify a web page</a></li>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/Safely_inserting_external_content_into_a_page">Insert external content</a></li>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/Add_a_button_to_the_toolbar">Add a button to the toolbar</a></li>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/Implement_a_settings_page">Implement a settings page</a></li>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/Working_with_the_Tabs_API">Work with the Tabs API</a></li>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/Work_with_the_Bookmarks_API">Work with the Bookmarks API</a></li>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/Work_with_the_Cookies_API">Work with the Cookies API</a></li>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/Work_with_contextual_identities">Work with contextual identities</a></li>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/onboarding_upboarding_offboarding_best_practices">Onboard, upboard, and offboard users</a></li>
        </ol>
      </details>
    </li>
    <li class="toggle">
      <details>
        <summary>Porting</summary>
        <ol>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/Firefox_differentiators">Firefox differentiators</a></li>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/Porting_a_Google_Chrome_extension">Porting a Google Chrome extension</a></li>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/Porting_a_legacy_Firefox_add-on">Porting a legacy Firefox extension</a></li>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/Embedded_WebExtensions">Embedded WebExtensions</a></li>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/Comparison_with_the_Add-on_SDK">Comparison with the Add-on SDK</a></li>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/Comparison_with_XUL_XPCOM_extensions">Comparison with XUL/XPCOM extensions</a></li>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/Differences_between_API_implementations">Differences between API implementations</a></li>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/Chrome_incompatibilities">Chrome incompatibilities</a></li>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/Differences_between_desktop_and_Android">Differences between desktop and Android</a></li>
        </ol>
      </details>
    </li>
    <li class="toggle">
      <details>
        <summary>Firefox workflow</summary>
        <ol>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/Development_Tools">Developer tools</a></li>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/User_experience_best_practices">User Experience</a></li>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/Temporary_Installation_in_Firefox">Temporary Installation in Firefox</a></li>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/Debugging">Debugging</a></li>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/Testing_persistent_and_restart_features">Testing persistent and restart features</a></li>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/Developing_WebExtensions_for_Firefox_for_Android">Developing for Firefox for Android</a></li>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/Getting_started_with_web-ext">Getting started with web-ext</a></li>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/web-ext_command_reference">web-ext command reference</a></li>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/WebExtensions_and_the_Add-on_ID">Extensions and the Add-on ID</a></li>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/Request_the_right_permissions">Request the right permissions</a></li>
        </ol>
      </details>
    </li>
    <li class="toggle">
      <details>
        <summary>JavaScript APIs</summary>
        <ol><li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/Browser_support_for_JavaScript_APIs">Browser support for JavaScript APIs</a></li><li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/API/alarms">alarms</a></li><li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/API/bookmarks">bookmarks</a></li><li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/API/browserAction">browserAction</a></li><li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/API/contextMenus">contextMenus</a></li><li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/API/cookies">cookies</a></li><li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/API/devtools.inspectedWindow">devtools.inspectedWindow</a></li><li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/API/history">history</a></li><li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/API/runtime">runtime</a></li><li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/API/storage">storage</a></li><li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/API/tabs">tabs</a></li><li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/API/webNavigation">webNavigation</a></li><li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/API/webRequest">webRequest</a></li><li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/API/windows">windows</a></li></ol>
      </details>
    </li>

    <li class="toggle">
      <details>
      <summary>Manifest keys</summary>
      <ol><li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/manifest.json/browser_specific_settings">applications</a></li><li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/manifest.json/browser_action">browser_action</a></li><li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/manifest.json/content_scripts">content_scripts</a></li><li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/manifest.json/default_locale">default_locale</a></li><li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/manifest.json/developer">developer</a></li><li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/manifest.json/manifest_version">manifest_version</a></li><li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/manifest.json/version">version</a></li><li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/manifest.json/%E4%B8%BB%E9%A1%B5%E5%9C%B0%E5%9D%80">主页地址</a></li><li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/manifest.json/author">作者 - author</a></li><li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/manifest.json/name">名称 - name</a></li><li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/manifest.json/background">后台 - background</a></li><li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/manifest.json/description">描述 - description</a></li><li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions">权限 - permissions</a></li><li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/manifest.json/short_name">短名称 - short_name</a></li></ol>
      </details>
    </li>

    <li><a href="/zh-CN/docs/Mozilla/Add-ons/Themes"><strong>Themes</strong></a></li>
    <li class="toggle">
      <details>
        <summary>Browser themes</summary>
        <ol>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/Themes/Theme_concepts">Browser theme concepts</a></li>
        </ol>
      </details>
    </li>
    <li><a href="/zh-CN/docs/Mozilla/Add-ons/Distribution"><strong>Publishing and Distribution</strong></a></li>
    <li class="toggle">
      <details>
        <summary>Publishing add-ons</summary>
        <ol>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/Distribution">Signing and distribution overview</a></li>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/Package_your_extension_">Package your extension</a></li>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/Distribution/Submitting_an_add-on">Submit an add-on</a></li>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/Source_Code_Submission">Source code submission</a></li>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/Distribution/Resources_for_publishers">Resources for publishers</a></li>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/Listing">Creating an appealing listing</a></li>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/Distribution/Make_money_from_browser_extensions">Make money from browser extensions</a></li>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/Distribution/Promoting_your_extension_or_theme">Promoting your extension or theme</a></li>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/AMO/Policy/Reviews">Review policies</a></li>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/AMO/Policy/Agreement">Developer agreement</a></li>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/AMO/Policy/Featured">Featured add-ons</a></li>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/Distribution/Retiring_your_extension">Retiring your extension</a></li>
        </ol>
      </details>
    </li>
    <li class="toggle">
      <details>
        <summary>Distributing add-ons</summary>
        <ol>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/Alternative_distribution_options/Sideloading_add-ons">For sideloading</a></li>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/Alternative_distribution_options/Add-ons_for_desktop_apps">For desktop apps</a></li>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/Alternative_distribution_options/Add-ons_in_the_enterprise">For an enterprise</a></li>
        </ol>
      </details>
    </li>
    <li><a href="https://discourse.mozilla.org/c/add-ons"><strong>Community and Support</strong></a></li>
    <li class="toggle">
      <details>
        <summary>Channels</summary>
        <ol>
          <li><a href="https://blog.mozilla.org/addons">Add-ons blog</a></li>
          <li><a href="https://discourse.mozilla.org/c/add-ons">Add-on forums</a></li>
          <li><a href="http://stackoverflow.com/questions/tagged/firefox-addon">Stack Overflow</a></li>
          <li><a href="/zh-CN/docs/Mozilla/Add-ons/#Contact_us">Contact us</a></li>
        </ol>
      </details>
    </li>
  </ol>
</section></div>

<div class="note">
<p>嵌入一个 WebExtension 需要使用 Firefox 51 或更高版本。在 SDK 附加组件中嵌入一个 WebExtension 还需要 <a href="https://www.npmjs.com/package/jpm">jpm 1.2.0</a>。</p>
</div>

<p>从 Firefox 51 开始，你可以在传统附加组件类型中嵌入一个 WebExtension。</p>

<p>传统附加组件可以是经典的<a href="/en-US/docs/Mozilla/Add-ons/Bootstrapped_extensions">自举扩展</a>或者<a href="/en-US/docs/Mozilla/Add-ons/SDK">Add-on SDK</a> 附加组件。嵌入式 WebExtension 的文件打包在传统附加组件中。嵌入式 WebExtension 并不直接与嵌入的附加组件共享范围，但可以使用 <a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/API/runtime" title="该模块提供关于附加组件以及运行环境的信息。"><code>runtime</code></a> API 中定义的消息函数交换消息。</p>

<p><img src="https://mdn.mozillademos.org/files/13895/embedded-we.png" alt style="display: block; height: 522px; margin-left: auto; margin-right: auto; width: 429px;"></p>

<p>这意味着您可以一次性迁移传统附加组件到 WebExtensions，并且在此期间附加组件的功能完全保留。尤其是它可以让您从旧版附加组件<a href="/en-US/Add-ons/WebExtensions/Embedded_WebExtensions#Migrating_data_from_legacy_add-ons">迁移存储数据</a>到 WebExtension，通过撰写一个中间的混合式附加组件，使用旧版 API 读取数据（例如 <a href="/en-US/docs/Mozilla/Add-ons/SDK/High-Level_APIs/simple-prefs">simple-prefs</a> 或 preferences <a href="/en-US/docs/Mozilla/JavaScript_code_modules/Services.jsm">服务</a>）并使用 WebExtension API 写入它（例如 <a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/API/storage" title="此存储系统API基于 Web Storage API, 并有少许不同。"><code>storage</code></a>）。</p>

<p>连同本指南，我们撰写了两个例子展示如何使用嵌入式 WebExtensions 来帮助从传统附加组件迁移。<a href="https://github.com/mdn/webextensions-examples/tree/master/embedded-webextension-bootstrapped">如何从自举式附加组件迁移</a>以及<a href="https://github.com/mdn/webextensions-examples/tree/master/embedded-webextension-sdk">如何从 SDK 附加组件迁移</a>。</p>

<h2 id="Embedding_the_WebExtension">嵌入 WebExtension</h2>

<p>如果传统附加组件是一个带有<a href="/en-US/Add-ons/Install_Manifests">install.rdf</a> 的自举式扩展，在该 RDF 中加入 &quot;hasEmbeddedWebExtension&quot; 并设为 &quot;true&quot;：</p>

<pre>&lt;<span class="pl-ent">em</span><span class="pl-ent">:</span><span class="pl-ent">hasEmbeddedWebExtension</span>&gt;true&lt;/<span class="pl-ent">em</span><span class="pl-ent">:</span><span class="pl-ent">hasEmbeddedWebExtension</span>&gt;</pre>

<div>如果旧式附加组件是一个 SDK 附加组件，在 package.json 中包含 &quot;hasEmbeddedWebExtension&quot; 并设为 <code>true</code>：</div>

<div> </div>

<pre class="brush: json"><span class="pl-s"><span class="pl-pds">&quot;</span>hasEmbeddedWebExtension<span class="pl-pds">&quot;</span></span>: <span class="pl-c1">true</span>
</pre>

<div>WebExtension 本身放在附加组件中的 &quot;webextension&quot; 顶层目录。例如：</div>

<div> </div>

<pre>my-boostrapped-addon/
    chrome/
    webextension/
        manifest.json
        background.js
        ...
    bootstrap.js
    chrome.manifest
    install.rdf</pre>

<div> </div>

<div>
<pre>my-sdk-addon/
    index.js
    package.json
    webextension/
        manifest.json
        background.js
        ...</pre>
</div>

<p>Firefox 不将嵌入式 WebExtension 视为一个独立的附加组件。因此，您不应该为它指定一个<a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/WebExtensions_and_the_Add-on_ID">附加组件 ID</a>。如果你这样做，那只会被忽略。</p>

<p>但是，在您完成附加组件的迁移并移除旧式嵌入代码后，您必须添加一个 <a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/applications">applications</a> 键，设置 ID 为旧式附加组件的 ID。通过此方式，<a href="https://addons.mozilla.org/en-US/firefox/">addons.mozilla.org</a> 可以识别 WebExtension 是旧式附加组件的一个更新。</p>

<h2 id="Starting_the_WebExtension">启动 WebExtension</h2>

<p>嵌入式 WebExtension 必须由被嵌入的附加组件明确启动。</p>

<p>如果被嵌入的附加组件是一个自举式附加组件，那么传递到自举式扩展的 <code><a href="/en-US/Add-ons/Bootstrapped_extensions#startup">startup()</a></code> 函数的 <code>data</code> 将获得一个明确的 <code>webExtension</code>：</p>

<pre class="brush: js">// bootstrapped add-on

<span class="pl-k">function</span> <span class="pl-en">startup</span>({webExtension}) {

...</pre>

<p>如果被嵌入的附加组件是一个 SDK 附加组件，它可以使用 <code>sdk/webextension</code> 模块访问一个 WebExtension 对象：</p>

<pre class="brush: js"><span class="pl-k">// SDK add-on

const</span> <span class="pl-c1">webExtension</span> <span class="pl-k">=</span> <span class="pl-c1">require</span>(<span class="pl-s"><span class="pl-pds">&quot;</span>sdk/webextension<span class="pl-pds">&quot;</span></span>);</pre>

<p>无论哪种方式，此对象都有一个 <code>startup()</code> 函数，它返回一个 <code><a href="/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise">Promise</a></code>。该 promise 使用一个 <code>browser</code> 属性解决一个对象：这包括 <a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/API/runtime" title="该模块提供关于附加组件以及运行环境的信息。"><code>runtime</code></a> API，被嵌入的附加组件可以用它来与嵌入式 WebExtension 交换消息：</p>

<ul>
 <li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/API/runtime/onConnect"><code>runtime.onConnect</code></a></li>
 <li><a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/API/runtime/onMessage"><code>runtime.onMessage</code></a></li>
</ul>

<p>例如：</p>

<pre class="brush: js">// bootstrapped add-on

function startup({webExtension}) {
  webExtension.startup().then(api =&gt; {
    const {browser} = api;
    browser.runtime.onMessage.addListener(handleMessage);
  });
}</pre>

<pre class="brush: js"><span class="pl-k">// SDK add-on</span>

const webExtension = require(&quot;sdk/webextension&quot;);

webExtension.startup().then(api =&gt; {
  const {browser} = api;
  browser.runtime.onMessage.addListener(handleMessage);
});
</pre>

<p>应注意的是，嵌入的附加组件不能启动通信，它可以使用 <code>onMessage</code> 接收（并可选响应）一次性消息，并可以使用 <code>onConnect</code> 接受连接请求。</p>

<p>如果嵌入式 WebExtension 缺少一个 manifest，或者如果 manifest 无效，该 promise 会被拒绝。这种情况下，您可以在<a href="/en-US/Add-ons/WebExtensions/Debugging#Viewing_log_output">浏览器工具箱的控制台</a>中看到更多细节。</p>

<h2 id="Exchanging_messages">交换消息</h2>

<p>一旦嵌入式 WebExtension 处在运行，它可以使用 <a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/API/runtime" title="该模块提供关于附加组件以及运行环境的信息。"><code>runtime</code></a> API 的子集与旧式附加组件交换消息：</p>

<ul>
 <li>它可以使用 <a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/API/runtime/sendMessage"><code>runtime.sendMessage()</code></a> 发送一次性消息。</li>
 <li>它可以使用 <a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/API/runtime/connect"><code>runtime.connect()</code></a> 建立一个连接。</li>
</ul>

<h3 id="Connectionless_messaging">无需连接的消息</h3>

<p>要发送一条消息，WebExtension 可以使用 <a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/API/runtime/sendMessage" title="此页面仍未被本地化, 期待您的翻译!"><code>runtime.sendMessage()</code></a>。您可以省略 <code>extensionId</code> 参数，因为浏览器认为嵌入式 WebExtension 是被嵌入附加组件的一部分：</p>

<pre class="brush: js">browser.runtime.sendMessage(&quot;message-from-webextension&quot;).then(reply =&gt; {
  if (reply) {
    console.log(&quot;response from legacy add-on: &quot; + reply.content);
  }
});</pre>

<p>被嵌入的附加组件可以使用 <a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/API/runtime/onMessage" title="此页面仍未被本地化, 期待您的翻译!"><code>runtime.onMessage</code></a> 对象接收消息（并可选响应）：</p>

<pre class="brush: js">// bootstrapped add-on

function startup({webExtension}) {
  // Start the embedded webextension.
  webExtension.startup().then(api =&gt; {
    const {browser} = api;
    browser.runtime.onMessage.addListener((msg, sender, sendReply) =&gt; {
      if (msg == &quot;message-from-webextension&quot;) {
        sendReply({
          content: &quot;reply from legacy add-on&quot;
        });
      }
    });
  });
}</pre>

<h3 id="Connection-oriented_messaging">基于连接的消息</h3>

<p>要在 WebExtension 与传统附加组件间设置一个长寿命连接，WebExtension 可以使用 <a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/API/runtime/connect" title="此页面仍未被本地化, 期待您的翻译!"><code>runtime.connect()</code></a>。</p>

<pre class="brush: js">var port = browser.runtime.connect({name: &quot;connection-to-legacy&quot;});

port.onMessage.addListener(function(message) {
  console.log(&quot;Message from legacy add-on: &quot; + message.content);
});
</pre>

<p>旧式附加组件可以使用 <a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/API/runtime/onConnect" title="当使用扩展处理或content script建立连接时触发."><code>runtime.onConnect</code></a> 监听连接尝试，双方可以使用得到的 <a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/API/runtime/Port" title="此页面仍未被本地化, 期待您的翻译!"><code>runtime.Port</code></a> 来交换消息：</p>

<pre class="brush: js">function startup({webExtension}) {
  // Start the embedded webextension.
  webExtension.startup().then(api =&gt; {
    const {browser} = api;
    browser.runtime.onConnect.addListener((port) =&gt; {
      port.postMessage({
        content: &quot;content from legacy add-on&quot;
      });
    });
  });
}</pre>

<h2 id="Migrating_data_from_legacy_add-ons">从传统附加组件迁移数据</h2>

<p>嵌入式 WebExtensions 的一项主要用途是迁移附加组件的存储数据。</p>

<p>人们从旧式附加组件类型迁移的一个主要问题是存储数据，因为旧式附加组件不能使用 WebExtension 存储 API，WebExtensions 也不能使用旧式存储 API。例如，如果一个 SDK 附加组件使用了 SDK 的 <a href="/en-US/docs/Mozilla/Add-ons/SDK/High-Level_APIs/simple-prefs">simple-prefs</a> API 来存储首选项，WebExtension 版本不可能访问这项数据。</p>

<p>使用嵌入式 WebExtensions，您可以创建一个嵌入了 WebExtension 的附加组件中间版本来迁移数据。中间版本使用旧式 API 读取存储的数据，然后使用 WebExtension API 写入数据。</p>

<ul>
 <li>在初始版本中，基于 SDK 的附加组件使用 <a href="/en-US/docs/Mozilla/Add-ons/SDK/High-Level_APIs/simple-prefs">simple-prefs</a> API 读取和写入附加组件首选项。</li>
 <li>
  <p>在中间版本中，SDK 附加组件启动嵌入式 WebExtension。WebExtension 要求 SDK 附加组件用 simple-prefs 检索存储的数据。WebExtension 然后使用 <a href="/zh-CN/docs/Mozilla/Add-ons/WebExtensions/API/storage"><code>storage</code></a> API 存储数据。</p>

  <div class="note">
  <p>在某些情况下，中间版本必须在初始导入后保持数据同步。例如，<a href="/en-US/Add-ons/WebExtensions/Embedded_WebExtensions#Add-on_preferences_UI">附加组件的首选项界面仍然使用旧系统</a>，所以如果用户在这里修改了设置，它修改的是旧数据。中间的附加组件必须监听这些更改并将新数据发送到嵌入式 WebExtension。</p>

  <p>有个 <a href="https://github.com/mdn/webextensions-examples/tree/master/embedded-webextension-sdk">&quot;embedded-webextension-sdk&quot;</a> 示例说明了这一点。</p>
  </div>
 </li>
 <li>在最终版本中，附加组件只是一个 WebExtension，并且只使用存储 API。</li>
</ul>

<p>我们提供了两个例子说明此模式：<a href="https://github.com/mdn/webextensions-examples/tree/master/embedded-webextension-bootstrapped">&quot;embedded-webextension-bootstrapped&quot;</a> 展示了从一个自举式附加组件迁移，而 <a href="https://github.com/mdn/webextensions-examples/tree/master/embedded-webextension-sdk">&quot;embedded-webextension-sdk&quot;</a> 展示了从一个 SDK 附加组件迁移。</p>

<h2 id="Limitations">限制</h2>

<h3 id="Debugging">调试</h3>

<p>如果您有一个嵌入了 WebExtension 的旧式附加组件，您不能使用新的附加组件调试器来调试它。您必须使用基于浏览器工具箱的<a href="/en-US/Add-ons/WebExtensions/Debugging_(before_Firefox_50)">旧版调试工具</a>。</p>
