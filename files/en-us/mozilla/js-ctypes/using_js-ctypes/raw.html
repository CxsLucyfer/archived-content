<section class="Quick_links" id="Quick_Links">
 <ol>
  <li><a href="/en-US/docs/Mozilla/js-ctypes"><strong><em>js-ctypes</em></strong></a></li>
  <li class="toggle">
      <details open>
        <summary>Introduction</summary>
        <ol><li><a href="/en-US/docs/Mozilla/js-ctypes/Using_js-ctypes/Debugging_Tips" title="Editorial review completed.">Debugging Tips</a></li><li><a href="/en-US/docs/Mozilla/js-ctypes/Using_js-ctypes/Declaring_and_calling_functions" title="Functions are declared using the Library object's declare() method. Once declared, functions can be called using standard function syntax.">Declaring and Calling Functions</a></li><li><a href="/en-US/docs/Mozilla/js-ctypes/Using_js-ctypes/Declaring_and_Using_Callbacks" title="C functions occasionally take function pointers as arguments, which are generally used as callbacks. In these cases, js-ctypes allows you to pass a regular JavaScript function as the callback. This is very powerful, since it allows native code to transparently call into JavaScript.">Declaring and Using Callbacks</a></li><li><a href="/en-US/docs/Mozilla/js-ctypes/Using_js-ctypes/Declaring_types" title="The ctypes object offers a number of constructor methods that let you declare types. Every type is represented by a CType object, which, in turn, provides a constructor method you can call to define values of those types. Each type you declare using js-ctypes corresponds to a compatible C declaration.">Declaring types</a></li><li><a href="/en-US/docs/Mozilla/js-ctypes/Using_js-ctypes/Memory_Management" title="If JS code creates a structure or an array, that memory will be valid as long as the JS object stays alive. Pointers to that memory must be carefully managed to make sure the underlying memory is still referenced.">Memory Management</a></li><li><a href="/en-US/docs/Mozilla/js-ctypes/Using_js-ctypes/Standard_OS_Libraries" title="This article gives the names of standard libraries that can be accessed with js-ctypes. These libraries are what enable js-ctypes to work. The alternative to standard libraries is creating your own DLL (for Windows) or SO (for Linux) file with C functions that can be called from your add-on with js-ctypes. The DLL/SO/etc file you make must be shipped with your add-on. Standard libraries offer the advantage of not having to ship anything. They are already available on the operating system for you. You just need to supply the path to appropriate files and set up the proper types of values/arguments in the js-ctypes code. This article allows you to find out what types to give to values/arguments by supplying links to the documentation of the OS libraries.">Standard OS Libraries</a></li><li><a href="/en-US/docs/Mozilla/js-ctypes/Using_js-ctypes/Type_conversion" title="In js-ctypes, data could be converted implicitly when passing to or returning from a FunctionType call, or setting pointer content, an array element or a struct field.">Type conversion</a></li><li><a href="/en-US/docs/Mozilla/js-ctypes/Using_js-ctypes/Working_with_ArrayBuffers" title="An ArrayBuffer is a simply byte array. The js-ctypes equivalent is a ctypes.uint8_t.array(###) (ctypes.unsigned_char are also ctypes.uint8_t).">Working with ArrayBuffers</a></li><li><a href="/en-US/docs/Mozilla/js-ctypes/Using_js-ctypes/Working_with_data" title="Data types for use with js-ctypes are represented by CType objects. These are JavaScript constructors; as such, they're callable functions that you can use to create new CData objects of that type. There are several ways you can go about creating new CData objects.">Working with data</a></li><li><a href="/en-US/docs/Mozilla/js-ctypes/Using_js-ctypes/ctypes.open" title="At the heart of js-ctypes is the ctypes.open() function. This must be called before any work can commence. There are two options:">ctypes.open</a></li></ol>
      </details>
  </li>
  <li class="toggle">
      <details>
        <summary>References</summary>
        <ol><li><a href="/en-US/docs/Mozilla/js-ctypes/js-ctypes_reference/ABI" title="This article describes the calling conventions with respect to js-ctypes while programming x86 and x86-64/x64/AMD64 architectures. A calling convention is an implementation-level (low-level) scheme regarding how subroutines receive parameters from their caller and how they revert."><code>ABI</code></a></li><li><a href="/en-US/docs/Mozilla/js-ctypes/js-ctypes_reference/ArrayType" title="ArrayType represents C arrays"><code>ArrayType</code></a></li><li><a href="/en-US/docs/Mozilla/js-ctypes/js-ctypes_reference/CData" title="A CData object represents a C value or function located in memory."><code>CData</code></a></li><li><a href="/en-US/docs/Mozilla/js-ctypes/js-ctypes_reference/CType" title="All data types declared using the js-ctypes API are represented by CType objects. These objects have assorted methods and properties that let you create objects of these types, find out information about them, and so forth. The specific properties and methods on each object vary depending on the data type represented."><code>CType</code></a></li><li><a href="/en-US/docs/Mozilla/js-ctypes/js-ctypes_reference/FunctionType" title=""><code>FunctionType</code></a></li><li><a href="/en-US/docs/Mozilla/js-ctypes/js-ctypes_reference/Int64" title="Because JavaScript doesn't currently include standard support for 64-bit integer values, js-ctypes offers the Int64 and UInt64 objects to let you work with C functions and data that need (or may need) values represented using a 64-bit data type."><code>Int64</code></a></li><li><a href="/en-US/docs/Mozilla/js-ctypes/js-ctypes_reference/Library" title="The Library object represents a native library loaded by the ctypes open() method. Its methods let you declare symbols exported by the library, and to manage the library."><code>Library</code></a></li><li><a href="/en-US/docs/Mozilla/js-ctypes/js-ctypes_reference/PointerType" title="Returns a new CType object describing a new pointer data type."><code>PointerType</code></a></li><li><a href="/en-US/docs/Mozilla/js-ctypes/js-ctypes_reference/StructType" title="Returns a CType object describing a new structure data type. This data type provides the ability to define and manipulate values of the C struct type."><code>StructType</code></a></li><li><a href="/en-US/docs/Mozilla/js-ctypes/js-ctypes_reference/UInt64" title="As JavaScript doesn't currently include standard support for 64-bit integer values, js-ctypes offers the Int64 and UInt64 objects to let you work with C functions and data that need (or may need) to use data represented using a 64-bit data type."><code>UInt64</code></a></li><li><a href="/en-US/docs/Mozilla/js-ctypes/js-ctypes_reference/ctypes" title="The ctypes object contains methods and predefined data types used to create and manage a library."><code>ctypes</code></a></li></ol>
      </details>
  </li>
  <li class="toggle">
      <details>
        <summary>Examples</summary>
        <ol><li><a href="/en-US/docs/Mozilla/js-ctypes/Examples/Add_to_iPhoto" title="This extension for Mac OS X serves as a demonstration of how to use js-ctypes to call Mac OS X Carbon, Core Foundation, and other system frameworks from an extension written entirely in JavaScript.">Add to iPhoto</a></li><li><a href="/en-US/docs/Mozilla/js-ctypes/Examples/Using_C_structs_and_pointers" title="In this example, we show how to use C structs and pointers with js-ctypes.">Using C struct and pointers</a></li><li><a href="/en-US/docs/Mozilla/js-ctypes/Examples/Using_COM_from_js-ctypes" title="The Windows API mostly concerns itself with the interaction between the operating system and an application. For communication between the different Windows applications among themselves, Microsoft has developed a series of technologies alongside the main Windows API. This started out with Dynamic Data Exchange (DDE), which was superseded by Object Linking and Embedding (OLE) and later by the Component Object Model (COM), Automation Objects, ActiveX controls, and the .NET Framework.">Using COM from js-ctypes</a></li><li><a href="/en-US/docs/Mozilla/js-ctypes/Examples/Using_Objective-C_from_js-ctypes" title="Objective-C has its own syntax, it cannot be written directly with js-ctypes. This guide explains how to convert Objective-C code into js-ctypes code.">Using Objective-C from js-ctypes</a></li></ol>
      </details>
  </li>
 </ol>
</section>

<div> <div class="blockIndicator draft">
    <p><strong>Draft</strong><br>
    This page is not complete.</p>

</div></div>

<p>Before you can use js-ctypes, you need to import the ctypes.jsm code module. This is as simple as including the following line of code in the desired JavaScript scope:</p>

<pre>Components.utils.import("resource://gre/modules/ctypes.jsm")</pre>

<h2 id="Loading_a_native_library">Loading a native library</h2>

<p>Once you've imported the code module, you can call the <a href="/en-US/docs/js-ctypes/js-ctypes_reference/ctypes#open()"><code>ctypes.open()</code></a> method to load each native library you wish to use. On Windows, for example, you might load the system user32 library like this:</p>

<pre>var lib = ctypes.open("user32.dll");</pre>

<p>On Mac OS X, you can load the Core Foundation library from the Core Foundation framework like this:</p>

<pre>var coreFoundation = ctypes.open("/System/Library/Frameworks/CoreFoundation.framework/CoreFoundation");</pre>

<p>The returned object is a Library object that you use to declare functions and data types for use with the loaded library.</p>

<div class="note"><strong>Note:</strong> js-ctypes only works with C libraries; you can't use C++ methods directly. Instead, you'll need to create a shim library that uses C functions that then call into the C++ library for you. Examples can be found here: <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=505907#c20">Bugzilla :: Bug 505907 - Support C++ calling from JSctypes</a></div>

<h3 id="Library_search_paths">Library search paths</h3>

<p>If you specify a full path, that path is used to load the library. Otherwise, the system looks for the library in its standard locations.</p>

<h4 id="Windows">Windows</h4>

<p>On Windows, the following locations are searched for the library, in this order:</p>

<ol>
 <li>The application's directory.</li>
 <li>The system directory.</li>
 <li>The 16-bit system directory.</li>
 <li>The Windows directory.</li>
 <li>The current working directory</li>
 <li>The directories listed in the <code>PATH</code> environment variable.</li>
</ol>

<div class="note"><strong>Note:</strong> This information comes from <a href="http://msdn.microsoft.com/en-us/library/ms682586(VS.85).aspx">this article on MSDN</a>.</div>

<h2 id="After_youre_done">After you're done</h2>

<p>When you're finished using a library, you should close it by calling the <code>Library</code> object's <a href="/en-US/docs/js-ctypes/js-ctypes_reference/Library#close()"><code>close()</code></a> method:</p>

<pre>lib.close();</pre>

<p>If you fail to close the library, it will be automatically closed when it is garbage collected.</p>

<h2 id="Using_the_library">Using the library</h2>

<p>You may need to declare new types. These can be simple types or more complex types such as structures. See <a href="/en-US/docs/js-ctypes/Using_js-ctypes/Declaring_types">Declaring types</a> for details. You will almost certainly need to <a href="/en-US/docs/js-ctypes/Using_js-ctypes/Declaring_and_calling_functions">declare one or more functions</a>, so that you can call them.</p>

<p>Once you've declared the types and functions, you can write your code to make use of them. Instantiating C data objects and referencing them is covered in the article <a href="/en-US/docs/js-ctypes/Using_js-ctypes/Working_with_data">Working with data</a>.</p>

<h2 id="Memory_management">Memory management</h2>

<p>moved to <a href="/en-US/docs/Mozilla/js-ctypes/Using_js-ctypes/Memory_Management">Memory Management</a> page.</p>

<h2 id="Examples">Examples</h2>

<p>These examples offer a quick look at how js-ctypes is used. See <a href="/en-US/docs/js-ctypes/Examples">js-ctypes examples</a> for more intricate examples.</p>

<h3 id="Calling_Windows_routines">Calling Windows routines</h3>

<p>This example demonstrates how to use ctypes to call a Win32 API.</p>

<pre class="brush: js">Components.utils.import("resource://gre/modules/ctypes.jsm");

var lib = ctypes.open("C:\\WINDOWS\\system32\\user32.dll");

/* Declare the signature of the function we are going to call */
var msgBox = lib.declare("MessageBoxW",
                         ctypes.winapi_abi,
                         ctypes.int32_t,
                         ctypes.int32_t,
                         ctypes.jschar.ptr,
                         ctypes.jschar.ptr,
                         ctypes.int32_t);
var MB_OK = 0;

var ret = msgBox(0, "Hello world", "title", MB_OK);

lib.close();</pre>

<p>In line 3, the <code>user32.dll</code> system library is loaded. Line 6 declares <code>msgBox()</code> to be a method that calls the Windows function <a href="http://msdn.microsoft.com/en-us/library/ms645505%28VS.85%29.aspx"><code>MessageBoxW</code></a>. Line 15 calls the <code>msgBox()</code> routine, which displays the alert.</p>

<p>The last thing we do is call <code>lib.close()</code> to close the library when we're done using it.</p>

<p>Instead of defining the whole path, you may also just give the file name.</p>

<p>ABOUT DECLARING THE FUNCTION</p>

<p>How we knew how to declare the function was by going to MSDN site and looking at the MessageBox (MessageBoxW is just a unicode version of same function) function. Also learn about the lib.declare function used here: <a href="/en-US/docs/Mozilla/js-ctypes/js-ctypes_reference/Library#declare%28%29">lib.declare</a>. Learn about the data types used here: <a href="/en-US/docs/Mozilla/js-ctypes/js-ctypes_reference/ctypes?redirectlocale=en-US&amp;redirectslug=js-ctypes%2Fjs-ctypes_reference%2Fctypes#Predefined_data_types">Data Types</a>. We see that it needs to be defined like this:</p>

<pre>int WINAPI MessageBox(
  _In_opt_  HWND hWnd,
  _In_opt_  LPCTSTR lpText,
  _In_opt_  LPCTSTR lpCaption,
  _In_      UINT uType
);</pre>

<p>So we read this article here on defining types and replicate it: <a href="/en-US/docs/Mozilla/js-ctypes/Using_js-ctypes/Declaring_types">Declaring Types</a></p>

<pre>var lib = ctypes.open("user32.dll");
</pre>

<p>Or even without the extension.</p>

<pre>var lib = ctypes.open("user32");
</pre>

<h3 id="Calling_Carbon_routines_on_Mac_OS_X">Calling Carbon routines on Mac OS X</h3>

<p>This example demonstrates how to use ctypes to call a Carbon function on Mac OS X.</p>

<div class="note"><strong>Note:</strong> This example will not work on 64bit OS X, see below for Core Foundation for 64bit OS X</div>

<pre class="brush: js">/* build a Str255 ("Pascal style") string from the passed-in string */

function makeStr(str) {
  return String.fromCharCode(str.length) + str;
}

Components.utils.import("resource://gre/modules/ctypes.jsm");

var carbon = ctypes.open("/System/Library/Frameworks/Carbon.framework/Carbon");

stdAlert = carbon.declare("StandardAlert",       /* function name */
                          ctypes.default_abi,    /* ABI type */
                          ctypes.int16_t,        /* return type */
                          ctypes.int16_t,        /* alert type */
                          ctypes.char.ptr,       /* primary text */
                          ctypes.char.ptr,       /* secondary text */
                          ctypes.uint32_t,       /* alert param */
                          ctypes.int16_t);       /* item hit */

var hit = 0;
var msgErr = makeStr("Carbon Says...");
var msgExp = makeStr("We just called the StandardAlert Carbon function from JavaScript!");

var err = stdAlert(1, msgErr, msgExp, 0, hit);

carbon.close();</pre>

<p>The <code>makeStr()</code> function is a utility routine that takes as input a standard JavaScript string and returns a Carbon-style "Pascal" string, which is a length byte followed by the characters of the string itself. Note that this only works correctly if the string is in fact under 256 characters; if it's longer, this will fail spectacularly.</p>

<p>In line 9, the Carbon library is loaded from the system's Carbon framework.</p>

<p>Line 11 declares the <code>stdAlert()</code> function, which will call the Carbon <code>StandardAlert</code> routine. It uses the default ABI, returns a 16-bit integer (which is a Carbon <code>OSErr</code> value), and accepts an integer (the alert type), two strings, a pointer to a parameter block, which we aren't using, and another integer, which is used to return the hit item. See Apple's documentation for <a href="http://developer.apple.com/legacy/mac/library/documentation/Carbon/Reference/Dialog_Manager/Reference/reference.html#//apple_ref/c/func/StandardAlert"><code>StandardAlert</code></a> for details.</p>

<p>After that, we simply set up our parameters by using <code>makeStr()</code> to generate the two <code>Str255</code> strings we need, then call <code>stdAlert()</code>, which produces the following alert window:</p>

<p><img alt="ctype-mac-dialog.png" class="default internal" src="/@api/deki/files/4559/=ctype-mac-dialog.png"></p>

<p>The last thing we do is call <code>carbon.close()</code> to close the library when we're done using it.</p>

<h4 id="Standard_Alert_in_64bit_OS_X">Standard Alert in 64bit OS X</h4>

<p>Carbon is not available in 64bit versions of OS X, therefore Core Foundation must be used. The below will do the same as <code>StandardAlert</code> from above, it will use the Core Foundation function of <code>CFUserNotificationDisplayNotice</code>.</p>

<pre>Cu.import('resource://gre/modules/ctypes.jsm');
var libcf = ctypes.open('/System/Library/Frameworks/CoreFoundation.framework/CoreFoundation');

// DEFINE TYPES
var CFIndex = ctypes.long;
var CFOptionFlags = ctypes.unsigned_long;
var CFTimeInterval = ctypes.double;
var CFTypeRef = ctypes.voidptr_t;
var SInt32 = ctypes.long;
var VOID = ctypes.void_t;

var __CFString = new ctypes.StructType("__CFString");
var CFStringRef = __CFString.ptr;

var __CFURL = new ctypes.StructType("__CFURL");
var CFURLRef = __CFURL.ptr;

var __CFAllocator = new ctypes.StructType("__CFAllocator");
var CFAllocatorRef = __CFAllocator.ptr;

var UniChar = ctypes.jschar;   // uint16 with automatic conversion

// DEFINE CONSTANTS
var kCFUserNotificationStopAlertLevel = 0;
var kCFUserNotificationNoteAlertLevel = 1;
var kCFUserNotificationCautionAlertLevel = 2;
var kCFUserNotificationPlainAlertLevel = 3;

// DECLARE FUNCTIONS
/* https://developer.apple.com/library/mac/documentation/CoreFoundation/Reference/CFUserNotificationRef/index.html#//apple_ref/c/func/CFUserNotificationDisplayNotice
 * SInt32 CFUserNotificationDisplayNotice (
 *   CFTimeInterval timeout,
 *   CFOptionFlags flags,
 *   CFURLRef iconURL,
 *   CFURLRef soundURL,
 *   CFURLRef localizationURL,
 *   CFStringRef alertHeader,
 *   CFStringRef alertMessage,
 *   CFStringRef defaultButtonTitle
 * );
 */
var CFUserNotificationDisplayNotice = libcf.declare("CFUserNotificationDisplayNotice", ctypes.default_abi,
	SInt32,				// return
	CFTimeInterval,		// timeout
	CFOptionFlags,		// flags
	CFURLRef,			// iconURL
	CFURLRef,			// soundURL
	CFURLRef,			// localizationURL
	CFStringRef,		// alertHeader
	CFStringRef,		// alertMessage
	CFStringRef			// defaultButtonTitle
);

/* https://developer.apple.com/library/mac/documentation/CoreFoundation/Reference/CFTypeRef/#//apple_ref/c/func/CFRelease
 * void CFRelease (
 *   CFTypeRef cf
 * );
 */
var CFRelease = libcf.declare('CFRelease', ctypes.default_abi,
	VOID,		// return
	CFTypeRef	// cf
);

/* https://developer.apple.com/library/mac/documentation/CoreFoundation/Reference/CFStringRef/#//apple_ref/c/func/CFStringCreateWithCharacters
 * CFStringRef CFStringCreateWithCharacters (
 *   CFAllocatorRef alloc,
 *   const UniChar *chars,
 *   CFIndex numChars
 * );
 */
var CFStringCreateWithCharacters = libcf.declare('CFStringCreateWithCharacters', ctypes.default_abi,
	CFStringRef,		// return
	CFAllocatorRef,		// alloc
	UniChar.ptr,		// *chars
	CFIndex				// numChars
);

// HELPER FUNCTIONS
function makeCFStr(jsStr) {
	// js str is just a string
	// returns a CFStr that must be released with CFRelease when done
	return CFStringCreateWithCharacters(null, jsStr, jsStr.length);
}

// MAIN
var myCFStrs = {
	head: makeCFStr('Core Foundation Says...'),
	body: makeCFStr('We just called the equivalent of the "StandardAlert Carbon function" for 64bit OSX from JavaScript!')
};

var rez = CFUserNotificationDisplayNotice(0, kCFUserNotificationCautionAlertLevel, null, null, null, myCFStrs.head, myCFStrs.body, null);
console.info('rez:', rez, rez.toString(), uneval(rez)); // CFUserNotificationDisplayNotice does not block till user clicks dialog, it will return immediately

if (rez.toString() == '0') {
    console.log('Notification was succesfully shown!!');
} else {
    console.error('Failed to show notification... :(');
}

for (var cfstr in myCFStrs) {
	if (myCFStrs.hasOwnProperty(cfstr)) {
		var rez_CFRelease = CFRelease(myCFStrs[cfstr]); // returns void
	}
}

libcf.close();</pre>

<h3 id="Calling_LibC_routines_on_LinuxPOSIX">Calling LibC routines on Linux/POSIX</h3>

<p>This example demonstrates how to use ctypes to call a libc function on Linux.</p>

<pre class="brush: js">/* import js-ctypes */
var {Cu} = require("chrome");
var {ctypes} = Cu.import("resource://gre/modules/ctypes.jsm", null);

/* Open the library */
try {
  /* Linux */
  var libc = ctypes.open("libc.so.6");
} catch (e) {
  /* Most other Unixes */
  libc = ctypes.open("libc.so");
}

/* Import a function */
var puts = libc.declare("puts",             /* function name */
                        ctypes.default_abi, /* call ABI */
                        ctypes.int,         /* return type */
                        ctypes.char.ptr);   /* argument type */

var ret = puts("Hello World from js-ctypes!");

libc.close();
</pre>