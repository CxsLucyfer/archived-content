<p>SpecialPowers is a set of APIs available to <a href="/en/Mochitest" title="en/Mochitest">Mochitest</a> tests. Mochitests are intended to be written like regular web pages. However, sometimes tests need to do things that regular web pages are not permitted to do for security reasons. In these cases, the SpecialPowers APIs can be used to perform specific actions outside of the reach of normal web pages.</p>

<h2 id="Method_overview">Method overview</h2>

<h3 id="Preference_APIs">Preference APIs</h3>

<table class="standard-table" style="height: 415px; width: 460px;">
 <tbody>
  <tr>
   <td><code>Promise pushPrefEnv(inPrefs, [callback]);</code></td>
  </tr>
  <tr>
   <td><code>Promise popPrefEnv([callback]);</code></td>
  </tr>
  <tr>
   <td><code>Promise flushPrefEnv([callback]);</code></td>
  </tr>
  <tr>
   <td><code>bool getBoolPref(prefName, [defaultValue]);</code></td>
  </tr>
  <tr>
   <td><code>int getIntPref(prefName, [defaultValue]);</code></td>
  </tr>
  <tr>
   <td><code>string getCharPref(prefName, [defaultValue]);</code></td>
  </tr>
  <tr>
   <td><code>any getComplexValue(prefName);</code></td>
  </tr>
  <tr>
   <td><code>void setBoolPref(prefName, value);</code></td>
  </tr>
  <tr>
   <td><code>void setIntPref(prefName, value);</code></td>
  </tr>
  <tr>
   <td><code>void setCharPref(prefName, value);</code></td>
  </tr>
  <tr>
   <td><code>void setComplexValue(prefName, value);</code></td>
  </tr>
  <tr>
   <td><code>void clearUserPref(prefName);</code></td>
  </tr>
 </tbody>
</table>

<h3 id="Permission_APIs">Permission APIs</h3>

<table class="standard-table">
 <tbody>
  <tr>
   <td><code>void pushPermissions(inPermissions, callback);</code></td>
  </tr>
  <tr>
   <td><code>void popPermissions(callback);</code></td>
  </tr>
  <tr>
   <td><code>void flushPermissions(callback);</code></td>
  </tr>
  <tr>
   <td><code>void addPermission(type, allow, arg);</code></td>
  </tr>
  <tr>
   <td><code>void removePermission(type, arg);</code></td>
  </tr>
  <tr>
   <td><code>bool hasPermission(type, arg);</code></td>
  </tr>
  <tr>
   <td><code>bool testPermission(type, value, arg);</code></td>
  </tr>
  <tr>
   <td><code>void setFullscreenAllowed(document);</code></td>
  </tr>
  <tr>
   <td><code>void removeFullscreenAllowed(document);</code></td>
  </tr>
 </tbody>
</table>

<h3 id="Event_Listener_Observer_APIs">Event Listener / Observer APIs</h3>

<p>TBD</p>

<h3 id="Garbage_Collection_APIs">Garbage Collection APIs</h3>

<p>TBD</p>

<h3 id="Privilege_Wrapper_APIs">Privilege Wrapper APIs</h3>

<table class="standard-table">
 <tbody>
  <tr>
   <td><code><a href="#wrap">Object wrap(Object);</a></code></td>
  </tr>
 </tbody>
</table>

<h3 id="XPCOM_Components_APIs">XPCOM Components APIs</h3>

<table class="standard-table">
 <tbody>
  <tr>
   <td><code><a href="#Cc">Cc</a></code></td>
  </tr>
  <tr>
   <td><code><a href="#Ci">Ci</a></code></td>
  </tr>
  <tr>
   <td><code><a href="#Cr">Cr</a></code></td>
  </tr>
  <tr>
   <td><code><a href="#Cu">Cu</a></code></td>
  </tr>
 </tbody>
</table>

<h3 id="Log_APIs">Log APIs</h3>

<p>TBD</p>

<h3 id="Environment_APIs">Environment APIs</h3>

<table class="standard-table" style="height: 250px; width: 463px;">
 <tbody>
  <tr>
   <td><code>bool isMainProcess();</code></td>
  </tr>
  <tr>
   <td><code>string getMozFullPath(file);</code></td>
  </tr>
  <tr>
   <td><code>bool isWindowPrivate(aWindow);</code></td>
  </tr>
  <tr>
   <td><code>bool isBackButtonEnabled(aWindow);</code></td>
  </tr>
  <tr>
   <td><code>int assertionCount();</code></td>
  </tr>
  <tr>
   <td><code>void removeExpectedCrashDumpFiles(aExpectingProcessCrash);</code></td>
  </tr>
  <tr>
   <td><code>string[] findUnexpectedCrashDumpFiles();</code></td>
  </tr>
 </tbody>
</table>

<h3 id="Focus_Management_APIs">Focus Management APIs</h3>

<p>TBD</p>

<h3 id="Mock_APIs">Mock APIs</h3>

<p>TBD</p>

<h3 id="Form_History_APIs">Form History APIs</h3>

<p>TBD</p>

<h3 id="Snapshot_APIs">Snapshot APIs</h3>

<p>TBD</p>

<h3 id="Clipboard_APIs">Clipboard APIs</h3>

<p>TBD</p>

<h3 id="Console_APIs">Console APIs</h3>

<p>TBD</p>

<h3 id="Layout_APIs">Layout APIs</h3>

<p>TBD</p>

<h3 id="Frame_Message_APIs">Frame Message APIs</h3>

<p>TBD</p>

<h3 id="Apps_APIs">Apps APIs</h3>

<p>TBD</p>

<h3 id="Other_APIs">Other APIs</h3>

<table class="standard-table">
 <tbody>
  <tr>
   <td><code>XMLHttpRequest createSystemXHR();</code></td>
  </tr>
  <tr>
   <td><code>void quit();</code></td>
  </tr>
  <tr>
   <td><code>DOMWindowUtils getDOMWindowUtils(window);</code></td>
  </tr>
  <tr>
   <td><code>void executeSoon(aFun, aWindow);</code></td>
  </tr>
  <tr>
   <td><code>object getDOMRequestService();</code></td>
  </tr>
  <tr>
   <td><code>void openDialog(aWindow, aArg);</code></td>
  </tr>
  <tr>
   <td><code>string sanityCheck();</code></td>
  </tr>
 </tbody>
</table>

<h2 id="Attributes">Attributes</h2>

<table class="standard-table">
 <thead>
  <tr>
   <th scope="col">Attribute</th>
   <th scope="col">Type</th>
   <th scope="col">Description</th>
  </tr>
 </thead>
 <tbody>
  <tr>
   <td><code>DOMWindowUtils</code></td>
   <td> </td>
   <td> </td>
  </tr>
  <tr>
   <td><code>Services</code></td>
   <td> </td>
   <td> </td>
  </tr>
 </tbody>
</table>

<h2 id="Methods">Methods</h2>

<h3 id="Preference_APIs_2">Preference APIs</h3>

<p>See <code><a href="/en-US/docs/Mozilla/Tech/XPCOM/Reference/Interface/nsIPrefBranch" title="">nsIPrefBranch</a></code> for documentation on the APIs that these methods use internally.</p>

<h4 id="getBoolPref(prefName_defaultValue)"><code>getBoolPref(prefName, [defaultValue])</code></h4>

<p>Gets the value of the preference <code>prefName</code> as a boolean. If <code>prefName</code> cannot be found and <code>defaultValue</code> is not set, an exception will be thrown. If <code>prefName</code> cannot be found and <code>defaultValue</code>  is set, <code>defaultValue</code> will be returned. <code>defaultValue</code> should be a boolean if specified.</p>

<h4 id="getIntPref(prefName_defaultValue)"><code>getIntPref(prefName, [defaultValue])</code></h4>

<p>Gets the value of the preference <code>prefName</code> as an integer. If <code>prefName</code> cannot be found and <code>defaultValue</code> is not set, an exception will be thrown. If <code>prefName</code> cannot be found and <code>defaultValue</code>  is set, <code>defaultValue</code> will be returned. <code>defaultValue</code> should be an integer if specified.</p>

<h4 id="getCharPref(prefName_defaultValue)"><code>getCharPref(prefName, [defaultValue])</code></h4>

<p>Gets the value of the preference <code>prefName</code> as a string. If <code>prefName</code> cannot be found and <code>defaultValue</code> is not set, an exception will be thrown. If <code>prefName</code> cannot be found and <code>defaultValue</code>  is set, <code>defaultValue</code> will be returned. <code>defaultValue</code> should be a string if specified.</p>

<h4 id="getComplexValue(prefName)"><code>getComplexValue(prefName)</code></h4>

<p>Gets the value of the preference <code>prefName</code> as an XPCOM object.</p>

<h4 id="setBoolPref(prefName_value)"><code>setBoolPref(prefName, value)</code></h4>

<p>Sets the value of the preference <code>prefName</code> to the boolean value <code>value</code>.</p>

<h4 id="setIntPref(prefName_value)"><code>setIntPref(prefName, value)</code></h4>

<p>Sets the value of the preference <code>prefName</code> to the integer value <code>value</code>.</p>

<h4 id="setCharPref(prefName_value)"><code>setCharPref(prefName, value)</code></h4>

<p>Sets the value of the preference <code>prefName</code> to the string value <code>aValue</code>.</p>

<h4 id="setComplexValue(prefName_value)"><code>setComplexValue(prefName, value)</code></h4>

<p>Sets the value of the preference <code>prefName</code> to the XPCOM object <code>value</code>.</p>

<h4 id="clearUserPref(prefName)"><code>clearUserPref(prefName)</code></h4>

<p>Resets the preference <code>prefName </code>to its default value.</p>

<h3 id="Permission_APIs_2">Permission APIs</h3>

<p>TBD</p>

<h3 id="Event_Listener_Observer_APIs_2">Event Listener / Observer APIs</h3>

<h4 id="addChromeEventListener(type_listener_capture_allowUntrusted)"><code>addChromeEventListener(type, listener, capture, allowUntrusted)</code></h4>

<p>Adds an event listener to the TabChildGlobal object.</p>

<h4 id="removeChromeEventListener(type_listener_capture)"><code>removeChromeEventListener(type, listener, capture)</code></h4>

<p>Removes an event listener from the TabChildGlobal object.</p>

<h3 id="Garbage_Collection_APIs_2">Garbage Collection APIs</h3>

<h4 id="gc()"><code>gc()</code></h4>

<p>Forces a round of garbage collection to be performed.</p>

<h3 id="Privilege_Wrapper_APIs_2">Privilege Wrapper APIs</h3>

<h4 id="Object_wrap(Object)"><code>Object wrap(Object)</code></h4>

<p>Wraps a chrome object so that it can be accessed.  Needed for accessing the return values of methods returned by XPCOM components (for example).</p>

<h3 id="XPCOM_Components_APIs_2">XPCOM Components APIs</h3>

<h4 id="Cc"><code>Cc</code></h4>

<p>The value of <code>Components.classes</code>, as available to chrome code.</p>

<h4 id="Ci"><code>Ci</code></h4>

<p>The value of <code>Components.interfaces</code>, as available to chrome code.</p>

<h4 id="Cr"><code>Cr</code></h4>

<p>The value of <code>Components.results</code>, as available to chrome code.</p>

<h4 id="Cu"><code>Cu</code></h4>

<p>The value of <code>Components.utils</code>, as available to chrome code.</p>

<h3 id="Log_APIs_2">Log APIs</h3>

<p>TBD</p>

<h3 id="Environment_APIs_2">Environment APIs</h3>

<p>TBD</p>

<h3 id="Focus_Management_APIs_2">Focus Management APIs</h3>

<p>TBD</p>

<h3 id="Mock_APIs_2">Mock APIs</h3>

<h4 id="MockFilePicker"><code>MockFilePicker</code></h4>

<p>This replaces the standard File Picker with one that can be controlled via script, for testing load and save code. To use it, add the following lines of code to your test:</p>

<pre class="brush:js;">var MockFilePicker = SpecialPowers.MockFilePicker;
MockFilePicker.reset(); // You must call reset before each test
</pre>

<p><a class="link-https" href="https://bugzilla.mozilla.org/attachment.cgi?id=544963&amp;action=diff" title="https://bugzilla.mozilla.org/attachment.cgi?id=544963&amp;action=diff">This patch</a> has examples of how to use the MockFilePicker, and also how to use it for XPCShell tests. The code in <code>testing/mochitest/MockFilePicker.jsm</code> might also be helpful.</p>

<h3 id="Form_History_APIs_2">Form History APIs</h3>

<p>TBD</p>

<h3 id="Snapshot_APIs_2">Snapshot APIs</h3>

<p>TBD</p>

<h3 id="Clipboard_APIs_2">Clipboard APIs</h3>

<p>TBD</p>

<h3 id="Console_APIs_2">Console APIs</h3>

<p>TBD</p>

<h3 id="Layout_APIs_2">Layout APIs</h3>

<p>TBD</p>

<h3 id="Frame_Message_APIs_2">Frame Message APIs</h3>

<h4 id="loadChromeScript()"><code>loadChromeScript()</code></h4>

<p>TBD</p>

<h3 id="Apps_APIs_2">Apps APIs</h3>

<p>TBD</p>

<h3 id="Other_APIs_2">Other APIs</h3>

<h4 id="createSystemXHR()"><code>createSystemXHR()</code></h4>

<p>Creates and returns an XMLHttpRequest instance which has full "system privileges". In other words, it can:</p>

<ul>
 <li>Make cross-site requests without any restrictions, i.e. the target server does not need to support CORS.</li>
 <li>Set any header using xhr.setRequestHeader.</li>
 <li>Read any response using xhr.getResponseHeader and xhr.getAllResponseHeaders.</li>
 <li>Load and parse XUL contents using the xhr.responseXML property.</li>
 <li>Make requests without a <code>referer</code> (sic) header. If you want a <code>referer</code> header set, you have to do so manually using xhr.setRequestHeader.</li>
</ul>

<p>However, any document parsed by the xhr object and accessed through xhr.responseXML is created using a null principal, which limits what the document can do.</p>

<h4 id="sanityCheck()"><code>sanityCheck()</code></h4>

<p>Returns the string <code>"foo"</code>.</p>

<h2 id="Adding_new_APIs">Adding new APIs</h2>

<p>If your test requires privileged functionality that's not currently present, you can add new APIs to the SpecialPowers object.</p>

<div class="note">The SpecialPowers APIs are designed to be forwards-compatible with the Electrolysis project, so that they work when content is run in a separate process (such as in Firefox Mobile). Any changes you make must take this into account, or they will not be accepted.</div>

<p>Because of the support for out-of-process content, the SpecialPowers implementation is split into two separate files:</p>

<ul>
 <li><a href="https://dxr.mozilla.org/mozilla-central/source/testing/specialpowers/content/SpecialPowersObserver.jsm" rel="custom">SpecialPowersObserver.jsm</a>, which is always run in the parent process.</li>
 <li><a href="https://dxr.mozilla.org/mozilla-central/source/testing/specialpowers/content/specialpowers.js" rel="custom">specialpowers.js</a>, which is a <a href="/en/The_message_manager#The_content_script" title="en/The message manager#The content script">content script</a>, and may be run in the content process.</li>
</ul>

<p>Both files execute with chrome privileges, but certain XPCOM APIs are not available in content processes. Consult with an Electrolysis or Mobile peer if you are unsure if you can use a specific API there. You may also want to read the <a href="/en/The_message_manager" title="en/The message manager">Message Manager</a> documentation for more detailed information on how cross-process messaging works.</p>

<h3 id="A_simple_example">A simple example</h3>

<p>Let's say you wanted to expose the <code>numberOfScreens</code> attribute from the <code><a href="/en-US/docs/Mozilla/Tech/XPCOM/Reference/Interface/nsIScreenManager" title="">nsIScreenManager</a></code> interface. Let's also suppose that this interface is not available in the content process, just to make our example more complete. To start, first you would need to define the new API on the <code>SpecialPowers</code> object that is exposed to content. This object is defined in <a href="https://dxr.mozilla.org/mozilla-central/source/testing/specialpowers/content/specialpowers.js" rel="custom">the content script</a>.</p>

<div class="note">Since <code>SpecialPowers</code> is just a normal JavaScript object, you can add functions, attributes, getters, and setters to it like any other object. It does use the special<span id="the-code"><span class="a"> <code>__exposedProps__</code> property to hide any property beginning with an underscore ("_") from content scripts, so names starting with an underscore function like private members.</span></span></div>

<p>Let's first add a <code>numberOfScreens</code> getter to <code>SpecialPowers</code>. It will simply send a blocking message to the chrome process, asking it to return the value in its response:</p>

<pre class="brush:js;" lang="en"><span id="the-code"><span class="v">var </span><a class="d" href="http://mxr.mozilla.org/mozilla-central/ident?i=SpecialPowers">SpecialPowers</a> = {
  // existing APIs
  //...

</span><span id="the-code">  // Provide nsIScreenManager.numberOfScreens
  get numberOfScreens() {
    // You could pass additional parameters in the second parameter, consult the <a title="en/The message manager">message manager</a> documentation for more details.
    // Ideally this would be a memoizing getter, that's somewhat out of scope for this document.
    return sendSyncMessage("SPNumberOfScreens", {})[0];
  }</span>
<span id="the-code">};
</span></pre>

<p>Now you need to provide a handler for this message in the <a href="https://dxr.mozilla.org/mozilla-central/source/testing/specialpowers/components/SpecialPowersObserver.js" rel="custom">chrome observer script</a>. In the <span id="the-code"><code>SpecialPowersObserver.observe</code> function, register your message underneath the existing messages:</span></p>

<pre class="brush:js;" lang="en"><span id="the-code"><span class="c">// Register for any messages our API needs us to handle
</span></span><span id="the-code"><a class="d" href="http://mxr.mozilla.org/mozilla-central/ident?i=messageManager">messageManager</a>.<a class="d" href="http://mxr.mozilla.org/mozilla-central/ident?i=addMessageListener">addMessageListener</a>(<span class="s">"SPPrefService"</span>, <span class="v">this)</span>;
</span><span id="the-code"><a class="d" href="http://mxr.mozilla.org/mozilla-central/ident?i=messageManager">messageManager</a>.<a class="d" href="http://mxr.mozilla.org/mozilla-central/ident?i=addMessageListener">addMessageListener</a>(<span class="s">"SPNumberOfScreens"</span>, <span class="v">this)</span>;</span>
</pre>

<p>Then, in the <code><span id="the-code">SpecialPowersObserver.receiveMessage</span></code> function, add a branch to handle your new message and return the result:</p>

<pre class="brush:js;" lang="en"><span id="the-code">receiveMessage: <span class="v">function(</span>aMessage) {
</span><span id="the-code"><span class="v">  switch(aMessage.name) </span>{
    <span class="v">case </span><span class="s">"SPPrefService"</span>:</span>
    // existing code...

    case "SPNumberOfScreens":
      var screenManager = Components.classes["@mozilla.org/gfx/screenmanager;1"]
                    .getService(Components.interfaces.nsIScreenManager);<span id="the-code">}
      return screenManager.numberOfScreens;

    default:
</span></pre>

<p>That's it! You will need to rebuild in the testing/mochitest directory in your object directory for your changes to show up; then you should be able to use your new <code>SpecialPowers.numberOfScreens</code> property in Mochitests.</p>

<div class="note">Don't forget to document your new API on this page after you land it!</div>