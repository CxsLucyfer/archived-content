
<h2 id="Outparamdel">Outparamdel</h2>
<p>Outparamdel converts functions to return via return value instead of an outparam. It takes a list of functions as input and rewrites the definition and call sites of those functions.</p>
<table> <caption>Rewrites Performed</caption> <tbody> <tr> <td><code style="color: rgb(37, 34, 29); font-weight: inherit;">nsresult Getter(nsIFoo **aResult) {<br> </code><code style="color: rgb(37, 34, 29); font-weight: inherit;">  *aResult = ...<br> </code><code style="color: rgb(37, 34, 29); font-weight: inherit;">  if (!*aResult)<br>     return NS_ERROR_FAILURE;</code><code style="color: rgb(37, 34, 29); font-weight: inherit;"><br> </code><code style="color: rgb(37, 34, 29); font-weight: inherit;">  return NS_OK;<br> </code><code style="color: rgb(37, 34, 29); font-weight: inherit;">}</code></td> <td> <p><code><code style="color: rgb(37, 34, 29); font-weight: inherit;">nsIFoo* Getter() {<br> </code></code><code><code style="color: rgb(37, 34, 29); font-weight: inherit;">  nsIFoo *result = NULL;<br>   // aResult below is kept for complicated cases<br>   // typically it wont be needed and can be removed <br> </code></code><code><code style="color: rgb(37, 34, 29); font-weight: inherit;">  nsIFoo **aResult = &amp;result;<br> </code></code><code><code style="color: rgb(37, 34, 29); font-weight: inherit;">  // *aResult patterns are replaced with result<br> </code><code style="color: rgb(37, 34, 29); font-weight: inherit;">  result = ...<br> </code><code style="color: rgb(37, 34, 29); font-weight: inherit;">  if (result)<br>     return nsnull; // error returns are changed to nsnull<br> </code></code><code><code style="color: rgb(37, 34, 29); font-weight: inherit;">  //instead NS_OK, actual result is returned<br> </code><code style="color: rgb(37, 34, 29); font-weight: inherit;">  return result;<br> </code>} </code></p> </td> </tr> <tr> <td> <p><code>caller1 {<br> </code><code>  //case 1<br>   nsresult rv;<br> </code><code>  rv = Getter(&amp;var);<br>   NS_ENSURE_SUCCESS(rv,rv);<br>   //case 2: naked call<br>   Getter(&amp;var);<br> </code><code>  //case 3: nsresult decl<code style="color: rgb(37, 34, 29); font-weight: inherit;"><br>   nsresult r</code><code style="color: rgb(37, 34, 29); font-weight: inherit;">v2 = Getter(&amp;var);<br>   NS_ENSURE_SUCCESS(rv2,rv2);</code><br> }</code></p> </td> <td> <p><code style="color: rgb(37, 34, 29); font-weight: inherit;">caller1 {<br> </code><code style="color: rgb(37, 34, 29); font-weight: inherit;">  // case 1<br> </code><code style="color: rgb(37, 34, 29); font-weight: inherit;">  // figure out that rv was only used for the rewritten<br>   // outparam call + NS_ENSURE_SUCCESS. Then nuke the declaration<br>   // nsresult rv;<br> </code><code style="color: rgb(37, 34, 29); font-weight: inherit;">  // move outparam to lhs<br> </code><code style="color: rgb(37, 34, 29); font-weight: inherit;">  var = Getter();<br> </code><code style="color: rgb(37, 34, 29); font-weight: inherit;">  // detect NS_ENSURE_SUCCESS immediately following<br>   // and change it to an equivalent NS_ENSURE_TRUE<br>   NS_ENSURE_TRUE(var, NS_ERROR_FAILURE);<br> </code><code style="color: rgb(37, 34, 29); font-weight: inherit;">  // case 2<br> </code><code style="color: rgb(37, 34, 29); font-weight: inherit;">  var = Getter();<br> </code><code style="color: rgb(37, 34, 29); font-weight: inherit;">  // case 3, eliminate rv2 decl given that it's not used elsewhere<br> </code><code style="color: rgb(37, 34, 29); font-weight: inherit;">  var = Getter();<br>   NS_ENSURE_TRUE(var, NS_ERROR_FAILURE)<br> }</code></p> </td> </tr> <tr> <td><code> </code></td> <td>    </td> </tr> </tbody>
</table>
<p>  Outparamdel also support rewriting getters such that they return already_AddRefed&lt;nsIFoo&gt;. In this case all of the callsites are modified to:<br>
a) getter_AddRefs case: getter(getter_AddRefs(foo)) -&gt; foo = getter()<br>
b) all other cases: getter(&amp;foo) -&gt; foo = getter().get()<br>
</p>