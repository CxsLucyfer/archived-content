<p>Mac OS X comes with a tool called <code>leaks</code>.  You can use this tool to determine the allocated memory buffers inside a program to which no existing pointer (anywhere in the stack or registers) points.  This is useful to determine possible leaks in Firefox, for example.</p>
<p>Here are some tips on how to use this tool more effectively.</p>
<h3 id="Getting_stack_traces_for_allocation_points">Getting stack traces for allocation points</h3>
<p><code>leaks</code> is capable of showing the stack trace where a leaked memory buffer was allocated.  To get stack reports, run Firefox with the <code>MallocStackLogging</code> environment variable set.</p>
<h3 id="Avoiding_false_positives">Avoiding false positives</h3>
<p>A lot of places in Gecko, we store masked pointers to allocated buffers.  For example, we might have code like this:</p>
<pre class="brush: cpp">Type* foo = new Foo();
foo = reinterpret_cast&lt;Type*&gt; (static_cast&lt;unsigned&gt; (foo | 0x1));

// Later on, when we want to use foo
Type* real = reinterpret_cast&lt;Type*&gt; (static_cast&lt;unsigned&gt; (foo) &amp; ~0x1);
</pre>
<p>In the above example, we can use the least significant bit to store a flag, for example.  Doing this causes the memory address stored in <code>foo</code> to not be mappable to any allocated block.</p>
<p>Unfortunately, <code>leaks</code> is not smart to detect these types of allocations, so you can use the <code>-exclude</code> argument to ask it to ignore some allocations.  The following is a command line I came up with which removes most of the false positives when running <code>leaks</code> on Firefox:</p>
<pre>leaks -exclude GetPropertyTreeChild -exclude js_NewRegExp -exclude InitExnPrivate -exclude 'CSSParserImpl::ParseStyleAttribute(nsAString_internal const&amp;, nsIURI*, nsIURI*, nsIPrincipal*, nsICSSStyleRule**)' -exclude 'nsAttrValue::ParseAtomArray(nsAString_internal const&amp;)' -exclude define_JavaPackage -exclude 'nsAttrValue::EnsureEmptyMiscContainer()' -exclude 'nsRuleNode::ConvertChildrenToHash()' -exclude 'nsRuleNode::Sweep()' -exclude 'nsXULDocument::AddBroadcastListenerFor(nsIDOMElement*, nsIDOMElement*, nsAString_internal const&amp;)' -exclude 'nsRuleNode::Transition(nsIStyleRule*, unsigned char, unsigned char)' -exclude ProcessCharSet -exclude 'js::PropertyTree::insertChild(JSContext*, js::Shape*, js::Shape*)' -exclude 'nsXBLProtoImplMethod::AppendBodyText(nsAString_internal const&amp;)' -exclude 'nsCSSExpandedDataBlock::Compress(nsCSSCompressedDataBlock**, nsCSSCompressedDataBlock**)' -exclude 'nsHtml5Portability::newStringFromBuffer(unsigned short*, int, int)' -exclude 'gfxMacFont::CreatePlatformShaper()' -exclude 'PICLinker::init(JSContext*)' -exclude 'js::PropertyTree::removeChild(js::Shape*)' -exclude 'NewArguments(JSContext*, JSObject*, unsigned int, JSObject&amp;)' -exclude 'nsAlertsService::Init()' -exclude 'nsXULPrototypeElement::SetAttrAt(unsigned
int, nsAString_internal const&amp;, nsIURI*)' -exclude 'nsStyledElement::ParseStyleAttribute(nsAString_internal const&amp;, nsAttrValue&amp;, int)' -exclude 'CSSStyleRuleImpl::DeclarationChanged(mozilla::css::Declaration*, int)' -exclude 'nsIDOMCSS2Properties_Set(JSContext*, JSObject*, long, int, nsCSSProperty, unsigned long long*)' -exclude 'TryToStartImageLoad(nsCSSValue const&amp;, nsIDocument*, nsCSSProperty)' -exclude 'nsIDOMCSSStyleDeclaration_SetCssText(JSContext*, JSObject*, long, int, unsigned long long*)' -exclude 'nsAttrValue::ToString(nsAString_internal&amp;) const' -exclude 'nsAttrValue::ToString(nsAString_internal&amp;) const' -exclude 'js_NewFlatClosure(JSContext*, JSFunction*, JSOp, unsigned long)' -exclude 'nsXBLProtoImplMethod::SetLineNumber(unsigned int)' -exclude 'nsXBLProtoImplMethod::AddParameter(nsAString_internal const&amp;)' -exclude TSMCurrentKeyboardInputSourceRefCreate -exclude 'nsCheapStringSet::Put(nsAString_internal const&amp;)' &lt;pid&gt;
</pre>
<p>Note that you should enter this while command in a single line, and replace &lt;pid&gt; with the PID of the Firefox process. <a href="/@api/deki/files/5308/=leakscommand.txt" title="https://developer.mozilla.org/@api/deki/files/5308/=leakscommand.txt">Click here</a> to download a plain text copy of the command.</p>