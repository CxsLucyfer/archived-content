<p><em>This article is adapted from Josh Aas's blog post Writing an NPAPI plugin for Mac OS X.</em></p>

<p>Before you go on reading this article, you may wish to grab the <a class="external" href="http://mxr.mozilla.org/mozilla2.0/source/modules/plugin/sdk/samples/basic/mac/" title="http://mxr.mozilla.org/mozilla-central/source/modules/plugin/sdk/samples/basic/mac/">sample code located here</a>, as it will be referenced during this tutorial.  The sample is posted under a <a class="external" href="http://mxr.mozilla.org/mozilla-central/source/modules/plugin/sdk/samples/basic/mac/COPYING" title="http://mxr.mozilla.org/mozilla-central/source/modules/plugin/sdk/samples/basic/mac/COPYING">BSD-style license</a> that means you can use it for anything, even if you don't plan to release your source code.</p>

<h2 id="Getting_started">Getting started</h2>

<p>If you <a class="internal" href="/En/Developer_Guide/Source_Code/Mercurial" title="en/Mozilla Source Code (Mercurial)">check out the Mozilla source code</a> in Mac OS X, you can simply open <code>BasicPlugin.xcodeproj</code> in Xcode, click Build, and you're done.  Xcode will create a "build" directory next to the project file, and if you built it in release mode, that folder in turn contains a "Release" directory with the plugin inside it.</p>

<p>To install the plugin, just copy it into one of these two locations:</p>

<ul>
 <li>/Library/Internet Plugins/</li>
 <li>~/Library/Internet Plugins/</li>
</ul>

<p>From this point, you can simply modify the sample plugin to do whatever you want.</p>

<h2 id="Notes_and_tips">Notes and tips</h2>

<p>This section provides some additional information that may be helpful if you're trying to get a plugin building on your own.</p>

<h3 id="Info.plist">Info.plist</h3>

<p>The plugin communicates its MIME and filename extension information using the <code>Info.plist</code> file, which is packaged in the plugin bundle.  The plugin also communicates its bundle type in that file, under the key <code>CFBundlePackageType</code>; the type is <code>'BRPL'</code>.  If the type isn't an NPAPI plugin type, the bundle won't load as an NPAPI plugin.  You can always just use <code>'BRPL'</code>.</p>

<h3 id="XP_MACOSX">XP_MACOSX</h3>

<p>It's important to define the GCC preprocessor definition <code>XP_MACOSX</code> to 1; this is used by the NPAPI headers to build properly on Mac OS X.  If you don't define it, they won't be interpreted correctly.  This is easy to miss in the sample project's build settings.</p>

<h3 id="Symbol_visibility">Symbol visibility</h3>

<p>Symbol visibility is a common problem for people trying to get NPAPI plugins working.  Some symbols must be visible as standard C symbols so the browser can find them, which means they need to be prefixed by an underscore, and must not have the C++ obfuscation that is generated by the C++ compiler.</p>

<p>The three symbols that must always be visible are:</p>

<ul>
 <li><code>NP_Initialize()</code></li>
 <li><code>NP_GetEntryPoints()</code></li>
 <li><code>NP_Shutdown()</code></li>
</ul>

<p>The sample plugin is written entirely in C, using a standard Xcode build configuration, so by default all of its symbols are C-style and visible.</p>

<p>If you want to implement your plugin in C++ or Objective-C++, you need to tell the compiler to export them in C format by using <code>extern "C"</code> in the header, like this:</p>

<pre>#pragma GCC visibility push(default)

extern "C" {
  NPError NP_Initialize(NPNetscapeFuncs *browserFuncs);
  NPError NP_GetEntryPoints(NPPluginFuncs *pluginFuncs);
  void NP_Shutdown(void);
}

#pragma GCC visibility pop
</pre>

<p>You can check to be sure your symbols are visible and in standard C format by using the nm utility provided among the Mac OS X developer tools:</p>

<pre>[user@foo MyMac] nm BasicPlugin

...
00000810 T _NP_GetEntryPoints
000007fa T _NP_Initialize
000008a0 T _NP_Shutdown
</pre>

<h2 id="See_also">See also</h2>

<ul>
 <li><a class="internal" href="/en/Gecko_Plugin_API_Reference" title="En/Gecko Plugin API Reference">Gecko Plug-in API Reference</a></li>
 <li><a class="internal" href="/en/Plugins" title="En/Plugins">Plugins</a></li>
 <li><a class="external" href="http://www.firebreath.org/display/documentation/Mac+Plugins" title="Building a Mac NPAPI Plugin with FireBreath">Building a Mac NPAPI Plugin with FireBreath</a></li>
</ul>

<div class="originaldocinfo">
<h2 id="Original_Document_Information" name="Original_Document_Information">Original Document Information</h2>

<ul>
 <li>Author(s): Josh Aas</li>
 <li>Last Updated Date: October 24, 2008</li>
</ul>
</div>