---
title: Storing annotations
slug: Archive/Add-ons/Add-on_SDK/Tutorials/Annotator/Storing_annotations
tags:
  - Add-on SDK
---
<p>Â </p>

<div class="warning notecard">
<p>Support for extensions using XUL/XPCOM or the Add-on SDK was removed in Firefox 57, released November 2017. As there is no supported version of Firefox enabling these technologies, this page will be removed by December 2020.</p>

<p>Add-ons using the techniques described in this document are considered a legacy technology in Firefox. Don&apos;t use these techniques to develop new add-ons. Use <a href="/en-US/Add-ons/WebExtensions">WebExtensions</a> instead. If you maintain an add-on which uses the techniques described here, consider migrating it to use WebExtensions.</p>

<p><strong>Starting from <a href="https://wiki.mozilla.org/RapidRelease/Calendar">Firefox 53</a>, no new legacy add-ons will be accepted on addons.mozilla.org (AMO) for desktop Firefox and Firefox for Android.</strong></p>

<p><strong>Starting from <a href="https://wiki.mozilla.org/RapidRelease/Calendar">Firefox 57</a>, only extensions developed using WebExtensions APIs will be supported on Desktop Firefox and Firefox for Android. </strong></p>

<p>Even before Firefox 57, changes coming up in the Firefox platform will break many legacy extensions. These changes include multiprocess Firefox (e10s), sandboxing, and multiple content processes. Legacy extensions that are affected by these changes should migrate to use WebExtensions APIs if they can. See the <a href="https://blog.mozilla.org/addons/2017/02/16/the-road-to-firefox-57-compatibility-milestones/">&quot;Compatibility Milestones&quot; document</a> for more information.</p>

<p>A wiki page containing <a href="https://wiki.mozilla.org/Add-ons/developer/communication">resources, migration paths, office hours, and more</a>, is available to help developers transition to the new technologies.</p>
</div>

<section class="Quick_links" id="Quick_Links">
<ol>
 <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions"><strong>Browser extensions</strong></a></li>
 <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions#Getting_started">Getting started</a>
  <ol>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/What_are_WebExtensions">What are extensions?</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Your_first_WebExtension">Your first extension</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Your_second_WebExtension">Your second extension</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Anatomy_of_a_WebExtension">Anatomy of an extension</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Examples">Example extensions</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/What_next_">What next?</a></li>
  </ol>
 </li>
 <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions#Concepts">Concepts</a>
  <ol>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Using_the_JavaScript_APIs">Using the JavaScript APIs</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Content_scripts">Content scripts</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Match_patterns">Match patterns</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Working_with_files">Working with files</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Internationalization">Internationalization</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Security_best_practices">Security best practices</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Content_Security_Policy">Content Security Policy</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Native_messaging">Native messaging</a></li>
  </ol>
 </li>
 <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions#User_Interface">User interface</a>
  <ol>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/user_interface">User Interface</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/user_interface/Browser_action">Toolbar button</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/user_interface/Page_actions">Address bar button</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/user_interface/Sidebars">Sidebars</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/user_interface/Context_menu_items">Context menu items</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/user_interface/Options_pages">Options page</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/user_interface/Extension_pages">Extension pages</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/user_interface/Notifications">Notifications</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/user_interface/Omnibox">Address bar suggestions</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/user_interface/devtools_panels">Developer tools panels</a></li>
  </ol>
 </li>
 <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions#How_to">How to</a>
  <ol>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Intercept_HTTP_requests">Intercept HTTP requests</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Modify_a_web_page">Modify a web page</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Safely_inserting_external_content_into_a_page">Insert external content</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Add_a_button_to_the_toolbar">Add a button to the toolbar</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Implement_a_settings_page">Implement a settings page</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Working_with_the_Tabs_API">Work with the Tabs API</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Work_with_the_Bookmarks_API">Work with the Bookmarks API</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Work_with_the_Cookies_API">Work with the Cookies API</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Work_with_contextual_identities">Work with contextual identities</a></li>
  </ol>
 </li>
 <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions#Porting">Porting</a>
  <ol>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Porting_a_Google_Chrome_extension">Porting a Google Chrome extension</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Porting_a_legacy_Firefox_add-on">Porting a legacy Firefox extension</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Embedded_WebExtensions">Embedded WebExtensions</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Comparison_with_the_Add-on_SDK">Comparison with the Add-on SDK</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Comparison_with_XUL_XPCOM_extensions">Comparison with XUL/XPCOM extensions</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Chrome_incompatibilities">Chrome incompatibilities</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Differences_between_desktop_and_Android">Differences between desktop and Android</a></li>
  </ol>
 </li>
 <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions#Firefox_workflow">Firefox workflow</a>
  <ol>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/User_experience_best_practices">User Experience</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Temporary_Installation_in_Firefox">Temporary Installation in Firefox</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Debugging">Debugging</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Testing_persistent_and_restart_features">Testing persistent and restart features</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Developing_WebExtensions_for_Firefox_for_Android">Developing for Firefox for Android</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Getting_started_with_web-ext">Getting started with web-ext</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/web-ext_command_reference">web-ext command reference</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/WebExtensions_and_the_Add-on_ID">Extensions and the Add-on ID</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Request_the_right_permissions">Request the right permissions</a></li>
  </ol>
 </li>
 <li data-default-state="closed"><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API">JavaScript APIs</a>
  <ol>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Browser_support_for_JavaScript_APIs">Browser support for JavaScript APIs</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/alarms">alarms</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/bookmarks">bookmarks</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/browserAction">browserAction</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/browserSettings">browserSettings</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/browsingData">browsingData</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/clipboard">clipboard</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/commands">commands</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/contentScripts">contentScripts</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/contextualIdentities">contextualIdentities</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/cookies">cookies</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/devtools.inspectedWindow">devtools.inspectedWindow</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/devtools.network">devtools.network</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/devtools.panels">devtools.panels</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/dns">dns</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/downloads">downloads</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/events">events</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/extension">extension</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/extensionTypes">extensionTypes</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/find">find</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/history">history</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/i18n">i18n</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/identity">identity</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/idle">idle</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/management">management</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/menus">menus</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/notifications">notifications</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/omnibox">omnibox</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/pageAction">pageAction</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/permissions">permissions</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/pkcs11">pkcs11</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/privacy">privacy</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/proxy">proxy</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/runtime">runtime</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/search">search</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/sessions">sessions</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/sidebarAction">sidebarAction</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/storage">storage</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs">tabs</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/theme">theme</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/topSites">topSites</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/types">types</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/webNavigation">webNavigation</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/webRequest">webRequest</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/windows">windows</a></li>
  </ol>
 </li>
 <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json">Manifest keys</a>
  <ol>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/applications">applications</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/author">author</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/background">background</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/browser_action">browser_action</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/chrome_settings_overrides">chrome_settings_overrides</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/chrome_url_overrides">chrome_url_overrides</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/commands">commands</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/content_scripts">content_scripts</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/content_security_policy">content_security_policy</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/default_locale">default_locale</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/description">description</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/developer">developer</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/devtools_page">devtools_page</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/homepage_url">homepage_url</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/icons">icons</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/incognito">incognito</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/manifest_version">manifest_version</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/name">name</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/omnibox">omnibox</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/optional_permissions">optional_permissions</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/options_ui">options_ui</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/page_action">page_action</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions">permissions</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/protocol_handlers">protocol_handlers</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/short_name">short_name</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/sidebar_action">sidebar_action</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/theme">theme</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/version">version</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/version_name">version_name</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/web_accessible_resources">web_accessible_resources</a></li>
  </ol>
 </li>
 <li><a href="/en-US/docs/Mozilla/Add-ons/Themes"><strong>Themes</strong></a></li>
 <li><a href="/en-US/docs/Mozilla/Add-ons/Themes/Theme_concepts">Browser themes</a>
  <ol>
   <li><a href="/en-US/docs/Mozilla/Add-ons/Themes/Theme_concepts">Browser theme concepts</a></li>
  </ol>
 </li>
 <li><a href="/en-US/docs/Mozilla/Add-ons/Themes/Lightweight_themes">Lightweight themes</a>
  <ol>
   <li><a href="/en-US/docs/Mozilla/Add-ons/Themes/Lightweight_themes">Lightweight themes</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/Themes/Lightweight_Themes/FAQ">Lightweight themes FAQ</a></li>
  </ol>
 </li>
 <li><a href="/en-US/docs/Mozilla/Add-ons/Distribution"><strong>Publishing and Distribution</strong></a></li>
 <li><a href="/en-US/docs/Mozilla/Add-ons/Distribution">Publishing add-ons</a>
  <ol>
   <li><a href="/en-US/docs/Mozilla/Add-ons/Distribution">Signing and distribution overview</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Package_your_extension_">Package your extension</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/Distribution/Submitting_an_add-on">Submit an add-on</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/Source_Code_Submission">Source code submission</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/Distribution/Resources_for_publishers">Resources for publishers</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/Listing">Creating an appealing listing</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/AMO/Policy/Reviews">Review policies</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/AMO/Policy/Agreement">Developer agreement</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/AMO/Policy/Featured">Featured add-ons</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/Distribution/Retiring_your_extension">Retiring your extension</a></li>
  </ol>
 </li>
 <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Alternative_distribution_options">Distributing add-ons</a>
  <ol>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Alternative_distribution_options/Sideloading_add-ons">For sideloading</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Alternative_distribution_options/Add-ons_for_desktop_apps">For desktop apps</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Alternative_distribution_options/Add-ons_in_the_enterprise">For an enterprise</a></li>
  </ol>
 </li>
 <li><a href="https://discourse.mozilla.org/c/add-ons"><strong>Community and Support</strong></a></li>
 <li><a href="#">Channels</a>
  <ol>
   <li><a href="https://blog.mozilla.org/addons">Add-ons blog</a></li>
   <li><a href="https://discourse.mozilla.org/c/add-ons">Add-on forums</a></li>
   <li><a href="http://stackoverflow.com/questions/tagged/firefox-addon">Stack Overflow</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/#Contact_us">Contact us</a></li>
  </ol>
 </li>
</ol>
</section>

<p>Â </p>

<div class="warning notecard">
<p>Deprecated in Firefox 29 and removed in Firefox 38.</p>

<p>Warning: this tutorial relies on the since-removed Widget API and no longer works with Firefox.</p>

<p>The widget API is deprecated from Firefox 29 onwards. Please see the <a href="/en-US/Add-ons/SDK/High-Level_APIs/ui">ui module</a> for replacements. In particular, for a simple button, try the <a href="/en-US/Add-ons/SDK/High-Level_APIs/ui#ActionButton">action button</a> or <a href="/en-US/Add-ons/SDK/High-Level_APIs/ui#ToggleButton">toggle button</a> APIs, and for a more complex widget try the <a href="/en-US/Add-ons/SDK/High-Level_APIs/ui#Toolbar">toolbar</a> or <a href="/en-US/Add-ons/SDK/High-Level_APIs/ui#Sidebar">sidebar</a> APIs.</p>
</div>

<p>Now we are able to create annotations, let&apos;s store them using the <a href="/en-US/Add-ons/SDK/High-Level_APIs/simple-storage"><code>simple-storage</code></a> module. In this chapter we will cover three topics relating to persistent storage:</p>

<ul>
 <li>using <code>simple-storage</code> to persist objects</li>
 <li>handling exhaustion of the storage quota allocated to you</li>
 <li>respecting Private Browsing</li>
</ul>

<h2 id="Storing_New_Annotations">Storing New Annotations</h2>

<p>In this section we are only touching the <code>main.js</code> file.</p>

<p>First, import the <code>simple-storage</code> module with a declaration like:</p>

<pre class="brush: js">var simpleStorage = require(&apos;sdk/simple-storage&apos;);</pre>

<p>In the module scope, initialize an array which will contain the stored annotations:</p>

<pre class="brush: js">if (!simpleStorage.storage.annotations)
  simpleStorage.storage.annotations = [];</pre>

<p>Now we&apos;ll add a function to the module scope which deals with a new annotation. The annotation is composed of the text the user entered and the &quot;annotation anchor&quot;, which consists of the URL, element ID and element content:</p>

<pre class="brush: js">function handleNewAnnotation(annotationText, anchor) {
  var newAnnotation = new Annotation(annotationText, anchor);
  simpleStorage.storage.annotations.push(newAnnotation);
}</pre>

<p>This function calls a constructor for an <code>Annotation</code> object, which we also need to supply:</p>

<pre class="brush: js">function Annotation(annotationText, anchor) {
  this.annotationText = annotationText;
  this.url = anchor[0];
  this.ancestorId = anchor[1];
  this.anchorText = anchor[2];
}</pre>

<p>Now we need to link this code to the annotation editor, so that when the user presses the return key in the editor, we create and store the new annotation:</p>

<pre class="brush: js">var annotationEditor = panels.Panel({
  width: 220,
  height: 220,
  contentURL: data.url(&apos;editor/annotation-editor.html&apos;),
  contentScriptFile: data.url(&apos;editor/annotation-editor.js&apos;),
  onMessage: function(annotationText) {
    if (annotationText)
      handleNewAnnotation(annotationText, this.annotationAnchor);
    annotationEditor.hide();
  },
  onShow: function() {
    this.postMessage(&apos;focus&apos;);
  }
});</pre>

<h2 id="Listing_Stored_Annotations">Listing Stored Annotations</h2>

<p>To prove that this works, let&apos;s implement the part of the add-on that displays all the previously entered annotations. This is implemented as a panel that&apos;s shown in response to the widget&apos;s <code>right-click</code> message.</p>

<p>The panel has three new files associated with it:</p>

<ul>
 <li>a content-script which builds the panel content</li>
 <li>a simple HTML file used as a template for the panel&apos;s content</li>
 <li>a simple CSS file to provide some basic styling.</li>
</ul>

<p>These three files can all go in a new subdirectory of <code>data</code> which we will call <code>list</code>.</p>

<h3 id="Annotation_List_Content_Script">Annotation List Content Script</h3>

<p>Here&apos;s the annotation list&apos;s content script:</p>

<pre class="brush: js">self.on(&quot;message&quot;, function onMessage(storedAnnotations) {
  var annotationList = $(&apos;#annotation-list&apos;);
  annotationList.empty();
  storedAnnotations.forEach(
    function(storedAnnotation) {
      var annotationHtml = $(&apos;#template .annotation-details&apos;).clone();
      annotationHtml.find(&apos;.url&apos;).text(storedAnnotation.url)
                                 .attr(&apos;href&apos;, storedAnnotation.url);
      annotationHtml.find(&apos;.url&apos;).bind(&apos;click&apos;, function(event) {
        event.stopPropagation();
        event.preventDefault();
        self.postMessage(storedAnnotation.url);
      });
      annotationHtml.find(&apos;.selection-text&apos;)
                    .text(storedAnnotation.anchorText);
      annotationHtml.find(&apos;.annotation-text&apos;)
                    .text(storedAnnotation.annotationText);
      annotationList.append(annotationHtml);
    });
});</pre>

<p>It builds the DOM for the panel from the array of annotations it is given.</p>

<p>The user will be able to click links in the panel, but we want to open them in the main browser window rather than the panel. So the content script binds a click handler to the links which will send the URL to the add-on.</p>

<p>Save this file in <code>data/list</code> as <code>annotation-list.js</code>.</p>

<h3 id="Annotation_List_HTML_and_CSS">Annotation List HTML and CSS</h3>

<p>Here&apos;s the HTML for the annotation list:</p>

<pre class="brush: html">&lt;html&gt;
&lt;head&gt;
  &lt;meta http-equiv=&quot;Content-type&quot; content=&quot;text/html; charset=utf-8&quot; /&gt;
  &lt;title&gt;Saved annotations&lt;/title&gt;
  &lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;annotation-list.css&quot; /&gt;
&lt;/head&gt;

&lt;body&gt;

&lt;div id=&quot;annotation-list&quot;&gt;
&lt;/div&gt;

&lt;div id=&quot;template&quot;&gt;
  &lt;div class=&quot;annotation-details&quot;&gt;
    &lt;a class=&quot;url&quot;&gt;&lt;/a&gt;
    &lt;div class=&quot;selection-text&quot;&gt;&lt;/div&gt;
    &lt;div class=&quot;annotation-text&quot;&gt;&lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;

&lt;/body&gt;

&lt;/html&gt;

</pre>

<p>Here&apos;s the corresponding CSS:</p>

<pre class="brush: js">#annotation-list .annotation-details
  {
  padding: 10px;
  margin: 10px;
  border: solid 3px #EEE;
  background-color: white;
  }

#annotation-list .url, .selection-text, .annotation-text
  {
  padding: 5px;
  margin: 5px;
  }

#annotation-list .selection-text,#annotation-list .annotation-text
  {
  border: solid 1px #EEE;
  }

#annotation-list .annotation-text
  {
  font-style: italic;
  }

body
  {
  background-color: #F5F5F5;
  font: 100% arial, helvetica, sans-serif;
  }

h1
  {
  font-family: georgia,serif;
  font-size: 1.5em;
  text-align:center;
  }
</pre>

<p>Save these in <code>data/list</code> as <code>annotation-list.html</code> and <code>annotation-list.css</code> respectively.</p>

<h3 id="Updating_main.js">Updating main.js</h3>

<p>Here&apos;s the code to create the panel, which can go in the <code>main</code> function.</p>

<pre class="brush: js">var annotationList = panels.Panel({
  width: 420,
  height: 200,
  contentURL: data.url(&apos;list/annotation-list.html&apos;),
  contentScriptFile: [data.url(&apos;jquery-1.4.2.min.js&apos;),
                      data.url(&apos;list/annotation-list.js&apos;)],
  contentScriptWhen: &apos;ready&apos;,
  onShow: function() {
    this.postMessage(simpleStorage.storage.annotations);
  },
  onMessage: function(message) {
    require(&apos;sdk/tabs&apos;).open(message);
  }
});</pre>

<p>Since this panel&apos;s content script uses jQuery we will pass that in too: again, make sure the name of it matches the version of jQuery you downloaded.</p>

<p>When the panel is shown we send it the array of stored annotations. When the panel sends us a URL we use the <code>tabs</code> module to open it in a new tab.</p>

<p>Finally we need to connect this to the widget&apos;s <code>right-click</code> message:</p>

<pre class="brush: js">var widget = widgets.Widget({
  id: &apos;toggle-switch&apos;,
  label: &apos;Annotator&apos;,
  contentURL: data.url(&apos;widget/pencil-off.png&apos;),
  contentScriptWhen: &apos;ready&apos;,
  contentScriptFile: data.url(&apos;widget/widget.js&apos;)
});

widget.port.on(&apos;left-click&apos;, function() {
  console.log(&apos;activate/deactivate&apos;);
  widget.contentURL = toggleActivation() ?
            data.url(&apos;widget/pencil-on.png&apos;) :
            data.url(&apos;widget/pencil-off.png&apos;);
});

widget.port.on(&apos;right-click&apos;, function() {
    console.log(&apos;show annotation list&apos;);
    annotationList.show();
});</pre>

<p>This time execute <code>cfx xpi</code> to build the XPI for the add-on, and install it in Firefox. Activate the add-on, add an annotation, and then right-click the widget. You should see something like this:</p>

<p><img alt src="https://mdn.mozillademos.org/files/6685/annotation-list.png" style="display: block; margin-left: auto; margin-right: auto;"></p>

<p>Restart Firefox, right-click the widget again, and check that the annotation is still there.</p>

<p>Until now we&apos;ve always run <code>cfx run</code> rather than building an XPI and installing the add-on in Firefox. If the annotation does not reappear when you restart Firefox, double check you installed the add-on and didn&apos;t just use <code>cfx run</code> again.</p>

<h2 id="Responding_To_OverQuota_events">Responding To OverQuota events</h2>

<p>Add-ons have a limited quota of storage space. If the add-on exits while it is over quota, any data stored since the last time it was in quota will not be persisted.</p>

<p>So we want to listen to the <code>OverQuota</code> event emitted by <code>simple-storage</code> and respond to it. Add the following to your add-on&apos;s <code>main</code> function:</p>

<pre class="brush: js">simpleStorage.on(&quot;OverQuota&quot;, function () {
  notifications.notify({
    title: &apos;Storage space exceeded&apos;,
    text: &apos;Removing recent annotations&apos;});
  while (simpleStorage.quotaUsage &gt; 1)
    simpleStorage.storage.annotations.pop();
});</pre>

<p>Because we use a notification to alert the user, we need to import the <code>notifications</code> module:</p>

<pre class="brush: js">var notifications = require(&quot;sdk/notifications&quot;);</pre>

<p>(It should be obvious that this is an incredibly unhelpful way to deal with the problem. A real add-on should give the user a chance to choose which data to keep, and prevent the user from adding any more data until the add-on is back under quota.)</p>

<h2 id="Respecting_Private_Browsing">Respecting Private Browsing</h2>

<p>Since annotations record the user&apos;s browsing history we should avoid recording annotations in private windows.</p>

<p>There&apos;s a very simple way to do this: do nothing. By omitting the <a href="/en-US/Add-ons/SDK/Tools/package_json#permissions"><code>&quot;private-browsing&quot;</code> key</a> from the annotator&apos;s &quot;package.json&quot; file, the annotator opts out of private browsing altogether.</p>

<p>This means that its widget will not appear on any private windows and its selector and matcher content scripts won&apos;t run, so the user won&apos;t be able to enter any annotations in private windows.</p>

<p>Try it: execute cfx run and open a new private window: you should no longer see the annotator&apos;s widget.</p>

<p>Now we can create and store annotations, the last piece is to <a href="/en-US/Add-ons/SDK/Tutorials/Annotator/Displaying_annotations">display them when the user loads the page</a>.</p>
