---
title: 'Chapter 5: Let''s build a Firefox extension'
slug: >-
  Archive/Add-ons/Overlay_Extensions/Firefox_addons_developer_guide/Let's_build_a_Firefox_extension
tags:
  - Archive
  - Obsolete
---
<p>Â </p>

<section class="Quick_links" id="Quick_Links">
<ol>
 <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions"><strong>Browser extensions</strong></a></li>
 <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions#Getting_started">Getting started</a>
  <ol>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/What_are_WebExtensions">What are extensions?</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Your_first_WebExtension">Your first extension</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Your_second_WebExtension">Your second extension</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Anatomy_of_a_WebExtension">Anatomy of an extension</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Examples">Example extensions</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/What_next_">What next?</a></li>
  </ol>
 </li>
 <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions#Concepts">Concepts</a>
  <ol>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Using_the_JavaScript_APIs">Using the JavaScript APIs</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Content_scripts">Content scripts</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Match_patterns">Match patterns</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Working_with_files">Working with files</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Internationalization">Internationalization</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Security_best_practices">Security best practices</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Content_Security_Policy">Content Security Policy</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Native_messaging">Native messaging</a></li>
  </ol>
 </li>
 <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions#User_Interface">User interface</a>
  <ol>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/user_interface">User Interface</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/user_interface/Browser_action">Toolbar button</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/user_interface/Page_actions">Address bar button</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/user_interface/Sidebars">Sidebars</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/user_interface/Context_menu_items">Context menu items</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/user_interface/Options_pages">Options page</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/user_interface/Extension_pages">Extension pages</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/user_interface/Notifications">Notifications</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/user_interface/Omnibox">Address bar suggestions</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/user_interface/devtools_panels">Developer tools panels</a></li>
  </ol>
 </li>
 <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions#How_to">How to</a>
  <ol>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Intercept_HTTP_requests">Intercept HTTP requests</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Modify_a_web_page">Modify a web page</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Safely_inserting_external_content_into_a_page">Insert external content</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Add_a_button_to_the_toolbar">Add a button to the toolbar</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Implement_a_settings_page">Implement a settings page</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Working_with_the_Tabs_API">Work with the Tabs API</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Work_with_the_Bookmarks_API">Work with the Bookmarks API</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Work_with_the_Cookies_API">Work with the Cookies API</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Work_with_contextual_identities">Work with contextual identities</a></li>
  </ol>
 </li>
 <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions#Porting">Porting</a>
  <ol>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Porting_a_Google_Chrome_extension">Porting a Google Chrome extension</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Porting_a_legacy_Firefox_add-on">Porting a legacy Firefox extension</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Embedded_WebExtensions">Embedded WebExtensions</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Comparison_with_the_Add-on_SDK">Comparison with the Add-on SDK</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Comparison_with_XUL_XPCOM_extensions">Comparison with XUL/XPCOM extensions</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Chrome_incompatibilities">Chrome incompatibilities</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Differences_between_desktop_and_Android">Differences between desktop and Android</a></li>
  </ol>
 </li>
 <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions#Firefox_workflow">Firefox workflow</a>
  <ol>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/User_experience_best_practices">User Experience</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Temporary_Installation_in_Firefox">Temporary Installation in Firefox</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Debugging">Debugging</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Testing_persistent_and_restart_features">Testing persistent and restart features</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Developing_WebExtensions_for_Firefox_for_Android">Developing for Firefox for Android</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Getting_started_with_web-ext">Getting started with web-ext</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/web-ext_command_reference">web-ext command reference</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/WebExtensions_and_the_Add-on_ID">Extensions and the Add-on ID</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Request_the_right_permissions">Request the right permissions</a></li>
  </ol>
 </li>
 <li data-default-state="closed"><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API">JavaScript APIs</a>
  <ol>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Browser_support_for_JavaScript_APIs">Browser support for JavaScript APIs</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/alarms">alarms</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/bookmarks">bookmarks</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/browserAction">browserAction</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/browserSettings">browserSettings</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/browsingData">browsingData</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/clipboard">clipboard</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/commands">commands</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/contentScripts">contentScripts</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/contextualIdentities">contextualIdentities</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/cookies">cookies</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/devtools.inspectedWindow">devtools.inspectedWindow</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/devtools.network">devtools.network</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/devtools.panels">devtools.panels</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/dns">dns</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/downloads">downloads</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/events">events</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/extension">extension</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/extensionTypes">extensionTypes</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/find">find</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/history">history</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/i18n">i18n</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/identity">identity</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/idle">idle</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/management">management</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/menus">menus</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/notifications">notifications</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/omnibox">omnibox</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/pageAction">pageAction</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/permissions">permissions</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/pkcs11">pkcs11</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/privacy">privacy</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/proxy">proxy</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/runtime">runtime</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/search">search</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/sessions">sessions</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/sidebarAction">sidebarAction</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/storage">storage</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs">tabs</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/theme">theme</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/topSites">topSites</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/types">types</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/webNavigation">webNavigation</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/webRequest">webRequest</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/windows">windows</a></li>
  </ol>
 </li>
 <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json">Manifest keys</a>
  <ol>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/applications">applications</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/author">author</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/background">background</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/browser_action">browser_action</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/chrome_settings_overrides">chrome_settings_overrides</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/chrome_url_overrides">chrome_url_overrides</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/commands">commands</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/content_scripts">content_scripts</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/content_security_policy">content_security_policy</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/default_locale">default_locale</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/description">description</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/developer">developer</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/devtools_page">devtools_page</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/homepage_url">homepage_url</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/icons">icons</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/incognito">incognito</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/manifest_version">manifest_version</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/name">name</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/omnibox">omnibox</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/optional_permissions">optional_permissions</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/options_ui">options_ui</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/page_action">page_action</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions">permissions</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/protocol_handlers">protocol_handlers</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/short_name">short_name</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/sidebar_action">sidebar_action</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/theme">theme</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/version">version</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/version_name">version_name</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/web_accessible_resources">web_accessible_resources</a></li>
  </ol>
 </li>
 <li><a href="/en-US/docs/Mozilla/Add-ons/Themes"><strong>Themes</strong></a></li>
 <li><a href="/en-US/docs/Mozilla/Add-ons/Themes/Theme_concepts">Browser themes</a>
  <ol>
   <li><a href="/en-US/docs/Mozilla/Add-ons/Themes/Theme_concepts">Browser theme concepts</a></li>
  </ol>
 </li>
 <li><a href="/en-US/docs/Mozilla/Add-ons/Themes/Lightweight_themes">Lightweight themes</a>
  <ol>
   <li><a href="/en-US/docs/Mozilla/Add-ons/Themes/Lightweight_themes">Lightweight themes</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/Themes/Lightweight_Themes/FAQ">Lightweight themes FAQ</a></li>
  </ol>
 </li>
 <li><a href="/en-US/docs/Mozilla/Add-ons/Distribution"><strong>Publishing and Distribution</strong></a></li>
 <li><a href="/en-US/docs/Mozilla/Add-ons/Distribution">Publishing add-ons</a>
  <ol>
   <li><a href="/en-US/docs/Mozilla/Add-ons/Distribution">Signing and distribution overview</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Package_your_extension_">Package your extension</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/Distribution/Submitting_an_add-on">Submit an add-on</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/Source_Code_Submission">Source code submission</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/Distribution/Resources_for_publishers">Resources for publishers</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/Listing">Creating an appealing listing</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/AMO/Policy/Reviews">Review policies</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/AMO/Policy/Agreement">Developer agreement</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/AMO/Policy/Featured">Featured add-ons</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/Distribution/Retiring_your_extension">Retiring your extension</a></li>
  </ol>
 </li>
 <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Alternative_distribution_options">Distributing add-ons</a>
  <ol>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Alternative_distribution_options/Sideloading_add-ons">For sideloading</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Alternative_distribution_options/Add-ons_for_desktop_apps">For desktop apps</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/Alternative_distribution_options/Add-ons_in_the_enterprise">For an enterprise</a></li>
  </ol>
 </li>
 <li><a href="https://discourse.mozilla.org/c/add-ons"><strong>Community and Support</strong></a></li>
 <li><a href="#">Channels</a>
  <ol>
   <li><a href="https://blog.mozilla.org/addons">Add-ons blog</a></li>
   <li><a href="https://discourse.mozilla.org/c/add-ons">Add-on forums</a></li>
   <li><a href="http://stackoverflow.com/questions/tagged/firefox-addon">Stack Overflow</a></li>
   <li><a href="/en-US/docs/Mozilla/Add-ons/#Contact_us">Contact us</a></li>
  </ol>
 </li>
</ol>
</section>

<p>Â </p>

<p>Â </p>

<div class="warning">
<p>Support for extensions using XUL/XPCOM or the Add-on SDK was removed in Firefox 57, released November 2017. As there is no supported version of Firefox enabling these technologies, this page will be removed by December 2020.</p>

<p>Add-ons using the techniques described in this document are considered a legacy technology in Firefox. Don't use these techniques to develop new add-ons. Use <a href="/en-US/Add-ons/WebExtensions">WebExtensions</a> instead. If you maintain an add-on which uses the techniques described here, consider migrating it to use WebExtensions.</p>

<p><strong>Starting from <a href="https://wiki.mozilla.org/RapidRelease/Calendar">Firefox 53</a>, no new legacy add-ons will be accepted on addons.mozilla.org (AMO) for desktop Firefox and Firefox for Android.</strong></p>

<p><strong>Starting from <a href="https://wiki.mozilla.org/RapidRelease/Calendar">Firefox 57</a>, only extensions developed using WebExtensions APIs will be supported on Desktop Firefox and Firefox for Android. </strong></p>

<p>Even before Firefox 57, changes coming up in the Firefox platform will break many legacy extensions. These changes include multiprocess Firefox (e10s), sandboxing, and multiple content processes. Legacy extensions that are affected by these changes should migrate to use WebExtensions APIs if they can. See the <a href="https://blog.mozilla.org/addons/2017/02/16/the-road-to-firefox-57-compatibility-milestones/">"Compatibility Milestones" document</a> for more information.</p>

<p>A wiki page containing <a href="https://wiki.mozilla.org/Add-ons/developer/communication">resources, migration paths, office hours, and more</a>, is available to help developers transition to the new technologies.</p>
</div>

<p>Â </p>

<p>Â </p>

<div class="overheadIndicator obsolete obsoleteHeader">
<p><strong>Obsolete</strong><br>
 This feature is obsolete. Although it may still work in some browsers, its use is discouraged since it could be removed at any time. Try to avoid using it.</p>
</div>

<div class="overheadIndicator draft">
<p><strong>Draft</strong><br>
 This page is not complete.</p>
</div>

<p>Â </p>

<p>Â </p>

<div class="prevnext" style="text-align: right;">
<p><a href="/en-US/docs/Firefox_addons_developer_guide/Using_XPCOMâImplementing_advanced_processes" style="float: left;">Â« Previous</a><a href="/en-US/docs/Firefox_addons_developer_guide/Firefox_extensions_and_XUL_applications">Next Â»</a></p>
</div>

<p>Â </p>

<p><em>This document was authored by </em><a class="external" href="http://www.xuldev.org/blog/" title="http://www.xuldev.org/blog/"><span class="external"><em>Taiga (Gomita) Gomibuchi</em></span></a><em> and was originally published in Japanese for the </em><a class="link-https" href="https://wiki.mozilla.org/Japan/FxDevCon/Summer2007/English" rel="external nofollow" title="https://wiki.mozilla.org/Japan/FxDevCon/Summer2007/English"><em>Firefox Developers Conference Summer 2007</em></a><em>. Gomita-san won "Most Useful Upgraded Extension" award in Mozilla's 2006 "Extend Firefox" competition for <a class="external" href="http://amb.vis.ne.jp/mozilla/scrapbook/" title="http://amb.vis.ne.jp/mozilla/scrapbook/">ScrapBook</a>, and was runner-up in the "Extend Firefox 2" contest for <a class="external" href="http://www.xuldev.org/firegestures/" title="http://www.xuldev.org/firegestures/">FireGestures</a>.</em></p>

<p>The chapters so far have each focused on technologies in isolationâXUL, JavaScript, CSS, and XPCOM. In this chapter, weâll discuss how to put them together to actually build an extension.</p>

<p><em>An easier method of building a Firefox/Thunderbird Addon for developers who are well-acquainted with IDEs like Netbeans, Eclipse, etc. is to use Netbeans (IDE from Sun Microsystems) and <a href="http://plugins.netbeans.org/plugin/4209/foxbeans-develop-firefox-addons-in-netbeans">Foxbeans</a> (Plugin for Netbeans, by TeeSoft). </em></p>

<h2 id="Setting_up_your_development_environment">Setting up your development environment</h2>

<p>In order to develop (and test) extensions in a most convenient way it is recommended to apply some changes to Firefox. In the following you will find a brief description how to do so; a more detailed one can be found under <a class="internal" href="/en/Setting_up_extension_development_environment" title="en/Setting up extension development environment">Setting up an extension development environment</a>.</p>

<h3 id="Create_a_development_profile">Create a development profile</h3>

<p>If you want to partition your everyday browsing environment from your development environment in Firefox, set up a second profile for development. To create this <code>dev</code> profile start Firefox with</p>

<pre>firefox.exe -no-remote -P dev</pre>

<p>On the first start the Profile Manager will appear, where you can create the <code>dev</code> profile and configure its home-path.</p>

<h3 id="Change_your_preferences_for_more_efficient_development">Change your preferences for more efficient development</h3>

<p>Before you get to work developing your extension, youâll want to change some of your Firefox preferences. This isnât a requirement for extension development, but I recommend it as a way to work more efficiently.</p>

<table class="standard-table" style="height: 321px; width: 1228px;">
 <thead>
  <tr>
   <th scope="col">Preference</th>
   <th scope="col">Description</th>
   <th scope="col">Value</th>
  </tr>
 </thead>
 <tbody>
  <tr>
   <td>
    <p>nglayout.debug.disable_xul_cache (not present in Firefox 3.5+)</p>
   </td>
   <td>Ordinarily, Firefox will cache XUL documents after they have been read in once, to speed subsequent displays. Disabling this cache forces XUL documents to be reloaded any every time they are displayed.</td>
   <td>True</td>
  </tr>
  <tr>
   <td>
    <p>browser.dom.window.dump.enabled (not present in Firefox 3.5+)</p>
   </td>
   <td>Enables use of the dump method for debugging. Refer to the âJavaScript debugging methodsâ sidebar.</td>
   <td>True</td>
  </tr>
  <tr>
   <td>
    <p>javascript.options.showInConsole (present in Firefox 3.5+)</p>
   </td>
   <td>Outputs JavaScript errors to the error console.</td>
   <td>True</td>
  </tr>
  <tr>
   <td>javascript.options.strict (present in Firefox 3.5+)</td>
   <td>Enforces strict error output from JavaScript</td>
   <td>True</td>
  </tr>
 </tbody>
</table>

<p><strong>Table 1: </strong>Preferences to set for developing extensions</p>

<p>To make these changes, start your development profile, type <em>about:config</em> into Firefoxâs location bar and open the preferences window; find the preferences listed in Table 1 and double-click on them to set them accordingly. Some of these preferences do not existâto create them, right-click, select âNew&gt;Booleanâ, and type in the name and set the value accordingly.</p>

<h3 id="Install_the_DOM_Inspector">Install the DOM Inspector</h3>

<p>The DOM Inspector is an extension that lets you examine HTML and XUL DOM tree structures, JavaScript objects and CSS properties, etc. This is not required for developing extensions, but it is handy to have around. Install extensions for Firefox from the <a class="link-https" href="https://addons.mozilla.org/en-US/firefox/addon/6622" title="https://addons.mozilla.org/en-US/firefox/addon/6622">Mozilla Add-ons website</a>.Â </p>

<h3 id="Optional_-_Install_Firebug_and_Chromebug">Optional - Install Firebug and Chromebug</h3>

<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 1.7em; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;">Chromebug is used by the Firebug development team to develop Firebug. Â You can use it to help debug Firefox extensions as well as to inspect and learn how the Firefox UI (Chrome) is constructed. You can learn more about Chromebug and download it at Â Â <a class="external" href="http://getfirebug.com/wiki/index.php/Chromebug_User_Guide">http://getfirebug.com/wiki/index.php/Chromebug_User_Guide</a></p>

<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 1.7em; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;">You may also find this extension to be valuable: Extension DeveloperÂ <a class="link-https" href="https://addons.mozilla.org/en-US/firefox/addon/7434">https://addons.mozilla.org/en-US/firefox/addon/7434</a>Â Â </p>

<h2 id="Developing_extensions_What_you_need_to_know">Developing extensions: What you need to know</h2>

<p>Letâs delve into <strong>chrome</strong>, something youâll need to know about in order to develop extensions.</p>

<h3 id="Chrome">Chrome</h3>

<h4 id="What_is_chrome">What is chrome?</h4>

<p>â<em>Chrome</em>âis the word used to describe all the GUI structural elements that go into an XUL application. For example, in the Firefox browser window, everything other than the web page being displayed in the content area is chrome. Extensions also can be considered XUL applications with chrome.</p>

<h4 id="Three_kinds_of_packages_make_up_chrome">Three kinds of packages make up chrome</h4>

<h5 id="The_content_package">The content package</h5>

<p>This package is used to contain the main XUL and JavaScript source files. Most extensions consist of a single content package<sup><a href="#footnote2" id="from_footnote2">2</a></sup></p>

<h5 id="The_locale_package">The locale package</h5>

<p>This package is used to contain language data that can be translated. To make an extensionâs GUI support multiple languages, you can include multiple locale packages, one for each language.</p>

<h5 id="The_skin_package">The skin package</h5>

<p>This is used to include source files used as visual elements in the GUI, including style sheets and images. Most extensions include only one skin package, but you can include multiple skin packages to allow the GUI to change with different themes.</p>

<h4 id="Chrome_URL">Chrome URL</h4>

<p>Use a file called a âchrome manifestâ to register chrome packages with Firefox and start using them. To register a package, you use a special URI scheme called a âChrome URLâ to represent the path to the file. Chrome URLs are structured as:</p>

<pre>chrome://<em>%package name%</em>/<em>%package type%</em>/%<em>relative path to source file</em>%</pre>

<p>For example, the Chrome URL for the Firefox browser window is as follows:</p>

<pre>chrome://browser/content/browser.xul</pre>

<p>Here, the package name is â<em>browser</em>â, the file â<em>browser.xul</em>â, and the type of the package is â<em>content</em>â. Source files represented through chrome URLs run with <em>UniversalXPConnect</em> privileges; even if they havenât been granted â<em>use XPConnect as local file</em>â privileges, as discussed in <a class="internal" href="/En/Firefox_addons_developer_guide/Using_XPCOMâImplementing_advanced_processes" title="En/Firefox addons developer guide/Using XPCOMâImplementing advanced processes">Chapter 4</a>, they will be able to use XPCOM functions (Figure 1).</p>

<pre>Extension/
  chrome manifest
  Chrome/ #registered in the chrome
    content package #Run with privileges
    locale package
    skin package</pre>

<p>Figure 1: Chrome packages and chrome registration (<span class="inlineIndicator todo todoInline"><strong>FIXME:</strong> <em>Not really explicit and not a Figure</em></span>)</p>

<h3 id="Cross-package_overlays">Cross-package overlays</h3>

<p>The âoverlayâ technique introduced in <a class="internal" href="/En/Firefox_addons_developer_guide/Introduction_to_XULâHow_to_build_a_more_intuitive_UI" title="En/Firefox addons developer guide/Introduction to XULâHow to build a more intuitive UI">Chapter 3</a> required the use of the xul-overlay instruction in the XUL document that is the overlay target. It is also possible to coerce an overlay without using the xul-overlay instruction in the XUL documentâthis is called a â<em>cross-package overlay</em>â (Figure 2). In fact, you need to use cross-package overlays to append buttons or menus to the Firefox browser window. Use the chrome manifest to invoke a cross-package overlay.</p>

<pre>Normal overlay: Adding the xul-overlay instruction to the target XUL document overlays it with another XUL document
Cross-package overlay: Adding a cross manifest permits one XUL file to overlay another without any xul-overlay instruction.</pre>

<p>Figure 2: Invoking a cross-package overlay (<span class="inlineIndicator todo todoInline"><strong>FIXME:</strong> <em>Not really explicit and not a Figure</em></span>)</p>

<h3 id="Conclusion">Conclusion</h3>

<p>This has been a brief introduction to chrome that probably leaves a lot of unanswered questions. If you keep in mind the following three points at the very least, the next section, Developing a Simple Extension, should help flesh out your understanding.</p>

<ol>
 <li>An extensionâs GUI, or chrome, can consist of three kinds of package: <em>content</em>, <em>locale</em>, and <em>skin</em>.</li>
 <li>Use a cross-package overlay on top of <em>browser.xul</em> to add a button or menu item to the Firefox browser window.</li>
 <li>The chrome manifest plays two important roles: it registers the contents of the chrome packages, and invokes the cross-package overlay.</li>
</ol>

<h2 id="Developing_a_Simple_Extension_Hello_World">Developing a Simple Extension: Hello World</h2>

<p>In this section, we will write an extremely simple â<em>hello world</em>â extension that only displays the time.<sup><a href="#footnote3" id="from_footnote3">3</a></sup></p>

<p>Â </p>

<h3 id="Phase_1_test_install">Phase 1: test install</h3>

<p>Our first step will be to perform a test installation consisting of the minimum code needed to add a new menu item to the Tools menu (Figure 3).</p>

<p><span class="inlineIndicator todo todoInline"><strong>FIXME:</strong> <em>Figure 3: Menu after Phase 1 complete</em></span></p>

<h4 id="Source_file_structure">Source file structure</h4>

<p>First set up the work folders youâll use to organize your extensionâs source files. The folder can be wherever you want, but for the purposes of this guide, weâll assume itâs at <em>C:\extensions\helloworld</em> . Create folders and files in your work folder as shown in Figure 4. The purpose of each file created during Phase 1 is explained in Table 2.</p>

<p>Figure 4: Folder structure used in Phase 1</p>

<pre class="brush: bash">C:/
ââââextensions
Â Â Â  ââââhelloworld
Â Â Â Â Â Â Â  âÂ Â  chrome.manifest
Â Â Â Â Â Â Â  âÂ Â  install.rdf
Â Â Â Â Â Â Â  â
Â Â Â Â Â Â Â  ââââcontent
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  clock.js
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  clock.xul
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  overlay.xul</pre>

<p>Table 2: How files are used in Phase 1</p>

<p><span class="inlineIndicator todo todoInline"><strong>FIXME:</strong> <em>Make the table cleaner</em></span></p>

<table class="standard-table" style="height: 321px; width: 1228px;">
 <tbody>
  <tr>
   <th scope="col">File name</th>
   <th scope="col">Role</th>
  </tr>
  <tr>
   <td>
    <p>install.rdf</p>
   </td>
   <td>Called the install manifest, this gives basic information about the extension, and is required in order for the extension to be installed in Firefox..</td>
  </tr>
  <tr>
   <td>
    <p>chrome.manifest</p>
   </td>
   <td>This is the chrome manifest described in the earlier section. Registers packages and invokes cross-package overlays.</td>
  </tr>
  <tr>
   <td>
    <p>content/overlay.xul</p>
   </td>
   <td>XUL file that will be overlaid on the Firefox browser window, adding buttons, menu items, etc.</td>
  </tr>
  <tr>
   <td>
    <p>content/clock.xul</p>
    content/clock.js</td>
   <td>The XUL to display a clock in the window, and the JavaScript to control its operation (these files will be used in Phase 2).</td>
  </tr>
 </tbody>
</table>

<h4 id="Create_install_manifest">Create install manifest</h4>

<p>Fill in the <em>install.rdf</em> file as shown in Listing 1.</p>

<p>Listing 1: Content for install.rdf</p>

<pre class="brush: xml">&lt;?xml version="1.0"?&gt;
&lt;RDF xmlns="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:em="http://www.mozilla.org/2004/em-rdf#"&gt;
  &lt;Description about="urn:mozilla:install-manifest"&gt;
    &lt;!-- Unique ID for extension. Can be in e-mail address format or GUID format --&gt;
    &lt;em:id&gt;helloworld@xuldev.org&lt;/em:id&gt;
    &lt;!-- Indicates that this add-on is an extension --&gt;
    &lt;em:type&gt;2&lt;/em:type&gt;
    &lt;!-- Extension name displayed in Add-on Manager --&gt;
    &lt;em:name&gt;Hello, World!&lt;/em:name&gt;
    &lt;!-- Extension version number. There is a version numbering scheme you must follow --&gt;
    &lt;em:version&gt;0.1&lt;/em:version&gt;
    &lt;!-- Brief description displayed in Add-on Manager --&gt;
    &lt;em:description&gt;My first extension.&lt;/em:description&gt;
    &lt;!-- Name of extension's primary developer. Change to your name --&gt;
    &lt;em:creator&gt;Gomita&lt;/em:creator&gt;
    &lt;!-- Web page address through which extension is distributed --&gt;
    &lt;em:homepageURL&gt;http://www.xuldev.org/helloworld/&lt;/em:homepageURL&gt;
    &lt;!-- This section gives details of the target application for the extension (in this case: Firefox 2) --&gt;
    &lt;em:targetApplication&gt;
      &lt;Description&gt;
        &lt;em:id&gt;{ec8030f7-c20a-464f-9b0e-13a3a9e97384}&lt;/em:id&gt;
        &lt;em:minVersion&gt;2.0&lt;/em:minVersion&gt;
        &lt;em:maxVersion&gt;4.0.0.*&lt;/em:maxVersion&gt;
      &lt;/Description&gt;
    &lt;/em:targetApplication&gt;
  &lt;/Description&gt;
&lt;/RDF&gt;
</pre>

<h4 id="Create_the_chrome_manifest">Create the chrome manifest</h4>

<p>Fill in the <em>chrome.manifest</em> file as shown in Listing 2.</p>

<p>Listing 2: Content for chrome.manifest</p>

<pre>content helloworld content/
overlay chrome://browser/content/browser.xul chrome://helloworld/content/overlay.xul
</pre>

<h5 id="Register_the_content_package_(content_instruction)">Register the content package (content instruction)</h5>

<p>Line 1, beginning content, contains the code used to register the chromeâs content package. Here, <em>helloworld</em> is a package name, and <em>content/</em> is a relative path to the folder where the source file is stored. Registering the content package makes it so that the <em>overlay.xul</em> file in the content folder can be accessed using the chrome URL, <em><a class="external" rel="freelink">chrome://helloworld/content/overlay.xul</a></em>.</p>

<h5 id="XUL_cross-package_overlay_(overlay_instruction)">XUL cross-package overlay (overlay instruction)</h5>

<p>Line 2, beginning overlay, contains the code used to invoke the cross-package overlay, overlaying the Firefox browser window, at <em><a class="external" rel="freelink">chrome://browser/content/browser.xul</a></em> with <em><a class="external" rel="freelink">chrome://helloworld/content/overlay.xul</a></em>.</p>

<p>Finding overlay merge points</p>

<p>The next step is to find the âmerge pointsâ where the overlay document will insert its content into the base document. There are a number of ways to go about this; here, weâll use the DOM Inspector (Figure 5).</p>

<ol>
 <li>Open the DOM Inspector by selecting the Tools &gt; DOM Inspector menu item.Â  <em>Firefox 31 Open the DOM Inspector by open menu&gt;Developer&gt;DOM Inspector menu item. </em></li>
 <li>Type <a class="external" rel="freelink">chrome://browser/content/browser.xul</a> into the URL input field at the top, then click the Inspect button. A browser pane will appear in the lower part of the window.</li>
 <li>Click the spots numbered 1 and 2 in Figure 5, in that order; the menu element (3) will then be selected.</li>
 <li>Expand spot 3; this will disclose the area numbered 4, with several menuitem elements. The menupop element 4 contains the merge point where youâre going to be adding a new menu item; you can see that it has the id menu_ToolsPopup.</li>
 <li>Look through the menuitem elements within this menupop element and determine where you want to add your new element. For the time being, letâs locate it in the spot numbered</li>
</ol>

<p><span class="inlineIndicator todo todoInline"><strong>FIXME:</strong> <em>Figure 5: Finding merge points for overlays using the DOM Inspector</em></span></p>

<p>Putting overlays on the browser window</p>

<p>Now that you know the merge point for your overlay, you can create the <em>overlay.xul</em> file that will insert it (Listing 3). In line 4, we identify the merge point as the menupop element; in lines 5â7, we have the code that adds the new menu item. The insertbefore attribute determines where the element gets added.</p>

<h4 id="Test_install_and_operational_check">Test install and operational check</h4>

<p>This brings us to the point where we finally install our Hello World extension. Using the normal XPI-style installer would just be added trouble in this case, so we wonât use it. For source files under development, we do test installs.</p>

<h5 id="Placing_pointer_files">Placing pointer files</h5>

<p>First, navigate to the profile folder of the currently active profile<sup><a href="#footnote4" id="from_footnote4">4</a></sup>, and open the extensions folder within it. Create a new file there with the name you used as the Hello World extension ID in the install manifest, <em><a class="link-mailto" href="mailto:helloworld@xuldev.org" rel="freelink">helloworld@xuldev.org</a></em>. Set the contents of that file to be the full path to the work folder for your extension source files,<em> C:\extensions\helloworld</em>.</p>

<p>Listing 3: Additional content for overlay.xul</p>

<pre class="brush: xml">&lt;?xml version="1.0"?&gt;
&lt;overlay id="helloworldOverlay" xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul"&gt;
  &lt;menupopup id="menu_ToolsPopup"&gt;
    &lt;menuitem id="helloworldMenuitem" label="Hello, World!" insertbefore="sanitizeSeparator"
     oncommand="window.openDialog('chrome://helloworld/content/clock.xul','Clock','chrome,centerscreen,modal');"/&gt;
  &lt;/menupopup&gt;
&lt;/overlay&gt;
</pre>

<p>Â </p>

<h3 id="Phase_2_Adding_a_function_to_display_the_time">Phase 2: Adding a function to display the time</h3>

<p>In Phase 2, we will make it so that selecting the Hello World menu item we created in Phase 1 will display a window with the time (Figure 6).</p>

<p><span class="inlineIndicator todo todoInline"><strong>FIXME:</strong> <em>Figure 6: Clock window produced by Phase 2</em></span></p>

<h4 id="Adding_an_event_handler">Adding an event handler</h4>

<p>First, we add an event handler to the menu item that will open the window (Listing 4).</p>

<p><span class="inlineIndicator todo todoInline"><strong>FIXME:</strong> <em>Listing 4: Event handler</em></span></p>

<h4 id="Clock_handler">Clock handler</h4>

<p>Create the window that displays the clock (Listing 5) and its controller (Listing 6). Weâve already covered the dialog element in Chapter 3. In this case, we only want to display an OK button, so we set the buttons attribute to accept. Within the window are a label element and textbox element, wrapped in a hbox element so that they are arranged horizontally.</p>

<p>Listing 5: Content for clock.xul</p>

<pre class="brush: xml">&lt;?xml version="1.0"?&gt;
&lt;?xml-stylesheet href="chrome://global/skin/"?&gt;
&lt;dialog id="clockDialog" xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul"
    title="Clock"
    buttons="accept"
    onload="initClock();"&gt;
  &lt;script type="application/javascript" src="chrome://helloworld/content/clock.js"/&gt;
  &lt;hbox align="center"&gt;
    &lt;label value="Current Time:" /&gt;
    &lt;textbox id="currentTime" /&gt;
  &lt;/hbox&gt;
&lt;/dialog&gt;
</pre>

<p>Listing 6: content for clock.js</p>

<pre class="brush: js">function initClock() {
  showCurrentTime();
  window.setInterval(showCurrentTime, 1000);
}

function showCurrentTime() {
  var textbox = document.getElementById("currentTime");
  textbox.value = new Date().toLocaleTimeString();
  textbox.select();
}
</pre>

<h4 id="Operations_check">Operations check</h4>

<p>Perform an operations check to make sure that your changes to the source file are correct. At this point, itâs important that you disabled the XUL cache as discussed in the earlier section, â<em>Setting up your development environment</em>â. Assuming youâve done that, youâll be able to confirm the changes to <em>overlay.xul</em> and <em>clock.xul</em> without the bother of relaunching Firefox or reinstalling the extension. If the <em>browser.xul</em> file, which is the target of the overlay in <em>overlay.xul</em> is being read in again, the changes will be reflected, and youâll be able to see the changes by opening a new browser window. The files <em>clock.xul</em> and <em>clock.js</em> will be read in every time you open the clock window, so just re-opening the clock window once will suffice to check them. During development, itâs important to minimize the number of steps between revising a source file and running an operations check against those changes. The part â<em>Operations checks on revised source files</em>â discusses the general procedure to follow from source-file revision to operations check.</p>

<p>What if somethingâs not working right?</p>

<p>If your extension isnât working according to plan, first see if thereâs an error being displayed on the <em>Errors panel</em> of the <em>Error Console</em>. If you set things up as recommended in the section â<em>Setting up your development environment</em>â, XUL and JavaScript errors will appear here. See the part â<em>JavaScript debugging techniques</em>â for useful tips on that subject<sup><a href="#footnote5" id="from_footnote5">5</a></sup>. If Firefox freezes up, youâll need to terminate the Firefox process from the task manager.</p>

<p>Â </p>

<h3 id="Phase_3_Adding_multilingual_support">Phase 3: Adding multilingual support</h3>

<p>The clock window that we created in Phase 2 displays everything in English. In Phase 3, weâre going to add multilingual support, making it so that it users running Firefox in a French environment will see âHeure actuelleâ, and those running it in English will see âCurrent timeâ (Figure 7).</p>

<p><span class="inlineIndicator todo todoInline"><strong>FIXME:</strong> <em>Figure 7: Clock window after Phase 3</em></span></p>

<h4 id="Directory_structure">Directory structure</h4>

<p>To add multilingual support to this extension, weâll add a locale package to the chrome. Create a new locale folder with subfolders and files within the <em>helloworld</em> folder, as shown in Figure 8. The purpose of each of these files is explained in Table 3.</p>

<p><span class="inlineIndicator todo todoInline"><strong>FIXME:</strong> <em>Figure 8: Directory structure with locale package added</em></span></p>

<p>Table 3: Files used in Phase 3</p>

<p><span class="inlineIndicator todo todoInline"><strong>FIXME:</strong> <em>Make the table cleaner</em></span></p>

<table class="standard-table" style="height: 188px; width: 1228px;">
 <tbody>
  <tr>
   <th scope="col">File name</th>
   <th scope="col">Role</th>
  </tr>
  <tr>
   <td>
    <p>locale\en-US\clock.dtd</p>
   </td>
   <td>DTD definining entity references used in clock.xul (for English).</td>
  </tr>
  <tr>
   <td>
    <p>locale\fr-FR\clock.dtd</p>
   </td>
   <td>DTD definining entity references used in clock.xul (for French).</td>
  </tr>
 </tbody>
</table>

<h4 id="sect1">Â </h4>

<h4 id="Adding_locale_packages">Adding locale packages</h4>

<h5 id="Registering_locale_packages_(locale_instruction)">Registering locale packages (locale instruction)</h5>

<p>The line beginning locale is used to register the chromeâs local package; helloworld is the package name, and locale/en-US/ and locale/fr-FR/ are the relative paths to the folders containing the source files; en-US and fr-FR indicate that those locale packages are for English and French, respectively.</p>

<p>Listing 7: Additional content for chrome.manifest</p>

<pre>locale helloworld en-US locale/en-US/
locale helloworld fr-FR locale/fr-FR/
</pre>

<h4 id="Replacing_text_with_entity_references_in_XUL">Replacing text with entity references in XUL</h4>

<p>To make the extension support multiple languages, you will need to separate out all the hard-coded display text in clock.xul and move it to a DTD file. The DTD file is located inside the locale package, and the correct file is picked automatically to match the userâs language preferences. Edit clock.xul to match Listing 8. Add the DOCTYPE declaration that references the DTD file, and replace âclockâ and âcurrent timeâ with entity references.</p>

<p>Listing 8: Revisions to clock.xul</p>

<pre class="brush: xml">&lt;?xml version="1.0"?&gt;
&lt;?xml-stylesheet href="chrome://global/skin/"?&gt;
&lt;!DOCTYPE dialog SYSTEM "chrome://helloworld/locale/clock.dtd"&gt;
&lt;dialog id="clockDialog" xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul"
    title="&amp;helloworld.clock;" buttons="accept"
    onload="initClock();"&gt;
  &lt;script type="application/javascript" src="chrome://helloworld/content/clock.js" /&gt;
  &lt;hbox align="center"&gt;
    &lt;label value="&amp;helloworld.currentTime;:" /&gt;
    &lt;textbox id="currentTime" /&gt;
  &lt;/hbox&gt;
&lt;/dialog&gt;
</pre>

<h4 id="Create_the_DTD_that_defines_the_entity_references">Create the DTD that defines the entity references</h4>

<p>Now create the DTD file that gets referred to by clock.xul (Listing 9). The clock.dtd file inside the fr-FR folder must be encoded as UTF-8.</p>

<p>Listing 9: Content for clock.dtd</p>

<p>locale\en-US\clock.dtd:</p>

<pre class="brush: xml">&lt;!ENTITY helloworld.clock "Clock"&gt;
&lt;!ENTITY helloworld.currentTime "Current Time"&gt;
</pre>

<p>locale\fr-FR\clock.dtd:</p>

<pre class="brush: xml">&lt;!ENTITY helloworld.clock "Horloge"&gt;
&lt;!ENTITY helloworld.currentTime "Heure courante"&gt;</pre>

<h4 id="Replacing_User_Interface_messages_within_JavaScript_files_with_properties_references">Replacing User Interface messages within JavaScript files with properties references</h4>

<p><br>
 It may happen your extension displays some useful messages such as alerts to the user.Â  Though they are nested in JavaScript, the strings should be localized too, for the sake of UI consistency.<br>
 Suppose you have these strings nested in a .js file:</p>

<pre class="brush: js">if ( password == userPassword ) {
oPrefs.setBoolPref("access.authenticated", true);
}
else {
alert ("Invalid password");
......
function clear()
{
sure = confirm("Are you sure?");
</pre>

<p>First, you have to find or create a myextension.properties file in your locale folder (Notice: always stick to UTF-8). Then you simply write variable names and the sentences or words that should appear to the final user. Something like :</p>

<pre class="brush: js">wrongPassMessage=Invalid password
areYouSureMessage=Are you sure?
</pre>

<p>(where Invalid password and Are you sure? are the strings to be displayed to the final user) Notice : a simple sign is enough</p>

<p><br>
 Now you go back to the .js file where the strings to be localized are nested.<br>
 At the very top of the file you create one string bundle with the address of the properties file where to find strings.</p>

<pre class="brush: js">var gmyextensionBundle = Components.classes["@mozilla.org/intl/stringbundle;1"].getService(Components.interfaces.nsIStringBundleService);

var _bundle = gmyextensionBundle.createBundle("chrome://myextension/locale/myextension.properties")
</pre>

<p>Â </p>

<p>You can now use your string substitutes in the .js where they are needed: see examples below</p>

<pre class="brush: js">if ( password == userPassword ) {
 Â oPrefs.setBoolPref("access.authenticated", true);
}
else {
Â Â alert (_bundle.GetStringFromName("wrongPassMessage"));

function clear() {
Â Â sure = confirm(_bundle.GetStringFromName("areYouSureMessage"));</pre>

<p>}</p>

<h4 id="Operations_check_2">Operations check</h4>

<p>This brings us to the operations check. Because weâve changed the chrome manifest, we need to relaunch Firefox once, as discussed in the part â<em>Operations checks on revised source files</em>â. So relaunch Firefox and display the clock window to make sure it is working correctly. Then type about:config into the location bar, and change the value of <em>general.useragent.locale</em> from en to fr, and re-display the clock window to confirm that it appears in French now.</p>

<p>Â </p>

<h3 id="Phase_4_Adding_a_toolbar_button">Phase 4: Adding a toolbar button</h3>

<p>In Phase 4, weâll use graphics and style sheets to create a toolbar button that will open the clock window (Figure 9).</p>

<p><span class="inlineIndicator todo todoInline"><strong>FIXME:</strong> <em>Figure 9: Toolbar after Phase 4</em></span></p>

<h4 id="Directory_structure_2">Directory structure</h4>

<p>The style sheet and graphics files will be located inside the chromeâs skin package. The extension will actually work fine even if these are located in the content package, but putting them in the skin package has the benefit of making it possible to design GUIs that match specific Firefox themes, and allowing theme developers to create special visual effects for extensions.</p>

<p>First, add the skin directory and its subordinate files to your helloworld directory as shown in Figure 10. The purpose of each of these files is explained in Table 4. Download the files icon.png and <em>icon-small.png</em> from the resources website and place them appropriately.</p>

<p><span class="inlineIndicator todo todoInline"><strong>FIXME:</strong> <em>Figure 10: Directory structure with skin package added</em></span></p>

<h4 id="Add_the_skin_package">Add the skin package</h4>

<p>Update <em>chrome.manifest</em> with the contents of Listing 10.</p>

<p>Listing 10: Additional content for chrome.manifest</p>

<pre>skin helloworld classic/1.0 skin/classic/
style chrome://browser/content/browser.xul chrome://helloworld/skin/overlay.css
style chrome://global/content/customizeToolbar.xul chrome://helloworld/skin/overlay.css
</pre>

<h5 id="Register_skin_package_(skin_instruction)">Register skin package (skin instruction)</h5>

<p>Line 1 beginning skin is used to register the skin package; helloworld is the package name; skin/classic/ is the relative path to the folder containing the source files; classic/1.0 indicates that this skin package is meant for the Firefox standard theme.</p>

<h5 id="Cross-package_overlays_with_style_sheets_(style_instruction)">Cross-package overlays with style sheets (style instruction)</h5>

<p>In Phase 1, we used the overlay instruction to invoke a cross-package overlay with XUL; to do this with a style sheet, we use the style instruction. Lines 2-3 create overlays on the browser window and the âcustomize toolbarâ window.</p>

<h4 id="Add_the_toolbar_button">Add the toolbar button</h4>

<p>To add the toolbar button to the browser window, update <em>overlay.xul</em> as shown in Listing 11. In order to make it so that users can relocate the button where they like, you will add a new <code>toolbarbutton</code> element, using the special element <code>toolbarpalette</code> with the id <code>BrowserToolbarPalette</code> as the merge point. Youâll also add a new command element, so that a click on the toolbar button will share its process with the menu item.</p>

<p>Listing 11: Revisions to overlay.xul</p>

<pre class="brush: xml">&lt;?xml version="1.0"?&gt;
&lt;overlay id="helloworldOverlay" xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul"&gt;
  &lt;commandset id="mainCommandSet"&gt;
    &lt;command id="helloworldCommand" oncommand="window.openDialog(
      'chrome://helloworld/content/clock.xul',
      'Clock','chrome,centerscreen,modal');" /&gt;
  &lt;/commandset&gt;
  &lt;toolbarpalette id="BrowserToolbarPalette"&gt;
     &lt;toolbarbutton id="helloworldButton" label="Hello, World!" class="toolbarbutton-1" command="helloworldCommand" /&gt;
  &lt;/toolbarpalette&gt;
  &lt;menupopup id="menu_ToolsPopup"&gt;
    &lt;menuitem id="helloworldMenuitem" label="Hello, World!" insertbefore="sanitizeSeparator"
       command="helloworldCommand" /&gt;
  &lt;/menupopup&gt;
&lt;/overlay&gt;
</pre>

<h4 id="Create_the_style_sheet">Create the style sheet</h4>

<p>Update the file <code>overlay.css</code> with the contents of Listing 12. Lines 1â3 define the icon image to use with full-sized icons, and lines 4â6 define the icon image to use when small toolbar icons have been selected.</p>

<p>Listing 12: Content for overlay.css</p>

<pre class="brush: css">#helloworldButton {
  list-style-image:
  url(chrome://helloworld/skin/icon.png);
}

toolbar[iconsize="small"] #helloworldButton {
  list-style-image: url(chrome://helloworld/skin/icon-small.png);
}
</pre>

<h4 id="Operations_check_3">Operations check</h4>

<p>Since we have edited the chrome manifest, as we did in Phase 3, we need to relaunch Firefox. Check to make sure that, when you click on the â<em>customize toolbar</em>â button at the top-right of the window that the new toolbar icon appears in the resulting window. Drag it onto the toolbar, and click it to make sure it works correctly.</p>

<p>Table 4: Files used in Phase 4</p>

<p><span class="inlineIndicator todo todoInline"><strong>FIXME:</strong> <em>Make the table cleaner</em></span></p>

<table style="width: 590px;">
 <tbody>
  <tr>
   <td>
    <p>name</p>
   </td>
   <td>
    <p>purpose</p>
   </td>
  </tr>
  <tr>
   <td>
    <p>icon.png</p>
   </td>
   <td>
    <p>The full-size toolbar button icon file</p>
   </td>
  </tr>
  <tr>
   <td>
    <p>icon-small.png</p>
   </td>
   <td>
    <p>the small toolbar button icon file</p>
   </td>
  </tr>
  <tr>
   <td>
    <p>overlay.css</p>
   </td>
   <td>
    <p>Style sheet that defines the toolbar buttons to use. Overlays both the browser window and the âcustomize toolbarâ window.</p>
   </td>
  </tr>
 </tbody>
</table>

<h3 id="Phase_5_XPI_packaging">Phase 5: XPI packaging</h3>

<p>We actually completed our Hello World extension in Phase 4, but you canât distribute the source files in this state to other users. So we need to create an xpi-formatted installer.</p>

<h4 id="XPI_file_directory_structure">XPI file directory structure</h4>

<p>XPI is basically just a zip archive, but the directory structure inside an xpi file is generally different from your development directory structure (Figure 11).</p>

<p><span class="inlineIndicator todo todoInline"><strong>FIXME:</strong> <em>Figure 11: Directory structure inside an xpi file</em></span></p>

<h4 id="Packaging_procedure">Packaging procedure</h4>

<p>To package your extension as an xpi while preserving the directory structure of the source files you used during development, make the changes shown in Figure 11, as described below.</p>

<ol>
 <li>Create a new chrome directory inside the helloworld directory.</li>
 <li>Zip the content, locale, and skin directories<sup><a href="#footnote1" id="from_footnote1">1</a></sup>, rename the resulting archive helloworld.jar, and place it inside the chrome directory you created in Step 1.</li>
 <li>Copy chrome.manifest and rename the backup chrome.manifest.bak.</li>
 <li>Change the content of chrome.manifest to be in line with Listing 13.</li>
 <li>Zip install.rdf, chrome.manifest, and the chrome folder together, and rename the resulting archive helloworld.xpi.</li>
</ol>

<p>Listing 13: Revisions to chrome.manifest</p>

<pre>content helloworld jar:chrome/helloworld.jar!/content/
overlay chrome://browser/content/browser.xul chrome://helloworld/content/overlay.xul
locale helloworld en-US jar:chrome/helloworld.jar!/locale/en-US/
locale helloworld fr-FR jar:chrome/helloworld.jar!/locale/fr-FR/
skin helloworld classic/1.0 jar:chrome/helloworld.jar!/skin/classic/
style chrome://browser/content/browser.xul chrome://helloworld/skin/overlay.css
style chrome://global/content/customizeToolbar.xul chrome://helloworld/skin/overlay.css
</pre>

<p>That completes the process of XPI packaging. One point you need to take special note of is that in Step 4, you updated chrome.manifest so that the files it refers to have paths pointing inside the zip archive.</p>

<p>In order to go back into development mode after youâve finished packaging the extension as an xpi, you need to revert the chrome.manifest you edited in Step 4 to point to the backup files in Step 3. If you forget to do this, any subsequent changes you make to your source files during development will not be reflected. You may want to write a batch file to automate this task.</p>

<p>Thereâs a simpler way to package an extensions as an xpi. Create a zip archive containing install.rdf, chrome.manifest, content, locale, and skin. Name this helloworld.xpi.</p>

<p>This omits creating the archive of the chrome packages called helloworld.jar. This kind of xpi file will run fine, but will slow down Firefoxâs launch time.</p>

<h4 id="XPI_operations_check">XPI operations check</h4>

<p>After you create the xpi file, make sure it works. Since youâve already got the development version of the Hello World extension running as a test install on your current profile, restart Firefox under a different profile (see footnote 1). Drag and drop the xpi file onto your browser window to start the installation.</p>

<p>This completes the explanation of how to create and package a simple âhello worldâ extension.</p>

<h2 id="Developing_practical_extensions_A_session-management_extension">Developing practical extensions:<br>
 A session-management extension</h2>

<p>In this section, we will create an extension that uses a new feature: the session store API. This will allow the user to save and restore session snapshots (browser window states) at any time.</p>

<h3 id="Phase_1_test_install_2">Phase 1: test install</h3>

<p>Figure 12 shows what the interface for the session-management extension will look like. Under the Tool menu, the Session Store submenu contains two itemsâ<em>Save Session</em> and <em>Clear Sessions</em>; in between them is a list of previously saved sessions that you can restore, most recent first.</p>

<p><span class="inlineIndicator todo todoInline"><strong>FIXME:</strong> <em>Figure 12: Session-management extension interface: the menu</em></span></p>

<p>As discussed in the part â<em>The Session Store API</em>â, sessions are represented as JSON character strings. Sessions are stored in a subdirectory of the profile directory (called â<em>sessionstore</em>â), with each session stored as a text file in it (Figure 13).</p>

<p><span class="inlineIndicator todo todoInline"><strong>FIXME:</strong> <em>Figure 13: Schematic of session saving and restorin</em></span></p>

<h4 id="Source_file_structure_2">Source file structure</h4>

<p><span class="inlineIndicator todo todoInline"><strong>FIXME:</strong> <em>Figure 14 shows the directory structure for this project</em></span></p>

<h4 id="Creating_install_manifest">Creating install manifest</h4>

<p>Create your work folder, and create an install manifest with the contents of Listing 1, but in this case, change <em>em:id</em> to <em><a class="link-mailto" href="mailto:sessionstore@example.org" rel="freelink">sessionstore@example.org</a></em> and <em>em:name</em> to <em>Session Store</em>.</p>

<h4 id="Creating_chrome_manifest">Creating chrome manifest</h4>

<p>Create a chrome manifest with the contents of Listing 2.</p>

<h4 id="Finding_overlay_merge_points">Finding overlay merge points</h4>

<p>Use the same overlay merge point and element to add on to as you did for the Hello World extension.</p>

<h4 id="Browser_window_overlay">Browser window overlay</h4>

<p>Create a file that will overlay the browser window, <em>overlay.xul</em>, with the contents from Listing 14.</p>

<p>Listing 14: Content for overlay.xul</p>

<pre class="brush: xml">&lt;?xml version="1.0"?&gt;
&lt;overlay id="sessionstoreOverlay" xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul"&gt;
  &lt;script type="application/javascript"
      src="chrome://sessionstore/content/overlay.js" /&gt;
    &lt;menupopup id="menu_ToolsPopup"&gt;
      &lt;menu label="Session Store" insertbefore="sanitizeSeparator"&gt;
        &lt;menupopup&gt;
          &lt;menuitem label="Save Session" /&gt;
          &lt;menuseparator /&gt;
          &lt;!-- Dynamically generated menu items go here --&gt;
          &lt;menuseparator /&gt;
        &lt;menuitem label="Clear Sessions" /&gt;
      &lt;/menupopup&gt;
    &lt;/menu&gt;
  &lt;/menupopup&gt;
&lt;/overlay&gt;
</pre>

<h4 id="Test_install">Test install</h4>

<p>Perform a test install using pointer files as you did in the previous section. Afterwards, you should see a <em>Session Store</em> menu item under the Tools menu.</p>

<p>Â </p>

<h3 id="Phase_2_Implement_functionality">Phase 2: Implement functionality</h3>

<p>In Phase 2, weâll use JavaScript to implement the session save and restore functions using the session store API.</p>

<h4 id="Figure_out_JavaScript_skeleton">Figure out JavaScript skeleton</h4>

<p>Decide on method names and variable names for each of the processes youâll need to implement these features, and put them into an <em>overlay.js</em> file. Follow the code in Listing 15.</p>

<p>Listing 15: Content for overlay.js</p>

<pre class="brush: js">var gSessionStore = {
  // Directory to save sessions (nsILocalFile)
  _dir: null,
  // Initialization
  init: function() { },
  // uninitialization
  uninit: function() { },
  // Save session (event handler)
  save: function(event) { },
  // Restore session (event handler)
  restore: function(event) { },
  // Delete session (event handler)
  clear: function(event) { },
  // Dynamically generate menu items (event handler)
  createMenu: function(event) { },
  // Read file
  _readFile: function(aFile) { },
  // Write file
  _writeFile: function(aFile, aData) { },
};
window.addEventListener("load", function(){
gSessionStore.init(); }, false);
window.addEventListener("unload", function(){
gSessionStore.uninit(); }, false);
</pre>

<h5 id="Wrap_methods_and_variables_as_properties_of_objects">Wrap methods and variables as properties of objects</h5>

<p>Youâll note that in Listing 15, Iâve defined a lot of different methods and variables as properties of a single object, <code>gSessionStore</code>. Take note that when using an extension to create an overlay on the browser window, any global variables and functions defined within JavaScript that get opened as overlays on top of <em>browser.xul</em> all become properties of the <em>browser.xul</em> window object. This means that all those variables and functions get mixed up with those defined by Firefox itself and any other extensions that are running. Wrapping everything in one object is a good way to isolate extensions from each other and keep them from trampling each othersâ toes. Defining a class would be another good way.</p>

<h5 id="Initializing_when_opening_browser_window">Initializing when opening browser window</h5>

<p>With extensions, there are a lot of situations where you want to perform some kind of initialization when the browser window opens. To do that, add an event listener for the load event that targets the window object. In Listing 15, an <code>init</code> method runs when the window opens, and an uninit method runs when the window closes.</p>

<h4 id="Adding_event_handlers">Adding event handlers</h4>

<p>Add the four event handlers you defined in <em><code>overlay.js</code></em> to <em>overlay.xul</em> (Listing 16). This takes advantage of event bubbling<sup><a href="#footnote2" id="from_footnote2">2</a></sup>, appending the restore event handler to the <code>menupopup</code> element one layer above the <code>menuitem</code> element. In the code for the save and restore event handlers, we will actually need blocks to prevent event bubbling.</p>

<p>Listing 16: Revisions to overlay.xul</p>

<pre class="brush: xml">&lt;menupopup onpopupshowing="gSessionStore.createMenu(event);"
    oncommand="gSessionStore.restore(event);"&gt;
  &lt;menuitem label="Save Session" oncommand="gSessionStore.save(event);" /&gt;
  &lt;menuseparator /&gt;
  &lt;!-- Dynamically generated menu items go here --&gt;
  &lt;menuseparator /&gt;
  &lt;menuitem label="Clear Sessions" oncommand="gSessionStore.clear(event);" /&gt;
&lt;/menupopup&gt;
</pre>

<p>Â </p>

<h4 id="Implementing_methods">Implementing methods</h4>

<p>Now weâre going to actually implement the methods we defined in the <code>gSessionStore</code> object, one at a time. In the interest of space, Iâm not including all the code here, but you can download it from the following URL: <span class="inlineIndicator todo todoInline"><strong>FIXME:</strong> <em>include code from xuldev: translate it and attach it to the chapter document</em></span></p>

<h5 id="init_method">init method</h5>

<p>The init method is as shown in Listing 17. The init method first gets the <em>sessionstore</em> directory inside the profile directory using <code>nslLocalFile</code>, which weâll refer to through the variable <code>_dir</code> in subsequent lines (lines 3â6); if the directory doesnât exist, weâll create it (lines 7â8)<sup><a href="#footnote3" id="from_footnote3">3</a></sup>.</p>

<p>Listing 17: Content for <code>init</code> method</p>

<pre class="brush: js">init: function() {
  var dirSvc = Components.classes["@mozilla.org/file/directory_service;1"]
               .getService(Components.interfaces.nsIProperties);
  this._dir = dirSvc.get("ProfD", Components.interfaces.nsILocalFile);
  this._dir.append("sessionstore");
  if (!this._dir.exists())
    this._dir.create(this._dir.DIRECTORY_TYPE, 0700);
},
</pre>

<h5 id="uninit_method">uninit method</h5>

<p>Listing 18 gives the code for the uninit method. This just discards the variable <code>_dir</code> that was created by the init method. This process actually isnât important.</p>

<p>Listing 18: Content for uninit method</p>

<pre class="brush: js">uninit: function() {
  this._dir = null;
},</pre>

<h5 id="save_method">save method</h5>

<p>Listing 19 gives the code for the save method. In line 3, you see the block that prevents the bubbling that would result in this being called by the <code>oncommand</code> handler in the menupop element, which is the parent of the <code>menuitem</code> element. In lines 4â6, we use the <code>nslSessionStore</code> interfaceâs <code>getBrowserState</code> method to get a JSON text-string representation of the states of all currently open browser windows. In lines 7â9, we create the target fileâs <code>nslFile</code> object by duplicating the <code>_dir</code> property. In line 10, we use the <code>_writefile</code> method (which weâll get to shortly) to write the JSON string representing the session to the file.</p>

<p>Listing 19: Content for save method</p>

<pre class="brush: js">save: function(event) {
  event.stopPropagation();
  var ss = Components.classes["@mozilla.org/browser/sessionstore;1"]
           .getService(Components.interfaces.nsISessionStore);
  var state = ss.getBrowserState();
  var fileName = "session_" + Date.now() + ".js";
  var file = this._dir.clone();
  file.append(fileName);
  this._writeFile(file, state);
},</pre>

<h5 id="restore_method">restore method</h5>

<p>Listing 20 shows the event handler for the dynamically generated menu items, which were created using the <code>createMenu</code> method (which weâll get to shortly). Lines 3â6 get the file name from the special attribute <code>fileName</code> that was added by the <code>createMenu</code> method, and read in the JSON text string from that file using the <code>_readFile</code> method (which weâll get to shortly). Lines 7â9 use the <code>nslSessionStore</code> interfaceâs <code>setWindowState</code> method to restore the session, using the current window as an origin point. Session restoration overwrites any currently open tabs.</p>

<p>Listing 20: Content for restore method</p>

<pre class="brush: js">restore: function(event) {
  var fileName = event.target.getAttribute("fileName");
  var file = this._dir.clone();
  file.append(fileName);
  var state = this._readFile(file);
  var ss = Components.classes["@mozilla.org/browser/sessionstore;1"]
           .getService(Components.interfaces.nsISessionStore);
  ss.setWindowState(window, state, false);
},
</pre>

<h5 id="clear_method">clear method</h5>

<p>This uses the <code>directoryEntries</code> property of the <code>nslFile</code> interface to delete all files within the directory you got earlier. Refer to the section â<em>Traversing folders</em>â in <a class="internal" href="/En/Firefox_addons_developer_guide/Using_XPCOMâImplementing_advanced_processes" title="En/Firefox addons developer guide/Using XPCOMâImplementing advanced processes">Chapter 4</a>.</p>

<p>Listing 21: Content for clear method</p>

<pre>clear: function(event)
  {
    event.preventBubble();
    var fileEnum = this._dir.directoryEntries;
    while (fileEnum.hasMoreElements()) {
      var file = fileEnum.getNext().QueryInterface(Components.interfaces.nsIFile);
      file.remove(false);
      // debug
      dump("SessionStore&gt; clear: " + file.leafName + "\n");
    }
  },
</pre>

<p>Â </p>

<h5 id="_readFile_method">_readFile method</h5>

<p>Reads the <code>nslFile</code> object passed as a parameter, and returns its contents as a text string. When the file is read in, its contents are converted from UTF-8 to Unicode.</p>

<p>Listing 22: Content for _readFile method</p>

<pre>_readFile: function(aFile)
  {
    try {
      var stream = Components.classes["@mozilla.org/network/file-input-stream;1"].
                   createInstance(Components.interfaces.nsIFileInputStream);
      stream.init(aFile, 0x01, 0, 0);
      var cvstream = Components.classes["@mozilla.org/intl/converter-input-stream;1"].
                     createInstance(Components.interfaces.nsIConverterInputStream);
      cvstream.init(stream, "UTF-8", 1024, Components.interfaces.nsIConverterInputStream.DEFAULT_REPLACEMENT_CHARACTER);
      var content = "";
      var data = {};
      while (cvstream.readString(4096, data)) {
        content += data.value;
      }
      cvstream.close();
      return content.replace(/\r\n?/g, "\n");
    }
    catch (ex) { }
    return null;
  },
</pre>

<h5 id="_writeFile_method">_writeFile method</h5>

<p>Creates a new file for the <code>nslFile</code> object passed as a parameter, and writes the text string, also passed as a parameter. Upon writing, the text is converted from Unicode to UTF-8.</p>

<p>Listing 23: Content for _writeFile method</p>

<pre>_writeFile: function(aFile, aData)
  {
    // init stream
    var stream = Components.classes["@mozilla.org/network/safe-file-output-stream;1"].
                 createInstance(Components.interfaces.nsIFileOutputStream);
    stream.init(aFile, 0x02 | 0x08 | 0x20, 0600, 0);
    // convert to UTF-8
    var converter = Components.classes["@mozilla.org/intl/scriptableunicodeconverter"].
                    createInstance(Components.interfaces.nsIScriptableUnicodeConverter);
    converter.charset = "UTF-8";
    var convertedData = converter.ConvertFromUnicode(aData);
    convertedData += converter.Finish();
    // write and close stream
    stream.write(convertedData, convertedData.length);
    if (stream instanceof Components.interfaces.nsISafeOutputStream) {
      stream.finish();
    } else {
      stream.close();
    }
  },
</pre>

<h5 id="createMenu_method">createMenu method</h5>

<p>This event handler is called when the Session Store submenu opens. First, it deletes the menuitem elements that were dynamically generated the last time the submenu opened, and which are still left over. Next, it dynamically generates <code>menuitem</code> elements based on the names of all the files in the session-storage directory, and inserts them into the menu.</p>

<p>Listing 24: Content for createMenu method</p>

<pre> createMenu: function(event)
  {
    var menupopup = event.target;
    for (var i = menupopup.childNodes.length - 1; i &gt;= 0; i--) {
      var node = menupopup.childNodes[i];
      if (node.hasAttribute("fileName"))
        menupopup.removeChild(node);
    }
    var fileEnum = this._dir.directoryEntries;
    while (fileEnum.hasMoreElements()) {
      var file = fileEnum.getNext().QueryInterface(Components.interfaces.nsIFile);
      var re = new RegExp("^session_(\\d+)\.js$");
      if (!re.test(file.leafName))
        continue;
      var dateTime = new Date(parseInt(RegExp.$1, 10)).toLocaleString();
      var menuitem = document.createElement("menuitem");
      menuitem.setAttribute("label", dateTime);
      menuitem.setAttribute("fileName", file.leafName);
      menupopup.insertBefore(menuitem, menupopup.firstChild.nextSibling.nextSibling);
    }
  },
</pre>

<h5 id="Operations_check_4">Operations check</h5>

<p>This completes the functional implementation. Open a new window and make sure that all three functionsâsaving a session, restoring a session, and deleting sessionsâall work correctly.</p>

<p>Â </p>

<h3 id="Phase_3_Creating_a_preference_panel">Phase 3: Creating a preference panel</h3>

<p>You donât need to use ini files, registries, or anything like that to give users options they can set through a preference panel. Firefox lets you read and write preference values using handy XPCOM services and create preference panels with interface widgets. In Phase 3, weâll try this out (Figure 15).</p>

<p><span class="inlineIndicator todo todoInline"><strong>FIXME:</strong> <em>Figure 15: Finished preference panel</em></span></p>

<h4 id="Directory_structure_3">Directory structure</h4>

<p>Figure 16 shows the directory structure weâll be using in Phase 3. Table 5 explains the new files being used.</p>

<p>Table 5: Files used in Phase 3</p>

<p><span class="inlineIndicator todo todoInline"><strong>FIXME:</strong> <em>Make the table cleaner</em></span></p>

<table style="width: 590px;">
 <tbody>
  <tr>
   <td>
    <p>name</p>
   </td>
   <td>
    <p>purpose</p>
   </td>
  </tr>
  <tr>
   <td>
    <p>sessionstore-prefs.js</p>
   </td>
   <td>
    <p>File sets defaults for preferences. This should always be located inside defaults\preferences</p>
   </td>
  </tr>
  <tr>
   <td>
    <p>prefs.xul</p>
   </td>
   <td>
    <p>The preference panel</p>
   </td>
  </tr>
 </tbody>
</table>

<p>Â <span class="inlineIndicator todo todoInline"><strong>FIXME:</strong> <em>Figure 16: Source file structure</em></span></p>

<h4 id="Deciding_the_format_for_your_preferences">Deciding the format for your preferences</h4>

<p>Next you need to determine the names, types, and values for your preferences (Table 6). Each preference should be prefixed with something that uniquely identifies your extensionâin this case, weâll use <em>extensions.sessionstore</em>.</p>

<p>Table 6: Preference formats</p>

<p><span class="inlineIndicator todo todoInline"><strong>FIXME:</strong> <em>Make the table cleaner</em></span></p>

<table style="width: 590px;">
 <tbody>
  <tr>
   <td>
    <p>Preference name</p>
   </td>
   <td>
    <p>Type</p>
   </td>
   <td>
    <p>Value</p>
   </td>
  </tr>
  <tr>
   <td>
    <p>extensions.sessionstore.warnOnClear</p>
   </td>
   <td>
    <p>Boolean</p>
   </td>
   <td>
    <p>Activated when deleting sessions. If true, causes a confirmation dialog to appear; if false, deletes immediately.</p>
   </td>
  </tr>
  <tr>
   <td>
    <p>extensions.sessionstore.replaceTabs</p>
   </td>
   <td>
    <p>Integer</p>
   </td>
   <td>
    <p>Activated when restoring sessions.</p>

    <p>0: Leave current tabs</p>

    <p>1: Overwrite current tabs</p>

    <p>2: Ask each time</p>
   </td>
  </tr>
 </tbody>
</table>

<h4 id="Defaults_definition_file">Defaults definition file</h4>

<p>Listing 25 gives the contents for the default preferences, as described in Table 6. Save this in <em>defaults\preferences\sessionstoreprefs.js</em>.</p>

<p>Listing 25: Content for sessionstore-prefs.js</p>

<pre class="brush: js">pref("extensions.sessionstore.warnOnClear", true);
pref("extensions.sessionstore.replaceTabs", 2);</pre>

<h4 id="Creating_the_preference_panel">Creating the preference panel</h4>

<p>Create <em>prefs.xul</em> with the contents from Listing 26. The <code>prefwindow</code> element is a special root element for creating preference panels, with the <code>prefpane</code> element subordinate to it. You can create an interface similar to Firefoxâs options window by inserting multiple <code>prefpane</code> elements, which allows users to switch between panels by clicking buttons. The preference element creates a preference value that can be written and read by the preference panel, with the preference name indicated by the <code>name</code> attribute, and the type by the <code>type</code> attribute. Furthermore, by matching the preference elementâs id to the <code>preference</code> attribute of a checkbox or radiogroup, you can specify the interface widget that will be used to set your preferences. Add the contents of Listing 27 to your install manifest to make it so that the Add-on Manager can open your preference panel.</p>

<p>Listing 26: Content for prefs.xul</p>

<pre class="brush: xml">&lt;?xml version="1.0"?&gt;
&lt;?xml-stylesheet href="chrome://global/skin/" type="text/css"?&gt;
&lt;prefwindow id="sessionstorePrefs" xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul"
     title="Session Store Preferences"&gt;
  &lt;prefpane&gt;
    &lt;preferences&gt;
      &lt;preference id="extensions.sessionstore.warnOnClear"
           name="extensions.sessionstore.warnOnClear"
           type="bool" /&gt;
      &lt;preference id="extensions.sessionstore.replaceTabs"
           name="extensions.sessionstore.replaceTabs"
           type="int" /&gt;
    &lt;/preferences&gt;
    &lt;checkbox label="Confirm before clearing sessions"
         preference="extensions.sessionstore.warnOnClear" /&gt;
    &lt;groupbox&gt;
      &lt;caption label="When restoring session:" /&gt;
      &lt;radiogroup preference="extensions.sessionstore.replaceTabs"&gt;
        &lt;radio value="0" label="Keep current tabs" /&gt;
        &lt;radio value="1" label="Replace current tabs"/&gt;
        &lt;radio value="2" label="Ask me every time" /&gt;
      &lt;/radiogroup&gt;
    &lt;/groupbox&gt;
  &lt;/prefpane&gt;
&lt;/prefwindow&gt;

</pre>

<p>Listing 27: Additional content for install.rdf</p>

<pre class="brush: xml">&lt;em:optionsURL&gt;chrome://sessionstore/content/prefs.xul&lt;/em:optionsURL&gt;
</pre>

<h4 id="Changing_behavior_through_preference_values">Changing behavior through preference values</h4>

<p>In Listing 28, we add a preference that allows a confirmation dialog to appear when we delete sessions. When we get the preference value from JavaScript, we take advantage the XPCOM <code>nslPrefService</code> interface, using the <code>getBoolPref</code> and <code>getIntPref</code> methods as appropriate to the data type. In Listing 28, we get the <code>nslPrefBranch</code> object that lets us read and write all preferences beginning with the prefix <code>extensions.sessionstore.</code>, which is what lets us use the <code>getBoolPref</code> method to get the value.</p>

<p><span class="inlineIndicator todo todoInline"><strong>FIXME:</strong> <em>Listing 28: nslPrefBranch object demonstration</em></span></p>

<h4 id="Operations_check_5">Operations check</h4>

<p>Weâve revised the install manifest, so we need to reinstall the extension (see the part â<em>Operations checks on revised source files</em>â). Once youâve reinstalled it, first open <em>about:config</em>, and confirm that the previous preference values are set. Next, select Session Store from the Add-on Manager and click the â<em>Preferences</em>â button to bring up the preference panel. Try changing the preferences, and see if those changes are reflected when you restore or delete sessions.</p>

<h3 id="Phase_4_XPI_packaging">Phase 4: XPI packaging</h3>

<p>This procedure is unchanged from Phase 5 in the â<em>Developing a Simple Extension</em>â section, but take note of everything within the defaults folder.</p>

<h2 id="Conclusion_2">Conclusion</h2>

<p>Weâve looked at how to build extensions at an extremely basic level in this chapter, and there are a lot of other interesting features to explore in extensions and XUL. But I hope that having gotten your feet wet with extensions development, youâll want to dive in now.</p>

<h3 id="Operations_checks_on_revised_source_files">Operations checks on revised source files</h3>

<p>In the interest of developing extensions efficiently, you want to minimize the number of steps between revising a source file and running an operations check on it. For each type of source file, thereâs a different procedure to follow. The following all assumes that youâve disabled the XUL cache as discussed in the section â<em>Setting up your development environment</em>â.</p>

<h4 id="XUL_that_opens_new_windows">XUL that opens new windows</h4>

<p>Confirm changes by closing and reopening window. If the XUL is displaying as a sidebar, reopen the sidebar. Likewise with any JavaScript, DTDs, or style sheets referenced by the XUL.</p>

<h4 id="XUL_overlaying_other_windows">XUL overlaying other windows</h4>

<p>You need to force the overlay-target XUL to reload. If itâs the browser window thatâs the target, you can simply open a new browser window to confirm the changes.</p>

<h4 id="properties_file">properties file</h4>

<p>If you make changes to a properties file in the locale package, those changes will not be reflected in Firefox until you relaunch it.</p>

<h4 id="XPCOM_components_inside_the_components_directory">XPCOM components inside the components directory</h4>

<p>You will need to delete the files <em>compreg.dat</em> and<em> xpti.dat</em> inside the profile folder and relaunch Firefox.</p>

<h4 id="Default_preferences_file_inside_the_defaultspreferences_directory">Default preferences file inside the defaults\preferences directory</h4>

<p>You will need to relaunch Firefox.</p>

<h4 id="chrome.manifest">chrome.manifest</h4>

<p>You will need to relaunch Firefox.</p>

<h4 id="install.rdf">install.rdf</h4>

<p>You will need to temporarily uninstall the extension and then reinstall it. In practice, what youâll do is remove the pointer file, relaunch Firefox, return the pointer file, and relaunch Firefox again. On a Linux system, use the touch command on the directory pointed at by the pointer file to change its âlast changedâ date, and avoid the relaunching.</p>

<h3 id="The_session_store_API">The session store API</h3>

<p>The session store API<sup><a href="#footnote4" id="from_footnote4">4</a></sup> is one of the new developer-oriented features in Firefox 2. Using the various methods in the <code>nslSessionStore</code> interface, which is an XPCOM service, you can easily save and restore session states. Functions in Firefox that let you reopen the last closed tab, or restore to your previous state after a crash, are all implemented through this API.</p>

<p>We used two methods in the <code>nslSessionStore</code> interface in this project. Letâs look at how they work.</p>

<h4 id="getBrowserState()">getBrowserState()</h4>

<p>Returns a JSON-formatted<sup><a href="#footnote5" id="from_footnote5">5</a></sup> text string representing the state of every currently open browser window. This string includes extensive information regarding every open window and tab, the forward/back history for each tab, page scroll position, text zoom, contents of form elements, etc.</p>

<h4 id="setWindowState(aWindow_aState_aOverwrite)">setWindowState(aWindow, aState, aOverwrite)</h4>

<p>Restores the browser window indicated by the parameter aWindow to the state indicated by aState. If aOverwrite is true, the currently open tab is overwritten; otherwise, a new tab is created for the restored content.</p>

<p>Â </p>

<h3 id="JavaScript_debugging_methods">JavaScript debugging methods</h3>

<h4 id="alert">alert</h4>

<p>The easiest way to debug javascvript is using the window.alert method to display variables in a dialog (Listing 29). Except for asynchronous processes, all processing stops while the dialog is up, so this technique is useful when you want to pin down a value that can vary during a process.</p>

<p>Listing 29: Check the value of variable foo</p>

<pre class="brush: js">alert(foo);</pre>

<h4 id="dump">dump</h4>

<p>In a Windows environment, you can launch Firefox with the <code>-console</code> argument, which opens a dump console. Using the <code>dump</code> method, you can send text to the dump console (Listing 30). The text output being sent to the console does not suspend any other processes, and this is most useful when thereâs a high volume of messages being output. In order to use the dump method most effectively, youâll need to follow the recommendations in â<em>Setting up your development environment</em>â. Note that in a Windows environment, non-latin text sent to the dump console will get corrupted.</p>

<p>Listing 30: List the properties of obj</p>

<pre class="brush: js">for (var i in obj) {
  dump(i + " : " + obj[i] + "\n");
}</pre>

<h4 id="error_console">error console</h4>

<h5 id="The_nslConsoleService_interface">The nslConsoleService interface</h5>

<p>Using the <code>logStringMessage</code> method of the <code>nslConsoleService</code> interface, which is an XPCOM service, you can output text to the âmessageâ panel of the error console. Non-latn text will appear correctly here. If you are going to be issuing messages to the error console frequently, itâs handy to define a function like that in Listing 31.</p>

<p>Listing 31: Function to output messages to the error console</p>

<pre class="brush: js">function log(aText) {
  var console = Components.classes["@mozilla.org/consoleservice;1"]
      .getService(Components.interfaces.nsIConsoleService);
  console.logStringMessage(aText);
}</pre>

<h5 id="Components.utils.reportError_method">Components.utils.reportError method</h5>

<p>Another way to output text to the same error console is with the <code>Components.utils.reportError</code> method. This will send its output to the âerrorâ panel of the error console.</p>

<p>Â </p>

<p>Â </p>

<h3 id="Where_can_I_learn_more_about_the_XPCOM_interface">Where can I learn more about the XPCOM interface?</h3>

<p><span class="inlineIndicator todo todoInline"><strong>FIXME:</strong> <em>add links:</em></span></p>

<p>The Mozilla Development Center has extensive documentation on the <code>nsISessionStore</code> interface weâve discussed in this section<sup><a href="#footnote6" id="from_footnote6">6</a></sup>. In general, details (IDL) on the XPCOM interface are available from the Mozilla Cross-Reference<sup><a href="#footnote7" id="from_footnote7">7</a></sup>, which includes source code with full-text searching available.</p>

<div class="note" id="footnote1"><a href="#from_footnote1">1</a> - In Windows XP, you can use the âcompress folderâ command to create a zip archive, but I recommend installing a tool like 7-Zip that lets you specify the compression ratio. Itâs OK to have a low compression ratio when you are creating the jar file, and a high compression ratio when creating the xpi file.</div>

<div class="note" id="footnote2"><a href="#from_footnote2">2</a> - An event generated by an element âbubbles upâ to the root.</div>

<div class="note" id="footnote3"><a href="#from_footnote3">3</a> - See Code Snippets: File I/O-MDC (<a class="external" href="http://developer.mozilla.org/en/docs/Code_snippets:File_I/O#Getting_special_files" rel="freelink">http://developer.mozilla.org/en/docs..._special_files</a>) for techniques on getting special folders, like the profile folder.</div>

<div class="note" id="footnote4"><a href="#from_footnote4">4</a> - See Session Store API-MDC (<a class="external" href="http://developer.mozilla.org/en/Session_store_API" rel="freelink">http://developer.mozilla.org/en/Session_store_API</a>)</div>

<div class="note" id="footnote5"><a href="#from_footnote5">5</a> - JSON is short for JavaScript Object Notation. It is a data format that can easily be read from and written to in JavaScript.</div>

<div class="note" id="footnote6"><a href="#from_footnote6">6</a> - nslSessionStore-MDC (<a class="external" href="http://developer.mozilla.org" rel="freelink">http://developer.mozilla.org</a>)</div>

<div class="note" id="footnote7"><a href="#from_footnote7">7</a> - Mozilla Cross-Reference (<a class="external" href="http://mxr.mozilla.org/" rel="freelink">http://mxr.mozilla.org/</a>)</div>

<p>Â </p>

<div class="prevnext" style="text-align: right;">
<p><a href="/en-US/docs/Firefox_addons_developer_guide/Using_XPCOMâImplementing_advanced_processes" style="float: left;">Â« Previous</a><a href="/en-US/docs/Firefox_addons_developer_guide/Firefox_extensions_and_XUL_applications">Next Â»</a></p>
</div>

<p>Â </p>
