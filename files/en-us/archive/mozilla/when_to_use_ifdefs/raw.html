<p>The mozilla codebase is used for many different projects and products, including Firefox, Thunderbird, XULRunner, and many others. Sometimes the same basic code is used for multiple projects, but there are small differences needed. "ifdefs", or conditional instructions, are used to build different code
</p>
<h3 id="What_are_ifdefs" name="What_are_ifdefs"> What are ifdefs </h3>
<p>ifdefs are conditional directives to a text preprocessor which mark that certain blocks of code are used only in certain conditions. In this document, the term is used more loosely to discuss any kind of conditional that differentiates between different build configurations.
</p>
<h3 id="When_are_ifdefs_used.3F" name="When_are_ifdefs_used.3F"> When are ifdefs used? </h3>
<p>There are three major kinds of ifdefs in use in the mozilla tree: platform/widget ifdefs, feature ifdefs, and application-specific ifdefs:
</p>
<h4 id="Platform.2Fwidget_ifdefs" name="Platform.2Fwidget_ifdefs"> Platform/widget ifdefs </h4>
<p>The mozilla code will frequently need to differentiate between code for different platforms or widget sets. These ifdefs are generally always acceptable. The only time when they might be a problem is in cross-platform extension code and locales: since this code is downloaded on multiple platforms, platform-specific ifdefs are generally out of the question.
</p><p>For an example of platform-specfic ifdefs, see <a class="external" href="http://bonsai.mozilla.org/cvsblame.cgi?file=mozilla/xpcom/ds/nsCRT.h&amp;rev=3.72&amp;mark=48-61#46">nsCRT.h</a>.
</p>
<h4 id="Feature_ifdefs" name="Feature_ifdefs"> Feature ifdefs </h4>
<p>The mozilla code has many features that can be enabled or disabled by configure flags. For instance, it is possible to disable most of the XUL rendering engine by specifying --disable-xul when configuring the build. When adding ifdefs that implement these configure flags, care must be taken to obey the <b>build dependencies</b>. For instance, XPCOM, the SpiderMonkey JavaScript engine, and the networking engine do not know anything about XUL and should not have any ifdefs based on --disable-xul.
</p><p>One special "feature ifdef" that deserves special attention is "MOZ_XUL_APP". This variable marks any application that is using the "toolkit". MOZ_XUL_APP ifdefs are not acceptable in <a class="external" href="http://bonsai.mozilla.org/cvsblame.cgi?file=mozilla/Makefile.in&amp;rev=1.291&amp;mark=146-208#144">tier 9</a>, but are acceptable (even necessary) in later tiers.
</p><p>For an example of feature ifdefs, see <a class="external" href="http://bonsai.mozilla.org/cvsblame.cgi?file=mozilla/layout/Makefile.in&amp;rev=1.22&amp;mark=57-59,61-63,65-67#55">layout/Makefile.in</a>.
</p>
<h4 id="Application-specific_ifdefs" name="Application-specific_ifdefs"> Application-specific ifdefs </h4>
<p>Finally, each application/project needs to build different pieces of code. <b>Application ifdefs should only be made in application-specific code.</b> This is the trickiest kind of ifdef, because it is frequently hard to determine what code is "shared" and what code is "application-specific". As a general rule, any code in <b><a class="external" href="http://bonsai.mozilla.org/cvsblame.cgi?file=mozilla/Makefile.in&amp;rev=1.291&amp;mark=132-144#130">tier 2</a>, <a class="external" href="http://bonsai.mozilla.org/cvsblame.cgi?file=mozilla/Makefile.in&amp;rev=1.291&amp;mark=146-208#144">tier 9</a>, or <a class="external" href="http://bonsai.mozilla.org/cvsblame.cgi?file=mozilla/Makefile.in&amp;rev=1.291&amp;mark=210-301#208">tier 50</a></b> is shared code, and should not have application-specific ifdefs. Any code in later tiers is application-specific. This rule has many exceptions, some of which are listed here:
</p>
<ul><li> The code in editor/ui/ is built by the suite, standalone composer, and thunderbird, but it is considered application-specific.
</li><li> The code in xpfe/ (except for xpfe/appshell/ and xpfe/components/shistory/) is a hodgepodge mess of "toolkit" and "application-specific" code. This code is all going to be moved elsewhere (most of it to toolkit/ or suite/), but for the time being most application-specific ifdefs are allowed because we can't help it. If you're not sure, ask <a>Benjamin Smedberg</a>.
</li></ul>
<p>For an example of an application-specific ifdef that is bad and should be removed, see <a class="external" href="http://bonsai.mozilla.org/cvsblame.cgi?file=mozilla/toolkit/xre/nsNativeAppSupportWin.cpp&amp;rev=1.19&amp;mark=687-694#684">nsNativeAppSupportWin.cpp</a>.
</p>
<h3 id="Types_of_ifdef" name="Types_of_ifdef"> Types of ifdef </h3>
<p>There are two major types of ifdef: preprocessor ifdefs and makefile ifdefs. Preprocessor ifdefs are generally easy to spot: in C, C++, and plaintext preprocessed code there will be an #ifdef or #if instruction.
</p><p>Makefile ifdefs, however, are sometimes harder to spot and can cause hidden issues that are much more serious. Makefile ifdefs are used to build or not-build certain directories. This can mean that there are completely different interfaces with the same name which are built conditionally. For example (at the time of writing) there are two nsIExtensionManager interfaces: <a href="https://dxr.mozilla.org/mozilla-central/source/toolkit/mozapps/extensions/public/nsIExtensionManager.idl" rel="custom">toolkit version</a> and <a href="https://dxr.mozilla.org/mozilla-central/source/xpfe/components/extensions/public/nsIExtensionManager.idl" rel="custom">suite version</a>. The makefile ifdefs that choose which one to build are not obvious (see <code><a href="https://dxr.mozilla.org/mozilla-central/source/Makefile.in" rel="custom">Makefile.in</a></code> and <code><a href="https://dxr.mozilla.org/mozilla-central/source/xpfe/components/Makefile.in" rel="custom">xpfe/components/Makefile.in</a></code>). If you are introducing a makefile ifdef of any sort, please ask review from one of the build-config peers: <a>Benjamin Smedberg</a> is generally happy to review these changes.
</p>