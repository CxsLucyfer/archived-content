
<p>The Mail Summary Files (.msf) are used to store summary information about messages and threads in a folder, and some meta information about the folder.</p>
<p> </p>
<h3 id="nsIMsgDatabase" name="nsIMsgDatabase">nsIMsgDatabase</h3>
<p>The main access point to the summary information is <a class="external" href="http://mxr.mozilla.org/comm-central/source/mailnews/db/msgdb/public/nsIMsgDatabase.idl#122" title="http://mxr.mozilla.org/comm-central/source/mailnews/db/msgdb/public/nsIMsgDatabase.idl#122">nsIMsgDatabase</a>. nsIMsgFolder has a <a class="external" href="http://mxr.mozilla.org/comm-central/source/mailnews/base/public/nsIMsgFolder.idl#360" title="http://mxr.mozilla.org/comm-central/source/mailnews/base/public/nsIMsgFolder.idl#360">method</a> to get the database for a folder.</p>
<p>nsIMsgDatabase is an abstraction on top of <a class="external" href="http://mxr.mozilla.org/mozilla/source/db/mdb/public/mdb.h#39">MDB</a>, which is a set of db interfaces. The MDB interfaces are implemented in Mork. MDB is a schema-less db interface, so it's trivial to add new attributes without regenerating the db, and it's trivial for older code to read newer databases, because the code can ignore but maintain the attributes it doesn't know about. If we were to replace Mork, we could do it at the MDB level (unlikely, because implementing the MDB interface on top of a different DB would be very hard), the nsIMsgDatabase level (probably the easiest), or we could invent a whole new database interface and change all the code that uses the nsIMsgDatabase interface.</p>
<h3 id="Message_Headers" name="Message_Headers">Message Headers</h3>
<p>The message header object implements the <a class="external" href="http://mxr.mozilla.org/comm-central/source/mailnews/base/public/nsIMsgHdr.idl#51" title="http://mxr.mozilla.org/comm-central/source/mailnews/base/public/nsIMsgHdr.idl#51">nsIMsgDBHdr</a> interface. This includes a set of per-message <a class=" external" href="http://mxr.mozilla.org/comm-central/source/mailnews/base/public/MailNewsTypes.h#94" title="http://mxr.mozilla.org/comm-central/source/mailnews/base/public/MailNewsTypes.h#94">flags</a>, the more commonly used headers, e.g., subject, sender, from, to, cc, date, etc) and a few other attributes, e.g., keywords. There are a set of generic <a class="external" href="http://mxr.mozilla.org/comm-central/source/mailnews/base/public/nsIMsgHdr.idl#55" title="http://mxr.mozilla.org/comm-central/source/mailnews/base/public/nsIMsgHdr.idl#55">property methods</a> so that core code and extensions can set attributes on msg headers without changing nsIMsgHdr.idl.</p><h3 id="Msg_Threads" name="Msg_Threads">Msg Threads</h3>
<p>We store thread information persistently in the database and expose these object through the [<a class="external" href="http://mxr.mozilla.org/seamonkey/source/mailnews/base/public/nsIMsgThread.idl#47">nsIMsgThread interface</a>. So the db knows which messages are in a thread, which message a message is in reply to, etc. This allows us to store watch/ignore information on a thread object, and avoids having to generate threading information whenever a folder is open. This has arguably been more trouble than it's been worth, especially when we've threaded incorrectly.</p>
<h3 id="Meta_Information" name="Meta_Information">Meta Information</h3>
<p>The <a class="external" href="http://mxr.mozilla.org/comm-central/source/mailnews/db/msgdb/public/nsIDBFolderInfo.idl#42" title="http://mxr.mozilla.org/comm-central/source/mailnews/db/msgdb/public/nsIDBFolderInfo.idl#42">nsIDBFolderInfo</a> interface handles the folder meta data. This also supports <a class="external" href="http://mxr.mozilla.org/comm-central/source/mailnews/db/msgdb/public/nsIDBFolderInfo.idl#72" title="http://mxr.mozilla.org/comm-central/source/mailnews/db/msgdb/public/nsIDBFolderInfo.idl#72">generic properties</a>. There is a <a class="external" href="http://mxr.mozilla.org/comm-central/source/mailnews/db/msgdb/public/nsIMsgDatabase.idl#134" title="http://mxr.mozilla.org/comm-central/source/mailnews/db/msgdb/public/nsIMsgDatabase.idl#134">method</a> on nsIMsgDatabase to get the dbFolderInfo.</p>
<p> </p>
<h3 id="Mork_-_the_Good.2C_the_Bad.2C_and_the_Ugly" name="Mork_-_the_Good.2C_the_Bad.2C_and_the_Ugly">Mork - the Good, the Bad, and the Ugly</h3>
<p>Mork has a horrible reputation and we're always asked why we don't just replace it with some other db. The bottom line is that we haven't been able to justify the very large cost of doing so because there won't be any benefit to the end-user, at least in the short term. Here are some of the trade-offs:</p>
<p>The mork file format is ascii text, but unreadable. If it were binary, there would be less complaints, and it would be smaller.</p>
<p>The MDB interfaces are overly complex, and unfamiliar. The Mork code uses a lot of terminology of its own invention, as near as I can tell (though I suspect most DB code would be that way). It's difficult to fix bugs in Mork. But, on the other hand, there are very few bugs in the Mork code.</p>
<p>Mork loads the whole database in memory, and keeps it there. This makes it very fast to access our database objects, but it does increase memory usage.</p>
<p>Mork assumes the caller will do file locking, so two processes or threads writing to the same database can corrupt it. But I believe sql-lite has the same problem.</p>
<p>Mork is schema-less. This means we can add properties to rows arbitrarily. And we only pay the storage cost for a property if the row has the property set. We can still index on these properties, if we want. We would need the equivalent capabilities if we replaced Mork.</p>