<p></p><section class="Quick_links" id="Quick_Links">

<ol>
 <li data-default-state="closed"><a href="/en-US/docs/Mozilla/B2G_OS/Building_and_installing_B2G_OS">Build and install</a>
  <ol>
   <li><strong><a href="/en-US/docs/Mozilla/B2G_OS/Building_and_installing_B2G_OS">Build and install overview</a></strong></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Building_and_installing_B2G_OS/B2G_OS_build_process_summary">B2G OS build process summary</a></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/B2G_OS_build_prerequisites">Build prerequisites</a></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Preparing_for_your_first_B2G_build">Preparing for your first build</a></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Building">Building B2G OS</a></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Building_and_installing_B2G_OS/B2G_installer_add-on">B2G installer add-on</a></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Building_and_installing_B2G_OS/Building_for_Flame_on_OS_X">Building B2G OS for Flame on Mac OS X</a></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Choosing_how_to_run_Gaia_or_B2G">Choosing how to run Gaia or B2G OS</a></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Building_and_installing_B2G_OS/Compatible_Devices">Compatible Devices</a></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Installing_on_a_mobile_device">Installing B2G OS on a mobile device</a></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Building_and_installing_B2G_OS/B2G_OS_update_packages">Creating and applying B2G OS update packages</a></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Building/FOTA_community_builds">Building and installing FOTA community builds</a></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Building_and_installing_B2G_OS/B2G_Build_Variables_Reference_Sheet">B2G build variables reference sheet</a></li>
  </ol>
 </li>
 <li data-default-state="closed"><a href="/en-US/docs/Mozilla/B2G_OS/Porting_B2G_OS">Porting B2G OS</a>
  <ol>
   <li><strong><a href="/en-US/docs/Mozilla/B2G_OS/Porting_B2G_OS">Porting overview</a></strong></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Porting_B2G_OS/basics">Porting basics</a></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Porting_B2G_OS/Porting_on_CyanogenMod">Porting on CyanogenMod</a></li>
  </ol>
 </li>
 <li data-default-state="closed"><a href="/en-US/docs/Mozilla/B2G_OS/Developing_Gaia">Developing Gaia</a>
  <ol>
   <li><strong><a href="/en-US/docs/Mozilla/B2G_OS/Developing_Gaia">Developing Gaia overview</a></strong></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Developing_Gaia/Running_the_Gaia_codebase">Running the Gaia codebase</a></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Mulet">Run Gaia on desktop using Mulet</a></li>

   <li><a href="/en-US/docs/Mozilla/B2G_OS/Developing_Gaia/Understanding_the_Gaia_codebase">Understanding the Gaia codebase</a></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Developing_Gaia/Making_Gaia_code_changes">Making Gaia code changes</a></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Developing_Gaia/Testing_Gaia_code_changes">Testing Gaia code changes</a></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Developing_Gaia/Submitting_a_Gaia_patch">Submitting a Gaia patch</a></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Developing_Gaia/Build_System_Primer">Gaia build system primer</a></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Developing_Gaia/Different_ways_to_run_Gaia">Different ways to run Gaia</a></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Developing_Gaia/make_options_reference">Make options reference</a></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Developing_Gaia/Gaia_tools_reference">Gaia tools reference</a></li>
  </ol>
 </li>
 <li><a href="/en-US/docs/Mozilla/B2G_OS/API">B2G OS APIs</a></li>
</ol>
</section><p></p><p><span style="background-color: rgb(214, 227, 254) ! important; border-color: black ! important; border-style: solid ! important; border-width: 1px ! important; display: none; font-size: xx-small ! important; left: 0px ! important; line-height: 130% ! important; padding: 0px 2px ! important; position: fixed ! important; top: 0px ! important;">S</span></p>

<div class="summary">
<p><a href="http://valgrind.org">Valgrind<span style="border-style: solid ! important; border-width: 1px ! important; display: none; float: none ! important; font-family: arial,sans-serif; font-size: xx-small ! important; line-height: 130% ! important; margin-left: 2px; max-width: 20px; overflow: visible ! important; padding: 0px 2px ! important;">DSS</span></a>'s Memcheck tool detects C++ memory management errors that can lead to stability and security problems: use of freed memory, heap array overruns, uses of uninitialised values, and memory leaks.  It is included in the Firefox OS tree, and can be run on certain phones that have adequate resources. This article explains how to use it.</p>
</div>

<h2 id="Requirements">Requirements</h2>

<p>Before running Valgrind against Firefox OS, it's recommended that developers familiarize themselves with the <a href="/en-US/docs/Debugging_Mozilla_with_Valgrind">Debugging Mozilla with Valgrind<span style="border-style: solid ! important; border-width: 1px ! important; display: none; float: none ! important; font-family: arial,sans-serif; font-size: xx-small ! important; line-height: 130% ! important; margin-left: 2px; max-width: 20px; overflow: visible ! important; padding: 0px 2px ! important;">DSD</span><span style="border-style: solid ! important; border-width: 1px ! important; display: none; float: none ! important; font-family: arial,sans-serif; font-size: xx-small ! important; line-height: 130% ! important; margin-left: 2px; max-width: 20px; overflow: visible ! important; padding: 0px 2px ! important;">DSD</span><span style="border-style: solid ! important; border-width: 1px ! important; display: none; float: none ! important; font-family: arial,sans-serif; font-size: xx-small ! important; line-height: 130% ! important; margin-left: 2px; max-width: 20px; overflow: visible ! important; padding: 0px 2px ! important;">DSG</span></a> article. Most of the information it contains is relevant to running against Firefox OS, though many of the build and command line steps are taken care of by the Firefox OS build and execution scripts.</p>

<p>To run Valgrind against Firefox OS on a phone, a phone with higher than normal specs is required. Valgrind is resource intensive, and will generally cause Out Of Memory errors on phones with anything less than 1GB of RAM. As of this writing (2015-06-10), Valgrind is known to work with Firefox OS running on Flame phones with 1GB or RAM and Nexus 5 phones with 2GB of RAM.  It should also run on Geeksphone Keons and similar spec phones. Look at <a href="/en-US/Firefox_OS/Phones">Phone and device data</a> for more details of the phones available.</p>

<p>The number one problem is running out of memory.  If your phone's kernel supports swap space, your situation is improved.  You can tell whether your phone supports swap space by looking for the file <code>/proc/swaps</code> -- if it is present, you are in luck.  If so, prepare a swap file on the host, move it to the phone, and enable it:</p>

<pre>dd if=/dev/zero of=swapfile800M bs=1024 count=781250
mkswap swapfile800M
gzip --fast swapfile800M
adb push swapfile800M.gz /data
adb shell gzip -d /data/swapfile800M.gz
adb shell swapon /data/swapfile800M

adb shell cat /proc/swaps
# should produce a line like this:
# /data/swapfile800M                      file        781244    0    -2</pre>

<p>If your phone doesn't have swap, you may experience Nuwa-created processes being OOM-killed, and hence incomplete or confusing functionality.  Try to use a phone with at least 2GB of RAM in this case.  Flame, at least, does support swap.  You need to be careful which partition the swap file is placed on.  If you inadvertantly put it on a <code>btrfs</code> partition, you'll get complaints about holes in swap files when you try to run <code>swapon</code>.</p>

<h2 id="Running_Valgrind_on_FxOS_Phones">Running Valgrind on FxOS Phones</h2>

<p>Let's look at the process of running Valgrind.</p>

<h3 id="Compiling">Compiling</h3>

<p>To build Firefox OS with valgrind enabled, add the following to to the <a href="/en-US/Firefox_OS/Customization_with_the_.userconfig_file"><code>.userconfig</code> file</a>.</p>

<pre>export B2G_VALGRIND=1
export DISABLE_JEMALLOC=1
</pre>

<p>Building debug (<code>B2G_DEBUG</code>) is also recommended. Building with no optimizations (<code>B2G_NOOPT</code>) makes things run almost unusably slow, and is not recommended except in cases where it is thought that optimizations may be obfuscating errors.</p>

<p>And add the following to the end of <code>gonk-misc/default-gecko-config</code>:</p>

<pre>ac_add_options --enable-optimize="-g -O2"
ac_add_options --enable-valgrind
ac_add_options --disable-jemalloc
ac_add_options --disable-sandbox</pre>

<p>Disabling sandboxing is unfortunately required, since not doing so causes the Valgrind processes to be killed by the sandbox mechanism.</p>

<h3 id="Running">Running</h3>

<div class="note">
<p>Note: Running Valgrind on a Firefox OS phone is done in the context of the phone, not the host operating system. This means that developers can use any platform that has <a href="/en-US/Firefox_OS/Debugging/Installing_ADB">adb</a> available and will execute the <code>run-valgrind.sh</code> script to run valgrind on the phone.</p>
</div>

<p>To run Firefox OS under valgrind, use <a href="https://github.com/mozilla-b2g/B2G/blob/master/run-valgrind.sh">the <code>run-valgrind.sh</code> script from the B2G directory</a>. This script does the following:</p>

<ol>
 <li>Remounts the phone file system as r/w.</li>
 <li>Copies the current debug <code>libxul.so</code> with full symbols to the phone. As this file is many hundreds of MB, this step can take about two minutes to finish. It needs to be redone every time a new build is made. To run valgrind without the <code>libxul</code> copy step, run this command:
  <pre class="brush: bash">run-valgrind.sh nocopy</pre>
 </li>
 <li>Reboots the phone.</li>
 <li>Kills the b2g process that starts up on phone startup.</li>
 <li>Runs its own b2g process under valgrind.</li>
</ol>

<p>All valgrind output will be written to the <code>stdout</code> of the terminal executing the <code>run-valgrind.sh</code> script. This can either be read in the terminal or piped to a file. </p>

<p><code>run-valgrind.sh</code> starts Valgrind with a suitable set of command line parameters.  If you want to pass in extra parameters that override the default set, specify them using the <code>EXTRA_ARGS</code> environment variable:</p>

<pre>EXTRA_ARGS="-v" run-valgrind.sh nocopy</pre>

<div class="note">
<p><strong>Note</strong>: Since the <code>run-valgrind.sh</code> script owns the adb process running the b2g process, killing the script will also kill b2g and valgrind on the phone. It is recommended that the phone be rebooted after running a valgrind session, as it can leave things in an odd state.</p>
</div>

<h3 id="Debug_info_for_system_libraries">Debug info for system libraries</h3>

<p>To get good quality stack traces for system libraries, you need to put them on the phone:</p>

<pre>(cd out/target/product/flame &amp;&amp; adb push symbols /sdcard/symbols-for-valgrind)</pre>

<p><code>run-valgrind.sh</code> will automatically cause Valgrind to read the debug objects in <code>/sdcard/symbols-for-valgrind</code>.  If you want to verify that Valgrind is reading them, start <code>run-valgrind.sh</code> with <code>EXTRA_ARGS="-v"</code>.</p>

<h2 id="Running_Valgrind_on_Firefox_OS_Desktop">Running Valgrind on Firefox OS Desktop</h2>

<p>Running valgrind against Firefox OS Desktop works the same way as running it against desktop Firefox. Consult the <a href="/en-US/docs/Debugging_Mozilla_with_Valgrind">Debugging Mozilla with Valgrind<span style="border-style: solid ! important; border-width: 1px ! important; display: none; float: none ! important; font-family: arial,sans-serif; font-size: xx-small ! important; line-height: 130% ! important; margin-left: 2px; max-width: 20px; overflow: visible ! important; padding: 0px 2px ! important;">DDS</span></a> page for more information. All of the relevant build flags will need to be added to <code>mozconfig</code>, and all platform-specific issues in the page will apply.</p>

<p>Note that running Valgrind on the desktop in OOP/process-per-tab mode will require adding the following option to make sure child processes are also traced:</p>

<pre class="brush: bash">--trace-children=yes</pre>

<h2 id="Maintaining_and_Updating_Firefox_OS_Valgrind">Maintaining and Updating Firefox OS Valgrind</h2>

<p>While patches are upstreamed when applicable, Valgrind for Firefox OS is maintained in a forked repository to keep things as up to date as possible while also dealing with the eccentricities of the Firefox OS build tree and versions.</p>

<h3 id="Updating_Valgrind_Repos">Updating Valgrind Repos</h3>

<div class="warning">
<p><strong>WARNING:</strong> EXPERIENCE WITH GIT REQUIRED. Do not attempt to upgrade the valgrind repos if you are not familiar with handling complex Git operations. Any updates to the github repo will mirror to <code>git.mozilla.org</code>, which will then be pulled by developers using the HEAD of the manifests repo. While breaking Valgrind will not break builds on anything that does not have Valgrind enabled (e.g. Buildbot automation), it will very much annoy developers who are trying to use it.</p>
</div>

<p>The main Firefox OS valgrind and VEX repos are at</p>

<ul>
 <li><a href="http://github.com/mozilla-b2g/valgrind">http://github.com/mozilla-b2g/valgrind</a></li>
 <li><a href="http://github.com/mozilla-b2g/vex">http://github.com/mozilla-b2g/vex</a></li>
</ul>

<p>The master branch is a pristine version of the SVN trunk of each of these repos, while the Firefox OS branch contains Firefox OS-specific patches rebased on top of the trunk.</p>

<div class="note">
<p><strong>Note: ALWAYS</strong> <strong>UPDATE BOTH REPOS AT THE SAME TIME</strong>. While they are two seperate repos, VEX is usually a submodule of Valgrind, and the HEAD of valgrind usually points to the HEAD of VEX.</p>
</div>

<p>These are replicated onto the <code>git.mozilla.org</code> domain for use in B2G manifests:</p>

<ul>
 <li><a href="http://git.mozilla.org/?p=b2g/valgrind.git;a=summary">http://git.mozilla.org/?p=b2g/valgrind.git;a=summary</a></li>
 <li><a href="http://git.mozilla.org/?p=b2g/valgrind.git;a=summary">http://git.mozilla.org/?p=b2g/vex.git;a=summary</a></li>
</ul>

<ol>
 <li>The main repos are kept in sync with the valgrind SVN with git svn. To pull updates to the repos, clone the valgrind and vex repos from github, then run the following:
  <pre class="brush: bash">git svn init -s [subversion repo url]
</pre>
 </li>
 <li>Pulling the SVN info will take hours, but when it is done, your tree should be in sync with the main Valgrind SVN.</li>
 <li>To pull further updates, the following set of commands is used:
  <pre class="brush: bash">git checkout master
git svn fetch
git svn rebase
git push [github-remote-name] master
git checkout fxos
git rebase master
</pre>
 </li>
 <li>There is a good chance that there will be patch conflicts during the Firefox OS branch rebase step. If you cannot work the issue out, email the author of the conflicting commit.</li>
 <li>After rebasing, run a full Firefox OS build with the <code>B2G_VALGRIND</code> flag to make sure that it still builds. The most common required fixes are listed in the scripts section below.</li>
 <li>Once you have rebased AND TESTED the build against the Firefox OS tree, you will have to force push the Firefox OS branch due to head change.
  <pre>git push -f [github-remote-name] fxos</pre>
 </li>
</ol>

<h3 id="Build_Install_and_Execution_Scripts">Build, Install, and Execution Scripts</h3>

<p>There are multiple scripts that are either part of the Valgrind Firefox OS branch or B2G repo that may need to be updated after a repo fetch.</p>

<h4 id="externalvalgrindandroid.mk">external/valgrind/android.mk</h4>

<p>This is the Android build system script. More often than not, this is where changes will need to be made, due to files being added/removed from the Valgrind tree. Use a <code>-j1</code> build to see which target is failing to build, and if it is missing a file or referencing a non-existent file, update that project's file list.</p>

<h4 id="externalvalgrindvalgrind.mk">external/valgrind/valgrind.mk</h4>

<p>This contains the list of packages that need to be built and added to the FxOS system image, referenced by <code>gonk-misc/b2g.mk</code>. This usually needs no update as it is rare for Valgrind to add new packages, but if they're needed, put them here.</p>

<h4 id="run-valgrind.sh">run-valgrind.sh</h4>

<p>The script for running Valgrind on the phone. If there are new command line arguments that are needed to run Valgrind on the phone, put them here. This is also where we copy the library with debug symbols to the phone, so any adjustment/change to that process should happen here.</p>