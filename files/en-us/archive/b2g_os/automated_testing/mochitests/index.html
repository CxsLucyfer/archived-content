---
title: Firefox OS mochitests
slug: Archive/B2G_OS/Automated_testing/Mochitests
tags:
  - Automated testing
  - Firefox OS
  - Gaia
  - Mobile
  - Testing
  - Tutorial
---
<p></p><section class="Quick_links" id="Quick_Links">

<ol>
 <li data-default-state="closed"><a href="/en-US/docs/Mozilla/B2G_OS/Building_and_installing_B2G_OS">Build and install</a>
  <ol>
   <li><strong><a href="/en-US/docs/Mozilla/B2G_OS/Building_and_installing_B2G_OS">Build and install overview</a></strong></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Building_and_installing_B2G_OS/B2G_OS_build_process_summary">B2G OS build process summary</a></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/B2G_OS_build_prerequisites">Build prerequisites</a></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Preparing_for_your_first_B2G_build">Preparing for your first build</a></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Building">Building B2G OS</a></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Building_and_installing_B2G_OS/B2G_installer_add-on">B2G installer add-on</a></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Building_and_installing_B2G_OS/Building_for_Flame_on_OS_X">Building B2G OS for Flame on Mac OS X</a></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Choosing_how_to_run_Gaia_or_B2G">Choosing how to run Gaia or B2G OS</a></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Building_and_installing_B2G_OS/Compatible_Devices">Compatible Devices</a></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Installing_on_a_mobile_device">Installing B2G OS on a mobile device</a></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Building_and_installing_B2G_OS/B2G_OS_update_packages">Creating and applying B2G OS update packages</a></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Building/FOTA_community_builds">Building and installing FOTA community builds</a></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Building_and_installing_B2G_OS/B2G_Build_Variables_Reference_Sheet">B2G build variables reference sheet</a></li>
  </ol>
 </li>
 <li data-default-state="closed"><a href="/en-US/docs/Mozilla/B2G_OS/Porting_B2G_OS">Porting B2G OS</a>
  <ol>
   <li><strong><a href="/en-US/docs/Mozilla/B2G_OS/Porting_B2G_OS">Porting overview</a></strong></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Porting_B2G_OS/basics">Porting basics</a></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Porting_B2G_OS/Porting_on_CyanogenMod">Porting on CyanogenMod</a></li>
  </ol>
 </li>
 <li data-default-state="closed"><a href="/en-US/docs/Mozilla/B2G_OS/Developing_Gaia">Developing Gaia</a>
  <ol>
   <li><strong><a href="/en-US/docs/Mozilla/B2G_OS/Developing_Gaia">Developing Gaia overview</a></strong></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Developing_Gaia/Running_the_Gaia_codebase">Running the Gaia codebase</a></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Mulet">Run Gaia on desktop using Mulet</a></li>

   <li><a href="/en-US/docs/Mozilla/B2G_OS/Developing_Gaia/Understanding_the_Gaia_codebase">Understanding the Gaia codebase</a></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Developing_Gaia/Making_Gaia_code_changes">Making Gaia code changes</a></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Developing_Gaia/Testing_Gaia_code_changes">Testing Gaia code changes</a></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Developing_Gaia/Submitting_a_Gaia_patch">Submitting a Gaia patch</a></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Developing_Gaia/Build_System_Primer">Gaia build system primer</a></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Developing_Gaia/Different_ways_to_run_Gaia">Different ways to run Gaia</a></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Developing_Gaia/make_options_reference">Make options reference</a></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Developing_Gaia/Gaia_tools_reference">Gaia tools reference</a></li>
  </ol>
 </li>
 <li><a href="/en-US/docs/Mozilla/B2G_OS/API">B2G OS APIs</a></li>
</ol>
</section><p></p><div class="summary">
<p><strong style="background-color: rgb(244, 247, 248); font-weight: bold;">Just one of the automated regression testing frameworks used by Mozilla, </strong><span class="seoSummary"><a href="https://developer.mozilla.org/en/docs/Mochitest">Mochitest</a> is an <a href="https://developer.mozilla.org/en/Mozilla_automated_testing" class="internal" title="En/Mozilla automated testing">automated testing framework</a> built on top of the <a href="http://mochi.github.io/mochikit/" class="external">MochiKit</a> JavaScript libraries that provides functional and API tests for Firefox OS. The Mochitests framework&apos;s tests report success or failure to the test harness using JavaScript function calls. The following sections take you through the steps needed to run Mochitests on Firefox OS via both B2G Desktop and device/emulator builds.</span></p>
</div>

<h2 id="Running_mochitests_on_B2G_desktop_builds">Running mochitests on B2G desktop builds</h2>

<p>Before running B2G on <a href="/en-US/Firefox_OS/Using_the_B2G_desktop_client">B2G desktop</a>, you&apos;ll need to <a href="/en-US/Firefox_OS/Using_the_B2G_desktop_client#Downloading_Gaia">install Gaia</a> and <a href="/en-US/Firefox_OS/Using_the_B2G_desktop_client#Generating_a_profile">build a profile</a>.</p>

<h3 id="Using_mach">Using mach</h3>

<p><strong>Mach</strong> is a command-line interface to help developers perform common tasks. Let&apos;s look at how to use it run mochitests. If you have a local B2G Desktop build with marionette enabled (specify <code>ENABLE_MARIONETTE=1</code> in your <a href="/en-US/docs/Configuring_Build_Options">mozconfig</a>), you can use <a href="/en-US/docs/Developer_Guide/mach" title="/en-US/docs/Developer_Guide/mach">mach</a> to run all of the mochitests. Run the following command from the root of your B2G source tree:</p>

<pre class="brush: bash">./mach mochitest --profile path/to/non/debug/gaia/profile
</pre>

<p>Alternatively you can set the <code>$GAIA_PROFILE</code> environment variable to avoid having to pass it in all the time.</p>

<p>To run a specific test, you can run the following:</p>

<pre class="brush: bash">export GAIA_PROFILE=path/to/non/debug/gaia/profile
./mach mochitest test_path</pre>

<p>To see mochitest options:</p>

<pre class="brush: bash">./mach mochitest --help</pre>

<p>Aside from requiring a gaia profile, b2g desktop mochitests support the same options and are run in the same way as desktop mochitests. See the <a href="/en-US/docs/Mochitest#Running_tests">Firefox mochitest documentation</a> for more information on running tests.</p>

<div class="note notecard">
<p><strong>Note</strong>: Before April 9th 2015, there was a separate command for b2g desktop builds: <code>mochitest-b2g-desktop,</code> but new builds always use the <code>mochitest-plain</code> command, and the system works out what type of build you have and deals with it accordingly.</p>
</div>

<div class="note notecard">
<p><strong>Note</strong>: Some contributors have been working on a project called <a href="https://github.com/ahal/b2g-commands">b2g-commands</a>, which aims to bring some of the commands available to desktop Firefox builds to B2G, such as easier diagnostics and build environment bootstrapping. Find more out by reading <a href="http://ahal.ca/blog/2014/b2g-commands/">Add more Mach to your B2G</a>.</p>
</div>

<h3 id="Using_the_mochitest_runner">Using the mochitest runner</h3>

<p>You can run <a href="https://developer.mozilla.org/en-US/docs/Mochitest" title="https://developer.mozilla.org/en-US/docs/Mochitest">mochitest-plain</a> on B2G Desktop builds.</p>

<h4 id="Prerequisites">Prerequisites</h4>

<ul>
 <li>You need to be using a Marionette-enabled build (compiled with <code>ENABLE_MARIONETTE=1</code> in mozconfig).</li>
 <li>You need to have manually generated a gaia profile (which you should already have if you&apos;ve been running a B2G desktop build manually); this must be a non-DEBUG profile.</li>
 <li>You cannot use a Gaia profile that was made with a custom <code>GAIA_DOMAIN</code>.</li>
</ul>

<h4 id="Setup_for_mozilla-b2g18_trees">Setup for mozilla-b2g18 trees</h4>

<pre class="brush: bash">cd $GECKO_OBJ_DIR
python $GECKO_SRC_DIR/python/virtualenv/virtualenv.py venv
source venv/bin/activate
cd $GECKO_SRC_DIR/testing/marionette/client
python setup.py develop</pre>

<div class="note notecard">
<p><strong>Note</strong>: you may need to install <a href="http://pypi.python.org/pypi/setuptools" title="http://pypi.python.org/pypi/setuptools">setuputils.py</a> before you run setup.py.</p>
</div>

<h4 id="Setup_for_trunk_trees_including_mozilla-central">Setup for trunk trees, including mozilla-central</h4>

<pre class="brush: bash">cd $GECKO_OBJ_DIR
source _virtualenv/bin/activate
</pre>

<h4 id="Running_the_tests">Running the tests</h4>

<p>You can then run mochitests using the following commands:</p>

<pre class="brush: bash">cd $GECKO_OBJ_DIR/_tests/testing/mochitest
python runtestsb2g.py --desktop --console-level INFO --profile /path/to/gaia/profile --app /path/to/b2g</pre>

<p>The test runner will launch your b2g desktop build and run the tests: all B2G mochitests by default, which is very time consuming. Other common options are as follows:</p>

<ul>
 <li>To run specific tests, pass in <code>--test-path</code>.</li>
 <li>You can optionally add <code>--total-chunks</code> and <code>--this-chunks</code> arguments as you would with regular desktop mochitest.</li>
 <li>Finally, you can use <code>python runtestsb2g.py --help</code> for a full list of supported arguments.</li>
</ul>

<h2 id="Running_mochitests_on_emulator_builds">Running mochitests on emulator builds</h2>

<p>You can run <a href="https://developer.mozilla.org/en-US/docs/Mochitest" title="https://developer.mozilla.org/en-US/docs/Mochitest">mochitest-plain</a> on B2G device builds. Currently, these work best when run on an emulator.</p>

<div class="warning notecard">
<p>You cannot run mochitest on a B2G device where Gaia was built with PRODUCTION=1.  Running mochitests requires an engineering build.  See <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1037858">Bug 1037858</a>.</p>
</div>

<h3 id="Using_mach_2">Using mach</h3>

<p>If you have a local emulator build that is made against a trunk Gecko branch (not mozilla-b2g18), the easiest way to run mochitests on it is with <a href="/en-US/docs/Developer_Guide/mach" title="/en-US/docs/Developer_Guide/mach">mach</a>. To run all of the tests, do the following:</p>

<pre class="brush: bash">cd $B2G_DIR
./mach mochitest
</pre>

<p>To run a specific test, use this:</p>

<pre class="brush: bash">./mach mochitest test_path</pre>

<div class="note notecard">
<p><strong>Note</strong>: Test paths are relative to gecko&apos;s source directory, e.g. <code>content/base/test/test_CrossSiteXHR.html</code></p>
</div>

<p>To see mochitest options, you can use this:</p>

<pre class="brush: bash">./mach mochitest --help</pre>

<p>B2G emulator and device builds support the same options and are run in the same way as desktop mochitests. See the <a href="/en-US/docs/Mochitest#Running_tests">Firefox mochitest documentation</a> for more information on running tests.</p>

<div class="note notecard">
<p><strong>Note</strong>: Before April 9th 2015, there was a separate command for b2g emulator builds: <code>mochitest-remote,</code> but new builds always use the <code>mochitest</code> command, and the system works out what type of build you have and deals with it accordingly.</p>
</div>

<h3 id="Using_the_mochitest_runner_2">Using the mochitest runner</h3>

<p>Similar to before, you can also run mochitest on device or emulator builds of B2G using the mochitest runner. The prerequisites are a little more complex.</p>

<h4 id="Pre-requisites">Pre-requisites</h4>

<ul>
 <li>You need to build B2G for the target you&apos;re testing (see <a href="/en-US/docs/Mozilla/Boot_to_Gecko/Building_and_installing_Boot_to_Gecko">Building and installing Boot to Gecko</a>).</li>
 <li>You cannot use a Gaia build that was made with a custom <code>GAIA_DOMAIN</code>.</li>
 <li>You need to have a <strong>desktop</strong> version of xpcshell (it needs to run on the host); you will have this already if you have a copy of Firefox on your system.</li>
 <li>You need to install some Python packages that are needed, either in a virtualenv or otherwise. Read on for more details.</li>
</ul>

<h4 id="Setup_for_trunk_trees_including_mozilla-central_2">Setup for trunk trees, including mozilla-central</h4>

<pre class="brush: bash">cd $GECKO_OBJ_DIR
source _virtualenv/bin/activate
</pre>

<h4 id="Running_the_tests_2">Running the tests</h4>

<div class="warning notecard">
<p>Warning: Running mochitests on a B2G device is not officially supported. Because there is no continuous integration it is prone to breaking, so don&apos;t expect it to work out of the box.</p>
</div>

<p>You can then run mochitest-plain using one of the following sets of terminal commands.</p>

<p>To run tests on a device, both the device and the host computer must be on the same wireless network because the device will request files from an HTTP server that&apos;s started by mochitest on the host computer. To start the tests, use the following:</p>

<pre class="brush: bash">adb forward tcp:2828 tcp:2828
cd $GECKO_OBJ_DIR/_tests/testing/mochitest
python runtestsb2g.py --b2gpath $B2G_HOME --xre-path /path/to/dir/containing/desktop/xpcshell --console-level INFO \
  --httpd-path ./</pre>

<p>If you&apos;re using an emulator, use the following:</p>

<pre class="brush: bash">cd $GECKO_OBJ_DIR/_tests/testing/mochitest
python runtestsb2g.py --b2gpath $B2G_HOME --xre-path /path/to/dir/containing/desktop/xpcshell --console-level INFO \
  --httpd-path ./ --emulator arm</pre>

<div class="warning notecard">
<p><strong>Warning</strong>: Running mochitests on a B2G emulator on OS X is currently not supported; use Linux instead.</p>
</div>

<p>The above commands will run all B2G mochitests by default, which is very time consuming. Other common options are as follows:</p>

<ul>
 <li>To run specific tests, pass in <code>--test-path</code>.</li>
 <li>You can optionally add <code>--total-chunks</code> and <code>--this-chunks</code> arguments as you would with regular desktop mochitest.</li>
 <li>You can add <code>--chrome</code> to run mochitest chrome tests instead of mochitest-plain. See <a href="/en-US/docs/Chrome_tests">Chrome tests</a> for more information on those.</li>
 <li>Finally, you can use <code>python runtestsb2g.py --help</code> for a full list of supported arguments.</li>
</ul>

<p>After you invoke <code>runtestsb2g.py</code>, the test runner will launch the emulator for you (if you&apos;re running the tests on an emulator) or reboot your device (if you&apos;re running the tests on a device), and start running the tests. Because the emulator is slow, and it is necessary to push a test profile to the emulator and restart B2G, the tests can take a few minutes to start. Before they start, you will just see a black or white screen. After they start, you should see the test log being dumped to the console.</p>

<p>When the tests are done, the emulator is shut down for you, or if you&apos;re using a device, the device is rebooted.</p>

<p></p><div class="note notecard"><strong>Note:</strong> There is a current <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=780034" title="Mochitest doesn&apos;t have the ability to stop b2g">bug 780034</a> which prevents mochitest from terminating cleanly if you just run a single test, as opposed to a set of tests. In this case, when you notice the test has ended, you can press CTRL+C to terminate the testrunner.</div><p></p>

<h2 id="Running_mochitest_with_a_downloaded_emulator">Running mochitest with a downloaded emulator</h2>

<p>If you&apos;ve built B2G for another config (like otoro) and want to run the tests on an emulator, you can do so without building an emulator yourself. Just download the <a href="https://pvtbuilds.mozilla.org/pub/mozilla.org/b2g/tinderbox-builds/mozilla-central-generic/" title="https://pvtbuilds.mozilla.org/pub/mozilla.org/b2g/tinderbox-builds/mozilla-central-generic/">latest trunk arm emulator</a>, and use the same instructions as above, replacing the <code>--b2gpath $B2G_HOME</code> argument for <code>runtestsb2g.py</code> with <code>--b2gpath /path/to/unpacked/emulator</code>.</p>

<h2 id="Running_mochitest_with_a_downloaded_emulator_and_downloaded_tests">Running mochitest with a downloaded emulator and downloaded tests</h2>

<p>You can also run mochitests on an emulator without building or cloning anything. To do this, you need to download the <a href="https://pvtbuilds.mozilla.org/pub/mozilla.org/b2g/tinderbox-builds/mozilla-central-generic/" title="https://pvtbuilds.mozilla.org/pub/mozilla.org/b2g/tinderbox-builds/mozilla-central-generic/">latest trunk arm emulator</a> and unpack it, and download the latest <code>tests.zip</code> file (from the same place as the emulator) and unpack it. </p>

<p>You&apos;ll also need <a href="/en-US/docs/Python/Virtualenv" title="/en-US/docs/Python/Virtualenv">virtualenv </a>installed on your system.</p>

<p>Then you can set up your environment and run the tests:</p>

<pre class="brush: bash">virtualenv venv
source venv/bin/activate
cd $TESTS_DIR/marionette
python setup.py develop
cd $TESTS_DIR/mochitests
python runtestsb2g.py --b2gpath /path/to/extracted/emulator --xre-path /path/to/desktop/xpcshell --console-level INFO \
  --httpd-path ./ --emulator arm
</pre>

<h2 id="Technical_Implementation_Details">Technical Implementation Details</h2>

<p>There are a few things that happen when you run B2G mochitests.</p>

<ol>
 <li>The homescreen system app is replaced by a special certified app called test-container (note this is checked in to gaia). In theory this test-container is meant to be generic such that any test harness can use it, but so far only mochitests do.</li>
 <li>The test-container app exposes a single <a href="http://mxr.mozilla.org/gaia/source/test_apps/test-container/index.html?force=1" title="http://mxr.mozilla.org/gaia/source/test_apps/test-container/manifest.webapp">&lt;iframe mozbrowser mozapp&gt;</a> in which the mochitests are loaded (mochitests have their own <a href="http://mxr.mozilla.org/mozilla-central/source/testing/mochitest/manifest.webapp" title="http://mxr.mozilla.org/gaia/source/test_apps/test-container/index.html?force=1">manifest.webapp</a>).</li>
 <li>The automation replaces the homescreen app with the test-container app <a href="http://hg.mozilla.org/mozilla-central/file/947b9aa5e2d3/testing/profiles/prefs_b2g_unittest.js#l3" title="http://mxr.mozilla.org/mozilla-central/source/testing/profiles/prefs_b2g_unittest.js#3">using a pref</a>.</li>
 <li>The automation <a href="http://hg.mozilla.org/mozilla-central/file/1f65b5204c8b/testing/mochitest/runtestsb2g.py#l88" title="http://mxr.mozilla.org/mozilla-central/source/testing/mochitest/runtestsb2g.py#88">loads the mochitest app</a> into the iframe the test-container app exposes (this script is executed with chrome privileges by marionette).</li>
 <li>The automation <a href="http://hg.mozilla.org/mozilla-central/file/1f65b5204c8b/testing/mochitest/runtestsb2g.py#l56" title="http://hg.mozilla.org/mozilla-central/file/1f65b5204c8b/testing/mochitest/runtestsb2g.py#l56">loads special powers into the child frame</a> that is now running mochitests and sets up the message manager (this lets mochitests access some privileged apis).</li>
 <li>The automation <a href="http://hg.mozilla.org/mozilla-central/file/1f65b5204c8b/testing/mochitest/runtestsb2g.py#l92" title="http://hg.mozilla.org/mozilla-central/file/1f65b5204c8b/testing/mochitest/runtestsb2g.py#l92">loads the mochitest url</a> into the mochitest app&apos;s iframe. This kicks off the tests.</li>
</ol>

<div class="note notecard">
<p><strong>Note</strong>: If you&apos;re interested in why things work this way, the short answer is to satisfy permissions testing requirements. For a more detailed answer see <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=798580" title="FIXED: b2g mochitest chromeEvent handling is broken">bug 798580</a> and <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=814140" title="FIXED: Expose test-container app&apos;s permissions to mochitests which are running on a separate domain">bug 814140</a>.</p>
</div>

<p> </p>
