<p></p><section class="Quick_links" id="Quick_Links">

<ol>
 <li data-default-state="closed"><a href="/en-US/docs/Mozilla/B2G_OS/Building_and_installing_B2G_OS">Build and install</a>
  <ol>
   <li><strong><a href="/en-US/docs/Mozilla/B2G_OS/Building_and_installing_B2G_OS">Build and install overview</a></strong></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Building_and_installing_B2G_OS/B2G_OS_build_process_summary">B2G OS build process summary</a></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/B2G_OS_build_prerequisites">Build prerequisites</a></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Preparing_for_your_first_B2G_build">Preparing for your first build</a></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Building">Building B2G OS</a></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Building_and_installing_B2G_OS/B2G_installer_add-on">B2G installer add-on</a></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Building_and_installing_B2G_OS/Building_for_Flame_on_OS_X">Building B2G OS for Flame on Mac OS X</a></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Choosing_how_to_run_Gaia_or_B2G">Choosing how to run Gaia or B2G OS</a></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Building_and_installing_B2G_OS/Compatible_Devices">Compatible Devices</a></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Installing_on_a_mobile_device">Installing B2G OS on a mobile device</a></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Building_and_installing_B2G_OS/B2G_OS_update_packages">Creating and applying B2G OS update packages</a></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Building/FOTA_community_builds">Building and installing FOTA community builds</a></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Building_and_installing_B2G_OS/B2G_Build_Variables_Reference_Sheet">B2G build variables reference sheet</a></li>
  </ol>
 </li>
 <li data-default-state="closed"><a href="/en-US/docs/Mozilla/B2G_OS/Porting_B2G_OS">Porting B2G OS</a>
  <ol>
   <li><strong><a href="/en-US/docs/Mozilla/B2G_OS/Porting_B2G_OS">Porting overview</a></strong></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Porting_B2G_OS/basics">Porting basics</a></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Porting_B2G_OS/Porting_on_CyanogenMod">Porting on CyanogenMod</a></li>
  </ol>
 </li>
 <li data-default-state="closed"><a href="/en-US/docs/Mozilla/B2G_OS/Developing_Gaia">Developing Gaia</a>
  <ol>
   <li><strong><a href="/en-US/docs/Mozilla/B2G_OS/Developing_Gaia">Developing Gaia overview</a></strong></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Developing_Gaia/Running_the_Gaia_codebase">Running the Gaia codebase</a></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Mulet">Run Gaia on desktop using Mulet</a></li>

   <li><a href="/en-US/docs/Mozilla/B2G_OS/Developing_Gaia/Understanding_the_Gaia_codebase">Understanding the Gaia codebase</a></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Developing_Gaia/Making_Gaia_code_changes">Making Gaia code changes</a></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Developing_Gaia/Testing_Gaia_code_changes">Testing Gaia code changes</a></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Developing_Gaia/Submitting_a_Gaia_patch">Submitting a Gaia patch</a></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Developing_Gaia/Build_System_Primer">Gaia build system primer</a></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Developing_Gaia/Different_ways_to_run_Gaia">Different ways to run Gaia</a></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Developing_Gaia/make_options_reference">Make options reference</a></li>
   <li><a href="/en-US/docs/Mozilla/B2G_OS/Developing_Gaia/Gaia_tools_reference">Gaia tools reference</a></li>
  </ol>
 </li>
 <li><a href="/en-US/docs/Mozilla/B2G_OS/API">B2G OS APIs</a></li>
</ol>
</section><p></p><div class="summary">
<p><span class="seoSummary">This article provides information about running performance tests on Gaia, as well as how to create new tests.</span></p>
</div>

<div class="warning">
<p><strong>NOTE:</strong> Usage of <code>test-perf</code> and Datazilla has been deprecated. For updated resources on performance testing within Gaia, please refer to <a href="/en-US/Firefox_OS/Automated_testing/Raptor">Raptor</a>.</p>
</div>

<h2 id="Running_the_tests">Running the tests</h2>

<p>The tests are run on a regular basis on <a href="https://datazilla.mozilla.org/b2g/" title="https://datazilla.mozilla.org/b2g/">Datazilla</a>; however, you can also run them yourself. To do so, you'll need an engineer build with <a href="/en-US/docs/Marionette" title="/en-US/docs/Marionette">Marionette</a> enabled and remote debugging <strong>disabled</strong>. See <a href="/en-US/docs/Mozilla/Firefox_OS/Platform/Gaia/Build_System_Primer#Customizing_the_preferences" title="/en-US/docs/Mozilla/Firefox_OS/Platform/Gaia/Build_System_Primer#Customizing_the_preferences">Gaia Build System Primer, Customizing the preferences</a> for more information on how doing this.</p>

<h3 id="Test_Requirements">Test Requirements</h3>

<p>Since <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=915156" title="FIXED: Port the performance testing framework to the new marionette runner">bug 915156</a> landed on December 6th 2013, <code>make test-perf</code> requires Node.js on the host to run the tests. The relevant modules should be installed automatically with <code>npm</code>.</p>

<p>Prior to running the tests, you need to configure a runner host. The runner host is a module that will either run the tests in <a href="/en-US/Firefox_OS/Using_the_B2G_desktop_client">B2G desktop</a> or on a device (real or virtual — like an <a href="/en-US/Firefox_OS/Using_the_B2G_emulators">emulator</a>). By default it runs in B2G Desktop, which is not very relevant for performance. To configure the runner just edit the file <code>local.mk</code> in the Gaia top level directory (create it if it doesn't already exist) and put the following line:</p>

<pre class="brush: bash">MARIONETTE_RUNNER_HOST=marionette-device-host</pre>

<p>This will use the device host runner. The default value is <code>marionette-b2gdesktop-host</code>.</p>

<p>The alternative to this is to do:</p>

<pre class="brush: bash">MARIONETTE_RUNNER_HOST=marionette-device-host make test-perf </pre>

<div class="note">
<p><strong>Note:</strong> If you have more than one device connected, you need to set the environment variable <code>ANDROID_SERIAL</code>. See <code>adb devices</code> to know what value to use. Make sure you have an <a href="/en-US/Firefox_OS/Platform/Gaia/Hacking">up-to-date Gaia version running on it</a>.</p>
</div>

<h3 id="Output">Output</h3>

<p>By default the test output the data in JSON format. By default it is output to <code>stdout</code> and might be mixed with error message from other commands like <code>npm</code>. This is not a very good idea for automation. So you can redirect this JSON output to a file. Just define <code>MOZPERFOUT</code> for the host runner, either on the command line as an option or in the <code>local.mk</code> file as shown above.</p>

<pre class="brush: bash">MOZPERFOUT=myfile.json</pre>

<p>There is a "spec" reporter that allow reporting the output in a more human readable format. To use it, set the environment as follow:</p>

<pre class="brush: bash">REPORTER=ConsoleMozPerf</pre>

<p>This will make the test output something easier to read. Not easier to parse. There is no real syntax.</p>

<p>For now, any other value will use the JSON reporter.</p>

<div class="note">
<p><strong>Note:</strong> <code>MOZPERFOUT</code> will be honoured whichever reporter you select.</p>
</div>

<h3 id="Running_all_tests">Running all tests</h3>

<p>In general you can run these tests on 1.4 and upwards from Gaia master. 1.3 might no longer be able to handle the test runs. There is an exception for 1.3t (Tarako). since <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1006064" title="FIXED: Port make test-perf to 1.3T">bug 1006064</a> landed, if you want to run the tests against Tarako (1.3t), you should run it from the Gaia 1.3t. From 2.0 and onwards, we consider that you should run the test from the same Gaia tree.</p>

<p>To run all the tests, use the following command:</p>

<pre class="brush: bash">make test-perf</pre>

<div class="note">
<p><strong>Note</strong>: Since early August 2014 (currently only on master) the b2g process is restarted after each test, not after each test run, to improve the reliability of the tests (see <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1027232" title="FIXED: We should restart b2g before each app tests">bug 1027232</a>). If you want to disable this, set the <code>RESTART_B2G</code> environment variable to "0" when running the tests.</p>
</div>

<h3 id="Running_tests_for_a_specific_app">Running tests for a specific app</h3>

<p>This is done by naming the app you want to run the tests for,  in the <code>APP</code> variable, for example:</p>

<pre class="brush: bash">APP=browser make test-perf</pre>

<h3 id="Running_tests_for_a_set_of_apps">Running tests for a set of apps</h3>

<p>You can also specify a set of apps, inside the <code>APPS</code> variable, to run the tests against a specific set:</p>

<pre class="brush: bash">APPS="browser communications/contacts" make test-perf</pre>

<h3 id="Setting_the_number_of_runs">Setting the number of runs</h3>

<p>By default, each test is run five times. You can change that by setting the value of <code>RUNS</code> before running the tests. For example, to run each test three times you'd use this option:</p>

<pre class="brush: bash">RUNS=3 make test-perf</pre>

<h3 id="Known_issues">Known issues</h3>

<p>When running test on Buri/Hamachi (Alcatel one touch fire), you get:</p>

<pre>Not enough fields given the number of keys.</pre>

<p>You can safely ignore the warning. It is just that <code>b2g-info</code> on the device is too old as it comes from 1.2 and we only change Gecko and Gaia on these.</p>

<h2 id="Writing_new_tests">Writing new tests</h2>

<p>With the details of running the test suite out the way, let's now look at how you can write your own performance tests for Gaia.</p>

<h3 id="Startup_event_tests">Startup event tests</h3>

<p>We have setup a standard for app startup events. If you want to test the app startup, please follow the <a href="https://developer.mozilla.org/en-US/Apps/Build/Performance/Firefox_OS_app_responsiveness_guidelines">responsiveness guidelines</a>. The <code>startup_event_test.js</code> test will drive it. Make sure to whitelist your app in <code>/tests/performance/config.json</code>, by adding it to the list specified by <code>mozLaunch</code>.</p>

<div class="note">
<p><strong>Note:</strong> This is only implemented in v2.0 and later. If your code uses <code>startup-path-done</code> events then it is using the deprecated style and should be updated.</p>
</div>

<p>If you want to measure intermediate launch stages that are not part of the reponsiveness standard, you can dispatch these using the method described below. Dispatching performance events is all you need, they will be collected automatically.</p>

<h3 id="Other_event_based_tests">Other event based tests</h3>

<p>Now if you want to test specific features in your app you can do so by sending events. The test will be in two part. The instrumentation part that lives in the app itself, and the control part that will use marionette to control the app to perform actions.</p>

<h4 id="Instrumentation">Instrumentation</h4>

<p>To record the events, all you have to do is dispatch them.</p>

<p>First, include our helper in your app:</p>

<pre class="brush: html">&lt;script src="/shared/js/performance_testing_helper.js"&gt;&lt;/script&gt;
</pre>

<div class="note">
<p><strong>Note</strong>: The use of module loaders like RequireJS or Alameda, are perfectly acceptable provided it is loaded before any performance events are triggered.</p>
</div>

<p>You need to be cautious and make sure you adjust the <a href="/en-US/Firefox_OS/Platform/Automated_testing/Gaia_unit_tests">unit tests</a> so that the <code>PerformaceTestingHelper</code> is either loaded or shimmed. A simple shim is to put this in the unit test source file:</p>

<pre class="brush: js">var PerformanceTestingHelper = {
  dispatch: function() { }
};
</pre>

<p>The Travis CI jobs we run out of Github will error if you don't do that properly.</p>

<p>Having done that, you can use the helper to dispatch events when it seems appropriate to do so. First you should dispatch a start event. It is important as the '<code>start</code>' event is sent when we register the listeners, so for your feature you likely want to do this much later. So choose where the feature start and add the proper event dispatch.</p>

<pre class="brush: js">PerformanceTestingHelper.dispatch('my-feature-start');
</pre>

<p>When you're ready to stop collecting data and to report the numbers, you need to send the <code>my-feature-done</code> event, also called the last event, to tell the helper to finish:</p>

<pre class="brush: js">PerformanceTestingHelper.dispatch('my-feature-done');</pre>

<p>Also you might want to send intermediate events as appropriate.</p>

<div class="note">
<p><strong>Note:</strong> Here we use "my-feature-" as a prefix for the performance event. This is just an example. Please use an obvious name and try to use it consistently.</p>
</div>

<h4 id="Controlling_the_app">Controlling the app</h4>

<p>The second part is writing JavaScript to the test framework to perform the test. The filename must end with <code>_test.js</code> and live in <code>apps/&lt;myapp&gt;/test/performance/</code>.</p>

<p>It is a lot like a marionette integration test (based on mocha), but with a few twists: in the <code>setup()</code> function you must inject the helper atom that is being used to collect the performance events.</p>

<pre class="brush: js">PerformanceHelper.injectHelperAtom(client);</pre>

<p>You must pass a <code>lastEvent</code> parameter to the <code>PerformanceHelper</code> constructor. This will be the last event on which to wait to test your feature.</p>

<p>When calling <code>performanceHelper.reportRunDurations()</code> toward the end you must pass the name of the start event you dispatched, otherwise the measurement will be from the start, ie when we inject the helper atom. An easy to figure out the error is if you see the start event in the results. And in that case you'll the the startup events as well as these will be dispatched too.</p>

<div class="note">
<p><strong>Note:</strong> You should study existing tests to get a become more familiar with the process.</p>
</div>

<h3 id="Collecting_memory_statistics">Collecting memory statistics</h3>

<p>You can collect the memory usage for both the b2g process and the current app. Just do</p>

<pre class="brush: js">var memUsage = performanceHelper.getMemoryUsage(app);</pre>

<p><code>app</code> is the application object. <code>memusage</code> will contain several objects enumerating the memory statistics.</p>

<h2 id="Running_tests_from_a_non-engineering_device">Running tests from a non-engineering device</h2>

<p>If you don't have an engineering build on your phone you'll have to do some additional steps:</p>

<ol>
 <li>Clone B2G, and build with <code>./config.sh DEVICE-NAME</code> (e.g. <code>./config.sh keon</code>)</li>
 <li>Build the Gecko part via <code>./build.sh gecko</code></li>
 <li>Connect the phone and flash gecko via <code>./flash.sh gecko</code></li>
 <li>Clone Gaia, and create a file <code>build/custom-prefs.js</code> with content <code>user_pref("marionette.defaultPrefs.enabled", true);</code></li>
 <li>Enable <a href="/en-US/Firefox_OS/Debugging/Developer_settings#Remote_debugging">Remote Debugging</a> on the phone and run <code>make reset-gaia</code> to reset the phone (or <code>make install-gaia</code> if you trust yourself)</li>
 <li>Disable Remote Debugging and verify that everything is OK by running <code>adb devices</code>. The device should show up.</li>
 <li>Now running a perf test should work. Verify via <code>RUNS=1 APP=browser make test-perf</code></li>
</ol>

<h2 id="Filing_bugs">Filing bugs</h2>

<p>Please <a href="https://bugzilla.mozilla.org/enter_bug.cgi?product=Firefox%20OS">file bugs in Bugzilla</a>, product "Firefox OS", component "Gaia::PerformanceTest".</p>

<h2 id="See_also">See also</h2>

<ul>
 <li><a href="/en-US/docs/Marionette" title="/en-US/docs/Marionette">Marionette</a></li>
 <li><a href="/en-US/docs/Mozilla/Firefox_OS/Platform/Testing" title="/en-US/docs/Mozilla/Firefox_OS/Platform/Testing">Testing Firefox OS</a></li>
</ul>